import { useState, useRef, useMemo, useEffect, useCallback } from "react";

// ===== i18n =====
const L = {
  jp: {
    title: "ज्योतिष — Jyotish",
    birth: "出生図",
    varsha: "ヴァルシャ",
    transit: "トランジット",
    muhurta: "ムフールタ",
    chart: "チャート",
    dasha: "ダシャー",
    yoga: "ヨーガ",
    bala: "バラ",
    south: "南インド式",
    north: "北インド式",
    name: "名前",
    dob: "生年月日",
    tob: "出生時刻（秒まで）",
    place: "出生地",
    lat: "緯度",
    lon: "経度",
    tz: "タイムゾーン",
    apply: "チャートに反映",
    open: "開く",
    save: "保存",
    newChart: "新規作成",
    data: "出生データ入力",
    planets: "惑星一覧",
    tapHint: "タップ → ラグナ切替",
    reset: "リセット",
    viewing: "ラグナ表示中",
    varga: "分割図",
    special: "特殊",
    retro: "逆行",
    asp: "Asp",
    karaka: "カーラカ",
    ben: "吉",
    mal: "凶",
    yogaK: "ヨガK",
    mrityu: "ムリチュ",
    gandanta: "ガンダーンタ",
    placePh: "都市名を入力",
    level4: "第4レベルまで展開可",
    todo: "実装予定",
    now: "NOW",
    lang: "EN",
    notes: "メモ・ノート",
    notesPh: "チャートに関するメモを入力…",
    yogaFound: "検出されたヨーガ",
    positive: "吉兆",
    negative: "凶兆",
    neutral: "中性",
    exchange: "交換",
    raja: "ラージャ",
    dhana: "ダナ",
  },
  en: {
    title: "ज्योतिष — Jyotish",
    birth: "Birth",
    varsha: "Varsha",
    transit: "Transit",
    muhurta: "Muhurta",
    chart: "Chart",
    dasha: "Dasha",
    yoga: "Yoga",
    bala: "Bala",
    south: "South Indian",
    north: "North Indian",
    name: "Name",
    dob: "Date of Birth",
    tob: "Time (HH:MM:SS)",
    place: "Birthplace",
    lat: "Latitude",
    lon: "Longitude",
    tz: "Timezone",
    apply: "Apply to Chart",
    open: "Open",
    save: "Save",
    newChart: "New",
    data: "Birth Data Input",
    planets: "Planet List",
    tapHint: "Tap sign → change lagna",
    reset: "Reset",
    viewing: "lagna view",
    varga: "Varga",
    special: "Special",
    retro: "Retro",
    asp: "Asp",
    karaka: "Karaka",
    ben: "B",
    mal: "M",
    yogaK: "YK",
    mrityu: "Mrityu",
    gandanta: "Gandanta",
    placePh: "Type city name",
    level4: "Expand to 4th level",
    todo: "Coming soon",
    now: "NOW",
    lang: "JP",
    notes: "Notes",
    notesPh: "Enter notes about this chart…",
    yogaFound: "Yogas Detected",
    positive: "Positive",
    negative: "Negative",
    neutral: "Neutral",
    exchange: "Exchange",
    raja: "Raja",
    dhana: "Dhana",
  },
};

// ===== CITY DB (worldwide) =====
const CDB = [
  // Japan - 47 prefectural capitals (県庁所在地)
  { n: "札幌", e: "Sapporo", c: "JP", la: 43.0621, lo: 141.3544 },
  { n: "青森", e: "Aomori", c: "JP", la: 40.8244, lo: 140.74 },
  { n: "盛岡", e: "Morioka", c: "JP", la: 39.7036, lo: 141.1527 },
  { n: "仙台", e: "Sendai", c: "JP", la: 38.2682, lo: 140.8694 },
  { n: "秋田", e: "Akita", c: "JP", la: 39.72, lo: 140.1025 },
  { n: "山形", e: "Yamagata", c: "JP", la: 38.2405, lo: 140.3634 },
  { n: "福島", e: "Fukushima", c: "JP", la: 37.7503, lo: 140.4676 },
  { n: "水戸", e: "Mito", c: "JP", la: 36.3418, lo: 140.4468 },
  { n: "宇都宮", e: "Utsunomiya", c: "JP", la: 36.5551, lo: 139.8836 },
  { n: "前橋", e: "Maebashi", c: "JP", la: 36.3911, lo: 139.0608 },
  { n: "さいたま", e: "Saitama", c: "JP", la: 35.8617, lo: 139.6455 },
  { n: "千葉", e: "Chiba", c: "JP", la: 35.6074, lo: 140.1065 },
  { n: "東京", e: "Tokyo", c: "JP", la: 35.6762, lo: 139.6503 },
  { n: "横浜", e: "Yokohama", c: "JP", la: 35.4437, lo: 139.638 },
  { n: "新潟", e: "Niigata", c: "JP", la: 37.9026, lo: 139.0236 },
  { n: "富山", e: "Toyama", c: "JP", la: 36.6953, lo: 137.2114 },
  { n: "金沢", e: "Kanazawa", c: "JP", la: 36.5613, lo: 136.6562 },
  { n: "福井", e: "Fukui", c: "JP", la: 36.0652, lo: 136.2216 },
  { n: "甲府", e: "Kofu", c: "JP", la: 35.6642, lo: 138.5684 },
  { n: "長野", e: "Nagano", c: "JP", la: 36.6513, lo: 138.181 },
  { n: "岐阜", e: "Gifu", c: "JP", la: 35.3912, lo: 136.7223 },
  { n: "静岡", e: "Shizuoka", c: "JP", la: 34.9769, lo: 138.3831 },
  { n: "名古屋", e: "Nagoya", c: "JP", la: 35.1815, lo: 136.9066 },
  { n: "津", e: "Tsu", c: "JP", la: 34.7303, lo: 136.5086 },
  { n: "大津", e: "Otsu", c: "JP", la: 35.0045, lo: 135.8686 },
  { n: "京都", e: "Kyoto", c: "JP", la: 35.0116, lo: 135.7681 },
  { n: "大阪", e: "Osaka", c: "JP", la: 34.6937, lo: 135.5023 },
  { n: "神戸", e: "Kobe", c: "JP", la: 34.6901, lo: 135.1956 },
  { n: "奈良", e: "Nara", c: "JP", la: 34.6851, lo: 135.8049 },
  { n: "和歌山", e: "Wakayama", c: "JP", la: 34.226, lo: 135.1675 },
  { n: "鳥取", e: "Tottori", c: "JP", la: 35.5039, lo: 134.2383 },
  { n: "松江", e: "Matsue", c: "JP", la: 35.4723, lo: 133.0505 },
  { n: "岡山", e: "Okayama", c: "JP", la: 34.6617, lo: 133.935 },
  { n: "広島", e: "Hiroshima", c: "JP", la: 34.3853, lo: 132.4553 },
  { n: "山口", e: "Yamaguchi", c: "JP", la: 34.1861, lo: 131.4706 },
  { n: "徳島", e: "Tokushima", c: "JP", la: 34.0658, lo: 134.5593 },
  { n: "高松", e: "Takamatsu", c: "JP", la: 34.3401, lo: 134.0434 },
  { n: "松山", e: "Matsuyama", c: "JP", la: 33.8416, lo: 132.7657 },
  { n: "高知", e: "Kochi", c: "JP", la: 33.5597, lo: 133.5311 },
  { n: "福岡", e: "Fukuoka", c: "JP", la: 33.5904, lo: 130.4017 },
  { n: "佐賀", e: "Saga", c: "JP", la: 33.2494, lo: 130.2988 },
  { n: "長崎", e: "Nagasaki", c: "JP", la: 32.7503, lo: 129.8779 },
  { n: "熊本", e: "Kumamoto", c: "JP", la: 32.7898, lo: 130.7417 },
  { n: "大分", e: "Oita", c: "JP", la: 33.2382, lo: 131.6126 },
  { n: "宮崎", e: "Miyazaki", c: "JP", la: 31.9111, lo: 131.4239 },
  { n: "鹿児島", e: "Kagoshima", c: "JP", la: 31.5602, lo: 130.5581 },
  { n: "那覇", e: "Naha", c: "JP", la: 26.3344, lo: 127.6809 },
  // Japan - Tokyo wards (23区)
  { n: "渋谷区", e: "Shibuya", c: "JP", la: 35.664, lo: 139.6982 },
  { n: "新宿区", e: "Shinjuku", c: "JP", la: 35.6938, lo: 139.7035 },
  { n: "港区", e: "Minato", c: "JP", la: 35.6581, lo: 139.7514 },
  { n: "千代田区", e: "Chiyoda", c: "JP", la: 35.694, lo: 139.7536 },
  { n: "品川区", e: "Shinagawa", c: "JP", la: 35.6092, lo: 139.7302 },
  { n: "目黒区", e: "Meguro", c: "JP", la: 35.6414, lo: 139.6982 },
  { n: "世田谷区", e: "Setagaya", c: "JP", la: 35.6461, lo: 139.6532 },
  { n: "大田区", e: "Ota", c: "JP", la: 35.5613, lo: 139.716 },
  { n: "杉並区", e: "Suginami", c: "JP", la: 35.6994, lo: 139.6364 },
  { n: "豊島区", e: "Toshima", c: "JP", la: 35.7263, lo: 139.7169 },
  { n: "中野区", e: "Nakano", c: "JP", la: 35.7078, lo: 139.6637 },
  { n: "練馬区", e: "Nerima", c: "JP", la: 35.7356, lo: 139.6517 },
  { n: "板橋区", e: "Itabashi", c: "JP", la: 35.7512, lo: 139.709 },
  { n: "台東区", e: "Taito", c: "JP", la: 35.7126, lo: 139.78 },
  { n: "墨田区", e: "Sumida", c: "JP", la: 35.7107, lo: 139.8014 },
  { n: "江東区", e: "Koto", c: "JP", la: 35.6727, lo: 139.8172 },
  { n: "足立区", e: "Adachi", c: "JP", la: 35.7753, lo: 139.8048 },
  { n: "文京区", e: "Bunkyo", c: "JP", la: 35.7081, lo: 139.7522 },
  { n: "荒川区", e: "Arakawa", c: "JP", la: 35.736, lo: 139.7834 },
  { n: "中央区", e: "Chuo", c: "JP", la: 35.6707, lo: 139.7718 },
  { n: "北区", e: "Kita", c: "JP", la: 35.7528, lo: 139.7377 },
  { n: "葛飾区", e: "Katsushika", c: "JP", la: 35.7436, lo: 139.8474 },
  { n: "江戸川区", e: "Edogawa", c: "JP", la: 35.7068, lo: 139.8682 },
  // Japan - other major cities
  { n: "八王子", e: "Hachioji", c: "JP", la: 35.6664, lo: 139.316 },
  { n: "立川", e: "Tachikawa", c: "JP", la: 35.694, lo: 139.4179 },
  { n: "武蔵野", e: "Musashino", c: "JP", la: 35.7177, lo: 139.5664 },
  { n: "町田", e: "Machida", c: "JP", la: 35.5483, lo: 139.4466 },
  { n: "川崎", e: "Kawasaki", c: "JP", la: 35.5309, lo: 139.7029 },
  { n: "相模原", e: "Sagamihara", c: "JP", la: 35.5714, lo: 139.3735 },
  { n: "堺", e: "Sakai", c: "JP", la: 34.5733, lo: 135.483 },
  { n: "浜松", e: "Hamamatsu", c: "JP", la: 34.7108, lo: 137.7261 },
  { n: "北九州", e: "Kitakyushu", c: "JP", la: 33.8834, lo: 130.8752 },
  { n: "川口", e: "Kawaguchi", c: "JP", la: 35.8078, lo: 139.7241 },
  { n: "船橋", e: "Funabashi", c: "JP", la: 35.6947, lo: 139.9828 },
  { n: "姫路", e: "Himeji", c: "JP", la: 34.8154, lo: 134.6855 },
  { n: "松本", e: "Matsumoto", c: "JP", la: 36.238, lo: 137.972 },
  { n: "旭川", e: "Asahikawa", c: "JP", la: 43.7707, lo: 142.365 },
  { n: "函館", e: "Hakodate", c: "JP", la: 41.7687, lo: 140.7288 },
  { n: "下関", e: "Shimonoseki", c: "JP", la: 33.9588, lo: 130.9413 },
  { n: "倉敷", e: "Kurashiki", c: "JP", la: 34.585, lo: 133.772 },
  { n: "高崎", e: "Takasaki", c: "JP", la: 36.3219, lo: 139.0032 },
  { n: "柏", e: "Kashiwa", c: "JP", la: 35.8681, lo: 139.9756 },
  { n: "豊田", e: "Toyota", c: "JP", la: 35.0826, lo: 137.1562 },
  { n: "久留米", e: "Kurume", c: "JP", la: 33.3191, lo: 130.5085 },
  { n: "福山", e: "Fukuyama", c: "JP", la: 34.486, lo: 133.3626 },
  { n: "那覇", e: "Naha", c: "JP", la: 26.3344, lo: 127.6809 },
  { n: "梅田", e: "Umeda", c: "JP", la: 34.7025, lo: 135.4959 },
  { n: "難波", e: "Namba", c: "JP", la: 34.6626, lo: 135.5015 },
  { n: "小倉", e: "Kokura", c: "JP", la: 33.8826, lo: 130.8756 },
  { n: "郡山", e: "Koriyama", c: "JP", la: 37.3999, lo: 140.3597 },
  { n: "いわき", e: "Iwaki", c: "JP", la: 37.0505, lo: 140.8878 },
  { n: "所沢", e: "Tokorozawa", c: "JP", la: 35.7992, lo: 139.4689 },
  { n: "越谷", e: "Koshigaya", c: "JP", la: 35.8913, lo: 139.7907 },
  { n: "藤沢", e: "Fujisawa", c: "JP", la: 35.339, lo: 139.49 },
  { n: "春日井", e: "Kasugai", c: "JP", la: 35.2477, lo: 136.9726 },
  { n: "四日市", e: "Yokkaichi", c: "JP", la: 34.965, lo: 136.6245 },
  { n: "明石", e: "Akashi", c: "JP", la: 34.6431, lo: 134.9974 },
  { n: "西宮", e: "Nishinomiya", c: "JP", la: 34.7377, lo: 135.3415 },
  { n: "尼崎", e: "Amagasaki", c: "JP", la: 34.7333, lo: 135.4064 },
  { n: "沼津", e: "Numazu", c: "JP", la: 35.0956, lo: 138.864 },
  { n: "富士", e: "Fuji", c: "JP", la: 35.1614, lo: 138.6762 },
  { n: "豊橋", e: "Toyohashi", c: "JP", la: 34.7693, lo: 137.3917 },
  { n: "周南", e: "Shunan", c: "JP", la: 34.0554, lo: 131.8062 },
  { n: "防府", e: "Hofu", c: "JP", la: 34.0516, lo: 131.5625 },
  { n: "岩国", e: "Iwakuni", c: "JP", la: 34.1659, lo: 132.2196 },
  { n: "萩", e: "Hagi", c: "JP", la: 34.408, lo: 131.399 },
  // India
  { n: "New Delhi", e: "New Delhi", c: "IN", la: 28.6139, lo: 77.209 },
  { n: "Mumbai", e: "Mumbai", c: "IN", la: 19.076, lo: 72.8777 },
  { n: "Chennai", e: "Chennai", c: "IN", la: 13.0827, lo: 80.2707 },
  { n: "Kolkata", e: "Kolkata", c: "IN", la: 22.5726, lo: 88.3639 },
  { n: "Bangalore", e: "Bangalore", c: "IN", la: 12.9716, lo: 77.5946 },
  { n: "Hyderabad", e: "Hyderabad", c: "IN", la: 17.385, lo: 78.4867 },
  { n: "Pune", e: "Pune", c: "IN", la: 18.5204, lo: 73.8567 },
  { n: "Varanasi", e: "Varanasi", c: "IN", la: 25.3176, lo: 82.9739 },
  { n: "Jaipur", e: "Jaipur", c: "IN", la: 26.9124, lo: 75.7873 },
  { n: "Ujjain", e: "Ujjain", c: "IN", la: 23.1793, lo: 75.7849 },
  { n: "Ahmedabad", e: "Ahmedabad", c: "IN", la: 23.0225, lo: 72.5714 },
  { n: "Lucknow", e: "Lucknow", c: "IN", la: 26.8467, lo: 80.9462 },
  { n: "Patna", e: "Patna", c: "IN", la: 25.6093, lo: 85.1376 },
  { n: "Bhopal", e: "Bhopal", c: "IN", la: 23.2599, lo: 77.4126 },
  {
    n: "Thiruvananthapuram",
    e: "Trivandrum",
    c: "IN",
    la: 8.5241,
    lo: 76.9366,
  },
  // USA
  {
    n: "New York",
    e: "New York",
    c: "US",
    la: 40.7128,
    lo: -74.006,
    tz: "America/New_York",
  },
  {
    n: "Los Angeles",
    e: "Los Angeles",
    c: "US",
    la: 34.0522,
    lo: -118.2437,
    tz: "America/Los_Angeles",
  },
  {
    n: "Chicago",
    e: "Chicago",
    c: "US",
    la: 41.8781,
    lo: -87.6298,
    tz: "America/Chicago",
  },
  {
    n: "Houston",
    e: "Houston",
    c: "US",
    la: 29.7604,
    lo: -95.3698,
    tz: "America/Chicago",
  },
  {
    n: "Phoenix",
    e: "Phoenix",
    c: "US",
    la: 33.4484,
    lo: -112.074,
    tz: "America/Phoenix",
  },
  {
    n: "San Francisco",
    e: "San Francisco",
    c: "US",
    la: 37.7749,
    lo: -122.4194,
    tz: "America/Los_Angeles",
  },
  {
    n: "Seattle",
    e: "Seattle",
    c: "US",
    la: 47.6062,
    lo: -122.3321,
    tz: "America/Los_Angeles",
  },
  {
    n: "Miami",
    e: "Miami",
    c: "US",
    la: 25.7617,
    lo: -80.1918,
    tz: "America/New_York",
  },
  {
    n: "Boston",
    e: "Boston",
    c: "US",
    la: 42.3601,
    lo: -71.0589,
    tz: "America/New_York",
  },
  {
    n: "Denver",
    e: "Denver",
    c: "US",
    la: 39.7392,
    lo: -104.9903,
    tz: "America/Denver",
  },
  {
    n: "Atlanta",
    e: "Atlanta",
    c: "US",
    la: 33.749,
    lo: -84.388,
    tz: "America/New_York",
  },
  {
    n: "Washington DC",
    e: "Washington DC",
    c: "US",
    la: 38.9072,
    lo: -77.0369,
    tz: "America/New_York",
  },
  {
    n: "Dallas",
    e: "Dallas",
    c: "US",
    la: 32.7767,
    lo: -96.797,
    tz: "America/Chicago",
  },
  {
    n: "San Diego",
    e: "San Diego",
    c: "US",
    la: 32.7157,
    lo: -117.1611,
    tz: "America/Los_Angeles",
  },
  {
    n: "Honolulu",
    e: "Honolulu",
    c: "US",
    la: 21.3069,
    lo: -157.8583,
    tz: "Pacific/Honolulu",
  },
  // Europe
  { n: "London", e: "London", c: "GB", la: 51.5074, lo: -0.1278 },
  { n: "Manchester", e: "Manchester", c: "GB", la: 53.4808, lo: -2.2426 },
  { n: "Edinburgh", e: "Edinburgh", c: "GB", la: 55.9533, lo: -3.1883 },
  { n: "Paris", e: "Paris", c: "FR", la: 48.8566, lo: 2.3522 },
  { n: "Lyon", e: "Lyon", c: "FR", la: 45.764, lo: 4.8357 },
  { n: "Marseille", e: "Marseille", c: "FR", la: 43.2965, lo: 5.3698 },
  { n: "Berlin", e: "Berlin", c: "DE", la: 52.52, lo: 13.405 },
  { n: "Munich", e: "Munich", c: "DE", la: 48.1351, lo: 11.582 },
  { n: "Hamburg", e: "Hamburg", c: "DE", la: 53.5511, lo: 9.9937 },
  { n: "Frankfurt", e: "Frankfurt", c: "DE", la: 50.1109, lo: 8.6821 },
  { n: "Rome", e: "Rome", c: "IT", la: 41.9028, lo: 12.4964 },
  { n: "Milan", e: "Milan", c: "IT", la: 45.4642, lo: 9.19 },
  { n: "Madrid", e: "Madrid", c: "ES", la: 40.4168, lo: -3.7038 },
  { n: "Barcelona", e: "Barcelona", c: "ES", la: 41.3874, lo: 2.1686 },
  { n: "Amsterdam", e: "Amsterdam", c: "NL", la: 52.3676, lo: 4.9041 },
  { n: "Brussels", e: "Brussels", c: "BE", la: 50.8503, lo: 4.3517 },
  { n: "Zurich", e: "Zurich", c: "CH", la: 47.3769, lo: 8.5417 },
  { n: "Vienna", e: "Vienna", c: "AT", la: 48.2082, lo: 16.3738 },
  { n: "Prague", e: "Prague", c: "CZ", la: 50.0755, lo: 14.4378 },
  { n: "Warsaw", e: "Warsaw", c: "PL", la: 52.2297, lo: 21.0122 },
  { n: "Budapest", e: "Budapest", c: "HU", la: 47.4979, lo: 19.0402 },
  { n: "Stockholm", e: "Stockholm", c: "SE", la: 59.3293, lo: 18.0686 },
  { n: "Oslo", e: "Oslo", c: "NO", la: 59.9139, lo: 10.7522 },
  { n: "Copenhagen", e: "Copenhagen", c: "DK", la: 55.6761, lo: 12.5683 },
  { n: "Helsinki", e: "Helsinki", c: "FI", la: 60.1699, lo: 24.9384 },
  { n: "Dublin", e: "Dublin", c: "IE", la: 53.3498, lo: -6.2603 },
  { n: "Lisbon", e: "Lisbon", c: "PT", la: 38.7223, lo: -9.1393 },
  { n: "Athens", e: "Athens", c: "GR", la: 37.9838, lo: 23.7275 },
  { n: "Istanbul", e: "Istanbul", c: "TR", la: 41.0082, lo: 28.9784 },
  { n: "Moscow", e: "Moscow", c: "RU", la: 55.7558, lo: 37.6173 },
  { n: "St Petersburg", e: "St Petersburg", c: "RU", la: 59.9343, lo: 30.3351 },
  // Asia
  { n: "Seoul", e: "Seoul", c: "KR", la: 37.5665, lo: 126.978 },
  { n: "Busan", e: "Busan", c: "KR", la: 35.1796, lo: 129.0756 },
  { n: "Beijing", e: "Beijing", c: "CN", la: 39.9042, lo: 116.4074 },
  { n: "Shanghai", e: "Shanghai", c: "CN", la: 31.2304, lo: 121.4737 },
  { n: "Hong Kong", e: "Hong Kong", c: "HK", la: 22.3193, lo: 114.1694 },
  { n: "Taipei", e: "Taipei", c: "TW", la: 25.033, lo: 121.5654 },
  { n: "Singapore", e: "Singapore", c: "SG", la: 1.3521, lo: 103.8198 },
  { n: "Bangkok", e: "Bangkok", c: "TH", la: 13.7563, lo: 100.5018 },
  { n: "Kuala Lumpur", e: "Kuala Lumpur", c: "MY", la: 3.139, lo: 101.6869 },
  { n: "Jakarta", e: "Jakarta", c: "ID", la: -6.2088, lo: 106.8456 },
  { n: "Manila", e: "Manila", c: "PH", la: 14.5995, lo: 120.9842 },
  { n: "Hanoi", e: "Hanoi", c: "VN", la: 21.0278, lo: 105.8342 },
  { n: "Dubai", e: "Dubai", c: "AE", la: 25.2048, lo: 55.2708 },
  { n: "Abu Dhabi", e: "Abu Dhabi", c: "AE", la: 24.4539, lo: 54.3773 },
  { n: "Riyadh", e: "Riyadh", c: "SA", la: 24.7136, lo: 46.6753 },
  { n: "Doha", e: "Doha", c: "QA", la: 25.2854, lo: 51.531 },
  { n: "Tehran", e: "Tehran", c: "IR", la: 35.6892, lo: 51.389 },
  { n: "Kathmandu", e: "Kathmandu", c: "NP", la: 27.7172, lo: 85.324 },
  { n: "Colombo", e: "Colombo", c: "LK", la: 6.9271, lo: 79.8612 },
  { n: "Dhaka", e: "Dhaka", c: "BD", la: 23.8103, lo: 90.4125 },
  { n: "Yangon", e: "Yangon", c: "MM", la: 16.8661, lo: 96.1951 },
  // Oceania
  { n: "Sydney", e: "Sydney", c: "AU", la: -33.8688, lo: 151.2093 },
  { n: "Melbourne", e: "Melbourne", c: "AU", la: -37.8136, lo: 144.9631 },
  { n: "Brisbane", e: "Brisbane", c: "AU", la: -27.4698, lo: 153.0251 },
  { n: "Perth", e: "Perth", c: "AU", la: -31.9505, lo: 115.8605 },
  { n: "Auckland", e: "Auckland", c: "NZ", la: -36.8485, lo: 174.7633 },
  { n: "Wellington", e: "Wellington", c: "NZ", la: -41.2865, lo: 174.7762 },
  // Americas
  { n: "Toronto", e: "Toronto", c: "CA", la: 43.6532, lo: -79.3832 },
  { n: "Vancouver", e: "Vancouver", c: "CA", la: 49.2827, lo: -123.1207 },
  { n: "Montreal", e: "Montreal", c: "CA", la: 45.5017, lo: -73.5673 },
  { n: "Mexico City", e: "Mexico City", c: "MX", la: 19.4326, lo: -99.1332 },
  { n: "São Paulo", e: "Sao Paulo", c: "BR", la: -23.5505, lo: -46.6333 },
  {
    n: "Rio de Janeiro",
    e: "Rio de Janeiro",
    c: "BR",
    la: -22.9068,
    lo: -43.1729,
  },
  { n: "Buenos Aires", e: "Buenos Aires", c: "AR", la: -34.6037, lo: -58.3816 },
  { n: "Lima", e: "Lima", c: "PE", la: -12.0464, lo: -77.0428 },
  { n: "Bogota", e: "Bogota", c: "CO", la: 4.711, lo: -74.0721 },
  { n: "Santiago", e: "Santiago", c: "CL", la: -33.4489, lo: -70.6693 },
  // Africa
  { n: "Cairo", e: "Cairo", c: "EG", la: 30.0444, lo: 31.2357 },
  { n: "Lagos", e: "Lagos", c: "NG", la: 6.5244, lo: 3.3792 },
  { n: "Nairobi", e: "Nairobi", c: "KE", la: -1.2921, lo: 36.8219 },
  { n: "Cape Town", e: "Cape Town", c: "ZA", la: -33.9249, lo: 18.4241 },
  { n: "Johannesburg", e: "Johannesburg", c: "ZA", la: -26.2041, lo: 28.0473 },
  { n: "Casablanca", e: "Casablanca", c: "MA", la: 33.5731, lo: -7.5898 },
];

const TZM = {
  JP: "Asia/Tokyo",
  IN: "Asia/Kolkata",
  GB: "Europe/London",
  FR: "Europe/Paris",
  DE: "Europe/Berlin",
  IT: "Europe/Rome",
  ES: "Europe/Madrid",
  NL: "Europe/Amsterdam",
  BE: "Europe/Brussels",
  CH: "Europe/Zurich",
  AT: "Europe/Vienna",
  CZ: "Europe/Prague",
  PL: "Europe/Warsaw",
  HU: "Europe/Budapest",
  SE: "Europe/Stockholm",
  NO: "Europe/Oslo",
  DK: "Europe/Copenhagen",
  FI: "Europe/Helsinki",
  IE: "Europe/Dublin",
  PT: "Europe/Lisbon",
  GR: "Europe/Athens",
  TR: "Europe/Istanbul",
  RU: "Europe/Moscow",
  KR: "Asia/Seoul",
  CN: "Asia/Shanghai",
  HK: "Asia/Hong_Kong",
  TW: "Asia/Taipei",
  SG: "Asia/Singapore",
  TH: "Asia/Bangkok",
  MY: "Asia/Kuala_Lumpur",
  ID: "Asia/Jakarta",
  PH: "Asia/Manila",
  VN: "Asia/Ho_Chi_Minh",
  AE: "Asia/Dubai",
  SA: "Asia/Riyadh",
  QA: "Asia/Qatar",
  IR: "Asia/Tehran",
  NP: "Asia/Kathmandu",
  LK: "Asia/Colombo",
  BD: "Asia/Dhaka",
  MM: "Asia/Yangon",
  AU: "Australia/Sydney",
  NZ: "Pacific/Auckland",
  CA: "America/Toronto",
  MX: "America/Mexico_City",
  BR: "America/Sao_Paulo",
  AR: "America/Argentina/Buenos_Aires",
  PE: "America/Lima",
  CO: "America/Bogota",
  CL: "America/Santiago",
  EG: "Africa/Cairo",
  NG: "Africa/Lagos",
  KE: "Africa/Nairobi",
  ZA: "Africa/Johannesburg",
  MA: "Africa/Casablanca",
};
// Timezone dropdown options (offset → IANA timezone)
const TZ_OPTS = [
  { v: "-12", l: "-12:00", z: "Etc/GMT+12" },
  { v: "-11", l: "-11:00", z: "Pacific/Pago_Pago" },
  { v: "-10", l: "-10:00 (Hawaii)", z: "Pacific/Honolulu" },
  { v: "-9.5", l: "-9:30", z: "Pacific/Marquesas" },
  { v: "-9", l: "-9:00 (Alaska)", z: "America/Anchorage" },
  { v: "-8", l: "-8:00 (PST)", z: "America/Los_Angeles" },
  { v: "-7", l: "-7:00 (MST)", z: "America/Denver" },
  { v: "-6", l: "-6:00 (CST)", z: "America/Chicago" },
  { v: "-5", l: "-5:00 (EST)", z: "America/New_York" },
  { v: "-4", l: "-4:00 (AST)", z: "America/Halifax" },
  { v: "-3.5", l: "-3:30 (Newfoundland)", z: "America/St_Johns" },
  { v: "-3", l: "-3:00 (Brazil)", z: "America/Sao_Paulo" },
  { v: "-2", l: "-2:00", z: "Atlantic/South_Georgia" },
  { v: "-1", l: "-1:00 (Azores)", z: "Atlantic/Azores" },
  { v: "0", l: "+0:00 (GMT/UTC)", z: "Europe/London" },
  { v: "1", l: "+1:00 (CET)", z: "Europe/Paris" },
  { v: "2", l: "+2:00 (EET)", z: "Europe/Athens" },
  { v: "3", l: "+3:00 (Moscow)", z: "Europe/Moscow" },
  { v: "3.5", l: "+3:30 (Iran)", z: "Asia/Tehran" },
  { v: "4", l: "+4:00 (Dubai)", z: "Asia/Dubai" },
  { v: "4.5", l: "+4:30 (Kabul)", z: "Asia/Kabul" },
  { v: "5", l: "+5:00 (Pakistan)", z: "Asia/Karachi" },
  { v: "5.5", l: "+5:30 (India)", z: "Asia/Kolkata" },
  { v: "5.75", l: "+5:45 (Nepal)", z: "Asia/Kathmandu" },
  { v: "6", l: "+6:00 (Bangladesh)", z: "Asia/Dhaka" },
  { v: "6.5", l: "+6:30 (Myanmar)", z: "Asia/Yangon" },
  { v: "7", l: "+7:00 (Bangkok)", z: "Asia/Bangkok" },
  { v: "8", l: "+8:00 (China/Singapore)", z: "Asia/Shanghai" },
  { v: "9", l: "+9:00 (Japan/Korea)", z: "Asia/Tokyo" },
  { v: "9.5", l: "+9:30 (Adelaide)", z: "Australia/Adelaide" },
  { v: "10", l: "+10:00 (Sydney)", z: "Australia/Sydney" },
  { v: "10.5", l: "+10:30", z: "Australia/Lord_Howe" },
  { v: "11", l: "+11:00", z: "Pacific/Noumea" },
  { v: "12", l: "+12:00 (NZ)", z: "Pacific/Auckland" },
  { v: "13", l: "+13:00 (Tonga)", z: "Pacific/Tongatapu" },
];
function tz2off(tz) {
  // First try exact match
  const exact = TZ_OPTS.find((t) => t.z === tz);
  if (exact) return exact.v;
  // Compute actual offset from IANA timezone
  try {
    const d = new Date("2024-06-15T12:00:00Z");
    const p = new Intl.DateTimeFormat("en", {
      timeZone: tz,
      timeZoneName: "shortOffset",
    }).formatToParts(d);
    const t = p.find((x) => x.type === "timeZoneName")?.value || "";
    const m = t.match(/GMT([+-]?\d+)(?::(\d+))?/);
    if (m) {
      const h = parseInt(m[1]),
        mn = parseInt(m[2] || 0);
      const off = h + (mn / 60) * (h < 0 ? -1 : 1);
      const sv = String(off);
      const match = TZ_OPTS.find((t) => t.v === sv);
      if (match) return match.v;
      const closest = TZ_OPTS.reduce((a, b) =>
        Math.abs(parseFloat(b.v) - off) < Math.abs(parseFloat(a.v) - off)
          ? b
          : a
      );
      return closest.v;
    }
  } catch {}
  return "9";
}
function off2tz(off) {
  const m = TZ_OPTS.find((t) => t.v === off);
  return m ? m.z : "UTC";
}
function getCityTZ(c) {
  return c.tz || TZM[c.c] || "UTC";
}
function searchC(q) {
  if (!q || q.length < 1) return [];
  const ql = q.toLowerCase();
  return CDB.filter(
    (c) => c.n.toLowerCase().includes(ql) || c.e.toLowerCase().includes(ql)
  ).slice(0, 10);
}
function tzOS(tz) {
  try {
    const p = new Intl.DateTimeFormat("en", {
      timeZone: tz,
      timeZoneName: "shortOffset",
    }).formatToParts(new Date());
    return p.find((x) => x.type === "timeZoneName")?.value || tz;
  } catch {
    return tz;
  }
}

// ===== CORE =====
const SGN = [
  { id: 1, ab: "Ar" },
  { id: 2, ab: "Ta" },
  { id: 3, ab: "Ge" },
  { id: 4, ab: "Cn" },
  { id: 5, ab: "Le" },
  { id: 6, ab: "Vi" },
  { id: 7, ab: "Li" },
  { id: 8, ab: "Sc" },
  { id: 9, ab: "Sg" },
  { id: 10, ab: "Cp" },
  { id: 11, ab: "Aq" },
  { id: 12, ab: "Pi" },
];
const PL = [
  { id: "As", jp: "ラグナ", color: "#e8b04a" },
  { id: "Su", jp: "太陽", color: "#ff8c42" },
  { id: "Mo", jp: "月", color: "#c4d4e0" },
  { id: "Ma", jp: "火星", color: "#e05555" },
  { id: "Me", jp: "水星", color: "#5cb85c" },
  { id: "Ju", jp: "木星", color: "#f0c040" },
  { id: "Ve", jp: "金星", color: "#e890c0" },
  { id: "Sa", jp: "土星", color: "#7888a0" },
  { id: "Ra", jp: "ラーフ", color: "#9070b0" },
  { id: "Ke", jp: "ケートゥ", color: "#b09070" },
];
const SR = {
  1: "Ma",
  2: "Ve",
  3: "Me",
  4: "Mo",
  5: "Su",
  6: "Me",
  7: "Ve",
  8: "Ma",
  9: "Ju",
  10: "Sa",
  11: "Sa",
  12: "Ju",
};
const NAK = [
  "Ashwini",
  "Bharani",
  "Krittika",
  "Rohini",
  "Mrigashira",
  "Ardra",
  "Punarvasu",
  "Pushya",
  "Ashlesha",
  "Magha",
  "P.Phalguni",
  "U.Phalguni",
  "Hasta",
  "Chitra",
  "Swati",
  "Vishakha",
  "Anuradha",
  "Jyeshtha",
  "Mula",
  "P.Ashadha",
  "U.Ashadha",
  "Shravana",
  "Dhanishtha",
  "Shatabhisha",
  "P.Bhadra",
  "U.Bhadra",
  "Revati",
];

// ===== EPHEMERIS ENGINE (VSOP87 + Meeus Moon) =====
const D2R = Math.PI / 180,
  R2D = 180 / Math.PI,
  PI2 = 2 * Math.PI,
  nm360 = (a) => ((a % 360) + 360) % 360;
const DPM = 365250,
  C_AUDAY = 173.1446327;

// VSOP87 planetary theory data (Mercury-Saturn + Earth)
const VSOP = {
  Mercury: [
    [
      [
        [4.4025071014, 0, 0],
        [0.40989414977, 1.483020342, 26087.903142],
        [0.050462942, 4.4778548955, 52175.806283],
        [0.00855346844, 1.1652032246, 78263.709425],
        [0.00165590362, 4.1196916342, 104351.61257],
        [0.00034561897, 0.77930768443, 130439.51571],
        [0.00007583476, 3.7134840492, 156527.41885],
      ],
      [
        [26087.903137, 0, 0],
        [0.01131199811, 6.218741978, 26087.903142],
        [0.00292242298, 3.0444935554, 52175.806283],
        [0.00075775081, 6.0856882165, 78263.709425],
        [0.00019676525, 2.8096511178, 104351.61257],
      ],
    ],
    [
      [
        [0.11737528961, 1.9835749877, 26087.903142],
        [0.02388076996, 5.0373895969, 52175.806283],
        [0.01222839532, 3.1415926536, 0],
        [0.0054325181, 1.7964436396, 78263.709425],
        [0.0012977877, 4.8323250396, 104351.61257],
        [0.00031866927, 1.5808849566, 130439.51571],
        [0.00007963301, 4.6097212613, 156527.41885],
      ],
      [
        [0.00274646065, 3.9500845001, 26087.903142],
        [0.00099737713, 3.1415926536, 0],
      ],
    ],
    [
      [
        [0.39528271651, 0, 0],
        [0.07834131818, 6.192337226, 26087.903142],
        [0.00795525558, 2.959896901, 52175.806283],
        [0.00121281764, 6.010641538, 78263.709425],
        [0.00021921969, 2.7782009397, 104351.61257],
        [0.00004354065, 5.8289454377, 130439.51571],
      ],
      [
        [0.0021734774, 4.6561715867, 26087.903142],
        [0.00044141826, 1.42385544, 52175.806283],
      ],
    ],
  ],
  Venus: [
    [
      [
        [3.1761466677, 0, 0],
        [0.01353968419, 5.5931331962, 10213.285546],
        [0.00089891645, 5.3065004776, 20426.571092],
        [0.00005477194, 4.4163066147, 7860.4193924],
        [0.00003455741, 2.6996444782, 11790.629089],
        [0.00002372061, 2.9937754208, 3930.2096962],
        [0.00001317168, 5.186682284, 26.2983198],
        [0.00001664146, 4.2501863015, 1577.3435424],
        [0.00001438387, 4.1574508418, 9683.5945811],
        [0.00001200521, 6.1535711604, 30639.856639],
      ],
      [
        [10213.285546, 0, 0],
        [0.00095617813, 2.4640651111, 10213.285546],
        [0.00007787201, 0.6247848222, 20426.571092],
      ],
    ],
    [
      [
        [0.05923638472, 0.26702775812, 10213.285546],
        [0.00040107978, 1.1473717811, 20426.571092],
        [0.00032814918, 3.1415926536, 0],
      ],
      [[0.00287821243, 1.8896496284, 10213.285546]],
    ],
    [
      [
        [0.72334820891, 0, 0],
        [0.00489824182, 4.0215183172, 10213.285546],
        [0.00001658058, 4.9020672803, 20426.571092],
        [0.00001378043, 1.1284659137, 11790.629089],
        [0.00001632096, 2.8454879521, 7860.4193924],
        [0.00000498395, 2.5868219389, 9683.5945811],
        [0.00000221985, 2.0134669654, 19367.189162],
        [0.00000237454, 2.5513605389, 15720.838785],
      ],
      [[0.00034551041, 0.89198706276, 10213.285546]],
    ],
  ],
  Earth: [
    [
      [
        [1.7534704567, 0, 0],
        [0.03341656453, 4.6692568041, 6283.07585],
        [0.00034894275, 4.6261024219, 12566.1517],
        [0.00003417572, 2.8288657975, 3.523118349],
        [0.00003497056, 2.744117834, 5753.3848849],
        [0.00003135899, 3.6276704176, 77713.771468],
        [0.00002676218, 4.4180834544, 7860.4193924],
        [0.00002342691, 6.1351621445, 3930.2096962],
        [0.00001273165, 2.0370965788, 529.69096509],
        [0.00001324294, 0.74246341673, 11506.76977],
        [0.00000901854, 2.0450544648, 26.2983198],
        [0.00001199167, 1.1096294623, 1577.3435424],
        [0.00000857223, 3.5084915228, 398.14900341],
        [0.00000779786, 1.1788268196, 5223.6939198],
        [0.0000099025, 5.2326807209, 5884.9268466],
        [0.00000753141, 2.5333905285, 5507.5532387],
        [0.00000505267, 4.5829259997, 18849.22755],
        [0.00000492392, 4.2050571183, 775.52261132],
        [0.00000356672, 2.9195411448, 0.0673103028],
        [0.00000284125, 1.8986924093, 796.29800682],
        [0.00000242879, 0.34481445893, 5486.7778432],
        [0.00000317087, 5.8490194851, 11790.629089],
        [0.00000271112, 0.31486255375, 10977.078805],
        [0.00000206217, 4.8064663148, 2544.3144199],
        [0.00000205478, 1.8695377028, 5573.1428014],
        [0.00000202318, 2.4576779023, 6069.7767546],
        [0.00000126225, 1.082954595, 20.775395492],
        [0.00000155516, 0.83306084617, 213.29909544],
      ],
      [
        [6283.07585, 0, 0],
        [0.00206058863, 2.6782345581, 6283.07585],
        [0.00004303419, 2.6351223348, 12566.1517],
      ],
      [[0.00008721859, 1.0725363556, 6283.07585]],
    ],
    [
      [],
      [
        [0.00227777722, 3.4137662053, 6283.07585],
        [0.00003805678, 3.370634238, 12566.1517],
      ],
    ],
    [
      [
        [1.0001398878, 0, 0],
        [0.01670699632, 3.0984635026, 6283.07585],
        [0.00013956024, 3.0552460946, 12566.1517],
        [0.0000308372, 5.1984667438, 77713.771468],
        [0.00001628463, 1.1738755805, 5753.3848849],
        [0.00001575572, 2.8468521488, 7860.4193924],
        [0.00000924799, 5.4529223672, 11506.76977],
        [0.00000542439, 4.5640915145, 3930.2096962],
        [0.0000047211, 3.6610002215, 5884.9268466],
        [8.5831e-7, 1.2707912528, 161000.68574],
        [5.7056e-7, 2.0137429225, 83996.847318],
        [5.5736e-7, 5.2415979917, 71430.695618],
        [0.00000174844, 3.0119363673, 18849.22755],
        [0.00000243181, 4.2734953079, 11790.629089],
      ],
      [
        [0.00103018607, 1.1074896817, 6283.07585],
        [0.00001721238, 1.0644230039, 12566.1517],
      ],
      [[0.00004359385, 5.7845513381, 6283.07585]],
    ],
  ],
  Mars: [
    [
      [
        [6.2034771158, 0, 0],
        [0.18656368093, 5.0503710027, 3340.6124267],
        [0.01108216816, 5.4009983634, 6681.2248534],
        [0.00091798406, 5.7547874467, 10021.83728],
        [0.00027744987, 5.9704951315, 3.523118349],
        [0.00010610235, 2.9395856034, 2281.2304965],
        [0.00012315897, 0.84956094002, 2810.9214616],
        [0.00008926784, 4.1569784643, 0.0172536522],
        [0.00008715691, 6.1100515314, 13362.449707],
        [0.00006797556, 0.36462229657, 398.14900341],
        [0.00007774872, 3.3396876138, 5621.8429232],
        [0.00003575078, 1.6618650571, 2544.3144199],
        [0.00004161108, 0.22814971327, 2942.4634233],
        [0.00003075252, 0.85696614132, 191.44826611],
        [0.00002628117, 0.64806124465, 3337.0893084],
        [0.00002937546, 6.078937114, 0.0673103028],
        [0.00002389414, 5.0389644266, 796.29800682],
        [0.00002579844, 0.02996736156, 3344.135545],
        [0.00001528141, 1.14979302, 6151.5338883],
        [0.00001798806, 0.65634057445, 529.69096509],
        [0.00001264357, 3.6227512259, 5092.1519581],
        [0.00001286228, 3.0679606503, 2146.1654165],
        [0.00001546404, 2.9157970172, 1751.5395314],
        [0.00001024902, 3.6933409928, 8962.4553499],
        [0.00000891566, 0.18293837498, 16703.062133],
        [0.00000858759, 2.4009381194, 2914.0142358],
        [0.00000832715, 2.4641861947, 3340.595173],
        [0.0000083272, 4.4949578214, 3340.6296804],
        [0.00000712902, 3.6633547348, 1059.3819302],
        [0.00000748723, 3.8224861402, 155.42039943],
        [0.00000723861, 0.67497311481, 3738.7614301],
        [0.00000635548, 2.9218222513, 8432.7643848],
        [0.00000655162, 0.48864064125, 3127.3133313],
        [0.00000550474, 3.8100104233, 0.9803210682],
        [0.0000055275, 4.4747931704, 1748.0164131],
        [0.00000425966, 0.55364317304, 6283.07585],
        [0.00000415131, 0.49662285038, 213.29909544],
        [0.00000472167, 3.6254712403, 1194.4470102],
        [0.00000306551, 0.38052848348, 6684.7479717],
        [0.00000312141, 0.99853944405, 6677.7017351],
        [0.00000293198, 4.2213129963, 20.775395492],
        [0.00000302375, 4.4861800716, 3532.0606928],
        [0.00000274027, 0.54222167059, 3340.5451164],
        [0.00000281079, 5.8816352179, 1349.8674097],
        [0.00000231183, 1.2824215699, 3870.3033918],
        [0.00000283602, 5.7688543494, 3149.1641606],
        [0.00000236117, 5.7550321793, 3333.4988797],
        [0.00000274033, 0.13372524985, 3340.679737],
        [0.00000299395, 2.7832374087, 6254.6266625],
      ],
      [
        [3340.612427, 0, 0],
        [0.01457554523, 3.6043373324, 3340.6124267],
        [0.00168414711, 3.923185678, 6681.2248534],
        [0.00020622975, 4.2610884458, 10021.83728],
        [0.00003452392, 4.7321039319, 3.523118349],
        [0.00002586332, 4.6067005855, 13362.449707],
        [0.00000841535, 4.4586403043, 2281.2304965],
      ],
      [
        [0.00058152577, 2.0496171243, 3340.6124267],
        [0.00013459579, 2.4573870616, 6681.2248534],
      ],
    ],
    [
      [
        [0.03197134986, 3.7683204243, 3340.6124267],
        [0.00298033234, 4.1061699631, 6681.2248534],
        [0.00289104742, 0, 0],
        [0.00031365539, 4.4465105309, 10021.83728],
        [0.000034841, 4.7881254926, 13362.449707],
      ],
      [
        [0.00217310991, 6.0447219478, 3340.6124267],
        [0.00020976948, 3.1415926536, 0],
        [0.00012834709, 1.6081066792, 6681.2248534],
      ],
    ],
    [
      [
        [1.5303348827, 0, 0],
        [0.1418495316, 3.4797128353, 3340.6124267],
        [0.00660776362, 3.8178344302, 6681.2248534],
        [0.00046179117, 4.1559531678, 10021.83728],
        [0.00008109733, 5.5595841632, 2810.9214616],
        [0.00007485318, 1.772390784, 5621.8429232],
        [0.00005523191, 1.3643630377, 2281.2304965],
        [0.0000382516, 4.4940718369, 13362.449707],
        [0.00002306537, 0.09081579001, 2544.3144199],
        [0.00001999396, 5.3605961771, 3337.0893084],
        [0.00002484394, 4.9254563992, 2942.4634233],
        [0.00001960195, 4.7424943764, 3344.135545],
        [0.00001167119, 2.1126086834, 5092.1519581],
        [0.00001102816, 5.00908404, 398.14900341],
        [0.00000899066, 4.4079113321, 529.69096509],
        [0.00000992252, 5.8386196195, 6151.5338883],
        [0.00000807354, 2.102170655, 1059.3819302],
        [0.00000797915, 3.448392039, 796.29800682],
        [0.00000740975, 1.4990633688, 2146.1654165],
      ],
      [
        [0.01107433345, 2.0325052486, 3340.6124267],
        [0.00103175887, 2.3707184781, 6681.2248534],
        [0.000128772, 0, 0],
        [0.0001081588, 2.7088809566, 10021.83728],
      ],
      [
        [0.00044242249, 0.47930604954, 3340.6124267],
        [0.00008138042, 0.86998389204, 6681.2248534],
      ],
    ],
  ],
  Jupiter: [
    [
      [
        [0.59954691494, 0, 0],
        [0.09695898719, 5.0619179316, 529.69096509],
        [0.00573610142, 1.4440620563, 7.1135470008],
        [0.00306389205, 5.4173473018, 1059.3819302],
        [0.00097178296, 4.1426472655, 632.78373931],
        [0.00072903078, 3.6404291639, 522.57741809],
        [0.00064263975, 3.4114516535, 103.09277422],
        [0.00039806064, 2.2937674079, 419.48464388],
        [0.00038857767, 1.2723175583, 316.39186966],
        [0.00027964629, 1.7845459182, 536.8045121],
        [0.0001358973, 5.7748104079, 1589.0728953],
        [0.00008246349, 3.5822792584, 206.18554844],
        [0.00008768704, 3.630003082, 949.17560897],
        [0.00007368042, 5.0810119427, 735.87651353],
        [0.0000626315, 0.02497628807, 213.29909544],
        [0.00006114062, 4.5131999863, 1162.4747044],
        [0.00004905396, 1.3208447059, 110.20632122],
        [0.00005305285, 1.3067121679, 14.227094002],
        [0.00005305441, 4.1862563401, 1052.2683832],
        [0.00004647248, 4.6995810368, 3.9321532631],
        [0.00003045023, 4.3167643108, 426.59819088],
        [0.00002609999, 1.5666739406, 846.08283475],
        [0.00002028191, 1.0637653071, 3.1813937377],
        [0.00001764763, 2.1414865512, 1066.4954772],
        [0.00001722972, 3.8803626827, 1265.5674786],
        [0.00001920945, 0.97168196472, 639.89728631],
        [0.00001633223, 3.5820183355, 515.46387109],
        [0.00001431999, 4.2968555605, 625.67019231],
        [0.00000973272, 4.0976454913, 95.979227218],
      ],
      [
        [529.69096509, 0, 0],
        [0.00489503243, 4.2208293947, 529.69096509],
        [0.00228917222, 6.0264685562, 7.1135470008],
        [0.00030099479, 4.5454078286, 1059.3819302],
        [0.0002072092, 5.459431569, 522.57741809],
        [0.00012103653, 0.16994816098, 536.8045121],
        [0.00006067987, 4.4242229202, 103.09277422],
        [0.00005433968, 3.9848073775, 419.48464388],
        [0.00004237744, 5.890087072, 14.227094002],
      ],
      [
        [0.00047233601, 4.3214853648, 7.1135470008],
        [0.00030649436, 2.929777887, 529.69096509],
        [0.00014837605, 3.1415926536, 0],
      ],
    ],
    [
      [
        [0.02268615702, 3.5585260672, 529.69096509],
        [0.00109971634, 3.908093472, 1059.3819302],
        [0.00110090358, 0, 0],
        [0.00008101428, 3.6050957288, 522.57741809],
        [0.00006043996, 4.2588310834, 1589.0728953],
        [0.00006437782, 0.30627119215, 536.8045121],
      ],
      [[0.00078203446, 1.5237785974, 529.69096509]],
    ],
    [
      [
        [5.2088742933, 0, 0],
        [0.25209327119, 3.4910863987, 529.69096509],
        [0.00610599976, 3.8411536595, 1059.3819302],
        [0.00282029458, 2.5741988129, 632.78373931],
        [0.00187647346, 2.0759038321, 522.57741809],
        [0.00086792905, 0.71001145545, 419.48464388],
        [0.00072062974, 0.21465724607, 536.8045121],
        [0.00065517248, 5.9799588479, 316.39186966],
        [0.00029134542, 1.6775937966, 103.09277422],
        [0.00030135335, 2.1613200373, 949.17560897],
        [0.00023453271, 3.5402352218, 735.87651353],
        [0.00022283743, 4.193625944, 1589.0728953],
        [0.00023947298, 0.2745803748, 7.1135470008],
        [0.00013032614, 2.9604296536, 1162.4747044],
        [0.0000970336, 1.9066963358, 206.18554844],
        [0.00012749023, 2.7155028659, 1052.2683832],
        [0.00007057931, 2.1818483993, 1265.5674786],
        [0.00006137703, 6.2641824003, 846.08283475],
        [0.00002616976, 2.0099401288, 1581.9593483],
      ],
      [
        [0.0127180152, 2.6493751289, 529.69096509],
        [0.00061661816, 3.0007646039, 1059.3819302],
        [0.00053443713, 3.8971738317, 522.57741809],
        [0.00031185171, 4.8827695801, 536.8045121],
        [0.00041390269, 0, 0],
      ],
    ],
  ],
  Saturn: [
    [
      [
        [0.87401354025, 0, 0],
        [0.11107659762, 3.9620509016, 213.29909544],
        [0.01414150957, 4.5858151687, 7.1135470008],
        [0.00398379389, 0.52112032699, 206.18554844],
        [0.00350769243, 3.303299079, 426.59819088],
        [0.00206816305, 0.24658372002, 103.09277422],
        [0.000792713, 3.8400705688, 220.41264244],
        [0.00023990355, 4.6697692455, 110.20632122],
        [0.00016573588, 0.43719228296, 419.48464388],
        [0.00014906995, 5.7690318387, 316.39186966],
        [0.0001582029, 0.93809155235, 632.78373931],
        [0.00014609559, 1.56518472, 3.9321532631],
        [0.00013160301, 4.448912919, 14.227094002],
        [0.00015053543, 2.7166991567, 639.89728631],
        [0.00013005299, 5.9811902364, 11.045700264],
        [0.00010725067, 3.1293952383, 202.25339517],
        [0.00005863206, 0.23656938524, 529.69096509],
        [0.00005227757, 4.2078336576, 3.1813937377],
        [0.00006126317, 1.7632866791, 277.03499374],
        [0.00005019687, 3.1778772841, 433.71173788],
        [0.0000459255, 0.61977744975, 199.07200144],
        [0.00004005867, 2.244797185, 63.735898303],
        [0.00002953796, 0.98280366998, 95.979227218],
        [0.0000387367, 3.2228322697, 138.51749687],
        [0.00002461186, 2.0316387507, 735.87651353],
        [0.00003269484, 0.77492638211, 949.17560897],
        [0.00001758145, 3.2658010994, 522.57741809],
        [0.00001640172, 5.5050445305, 846.08283475],
        [0.00001391327, 4.023331505, 323.50541666],
        [0.00001580648, 4.3726530717, 309.27832266],
        [0.00001123498, 2.8372679845, 415.55249061],
        [0.00001017275, 3.717001354, 227.52618944],
        [0.00000848642, 3.1915017083, 209.36694217],
      ],
      [
        [213.29909522, 0, 0],
        [0.01297370862, 1.8283492398, 213.29909544],
        [0.00564345393, 2.8849971727, 7.1135470008],
        [0.00093734369, 1.063117935, 426.59819088],
        [0.00107674962, 2.2776913101, 206.18554844],
        [0.00040244455, 2.0410810467, 220.41264244],
        [0.00019941774, 1.2795439047, 103.09277422],
        [0.00010511678, 2.7488034213, 14.227094002],
        [0.00006416106, 0.38238295041, 639.89728631],
        [0.00004848994, 2.4303761023, 419.48464388],
        [0.00004056892, 2.9213320947, 110.20632122],
        [0.00003768635, 3.6496533078, 3.9321532631],
      ],
      [
        [0.0011644133, 1.1798813288, 7.1135470008],
        [0.00091841837, 0.0732519584, 213.29909544],
        [0.00036661728, 0, 0],
        [0.00015274496, 4.0649317917, 206.18554844],
      ],
    ],
    [
      [
        [0.04330678039, 3.602844284, 213.29909544],
        [0.00240348302, 2.8523848937, 426.59819088],
        [0.00084745939, 0, 0],
        [0.00030863357, 3.4844150456, 220.41264244],
        [0.00034116062, 0.57297307557, 206.18554844],
        [0.0001473407, 2.1184659672, 639.89728631],
        [0.00009916667, 5.790031889, 419.48464388],
        [0.00006993564, 4.7360468972, 7.1135470008],
        [0.00004807588, 5.4330531206, 316.39186966],
      ],
      [
        [0.00198927992, 4.939010179, 213.29909544],
        [0.00036947916, 3.1415926536, 0],
        [0.00017966989, 0.5197943111, 426.59819088],
      ],
    ],
    [
      [
        [9.5575813549, 0, 0],
        [0.52921382865, 2.3922621957, 213.29909544],
        [0.01873679867, 5.2354960466, 206.18554844],
        [0.01464663929, 1.647630429, 426.59819088],
        [0.00821891141, 5.935200423, 316.39186966],
        [0.00547506923, 5.0153261898, 103.09277422],
        [0.0037168465, 2.2711482111, 220.41264244],
        [0.00361778765, 3.1390430185, 7.1135470008],
        [0.00140617506, 5.7040660678, 632.78373931],
        [0.00108974848, 3.2931339018, 110.20632122],
        [0.00069006962, 5.9409954099, 419.48464388],
        [0.00061053367, 0.94037691801, 639.89728631],
        [0.00048913294, 1.5573363868, 202.25339517],
        [0.00034143772, 0.19519102597, 277.03499374],
        [0.00032401773, 5.4708456702, 949.17560897],
        [0.00020936596, 0.46349251129, 735.87651353],
        [0.00009796004, 5.2047753795, 1265.5674786],
        [0.00011993338, 5.9805096739, 846.08283475],
        [0.000208393, 1.5210247613, 433.71173788],
        [0.00015298404, 3.0594381494, 529.69096509],
        [0.00006465823, 0.17732249942, 1052.2683832],
        [0.00011380257, 1.7310542704, 522.57741809],
        [0.00003419618, 4.9455054217, 1581.9593483],
      ],
      [
        [0.0618298134, 0.2584351148, 213.29909544],
        [0.00506577242, 0.71114625261, 206.18554844],
        [0.00341394029, 5.7963574166, 426.59819088],
        [0.00188491195, 0.47215589652, 220.41264244],
        [0.00186261486, 3.1415926536, 0],
        [0.00143891146, 1.4074482289, 7.1135470008],
      ],
      [[0.00436902572, 4.7867167751, 213.29909544]],
    ],
  ],
};

function toJD(y, m, d, utH = 12) {
  if (m <= 2) {
    y--;
    m += 12;
  }
  const A = Math.floor(y / 100);
  return (
    Math.floor(365.25 * (y + 4716)) +
    Math.floor(30.6001 * (m + 1)) +
    d +
    utH / 24 +
    2 -
    A +
    Math.floor(A / 4) -
    1524.5
  );
}

function getTZOff(ds, tz) {
  try {
    const d = new Date(ds + "T12:00:00Z");
    const p = new Intl.DateTimeFormat("en", {
      timeZone: tz,
      timeZoneName: "shortOffset",
    }).formatToParts(d);
    const t = p.find((x) => x.type === "timeZoneName")?.value || "";
    const m = t.match(/GMT([+-]?\d+)(?::(\d+))?/);
    return m
      ? parseInt(m[1]) +
          (parseInt(m[2] || 0) / 60) * (m[1].startsWith("-") ? -1 : 1)
      : 0;
  } catch {
    return 0;
  }
}

// Delta T approximation (seconds) - Espenak & Meeus
function deltaT(y) {
  if (y < 1986) return 45.45 + 1.067 * (y - 1975);
  if (y < 2005) return 63.86 + 0.3345 * (y - 2000);
  if (y < 2050)
    return 62.92 + 0.32217 * (y - 2000) + 0.005589 * (y - 2000) * (y - 2000);
  return 63 + 0.32 * (y - 2000);
}

// Ayanamsha
function calcAya(jd, type = "lahiri") {
  const dy = (jd - 2415020) / 365.25;
  if (type === "kp") return 22.362 + (dy * 50.2388) / 3600;
  if (type === "raman") return 22.0 + (dy * 50.0) / 3600;
  if (type === "fagan") return 24.042 + (dy * 50.2564) / 3600;
  return 22.4605 + (dy * 50.2912) / 3600;
}

// VSOP87 evaluator
function vsopEval(model, t, clamp) {
  let v = 0,
    tp = 1;
  for (const s of model) {
    let sum = 0;
    for (const [a, p, f] of s) sum += a * Math.cos(p + t * f);
    v += tp * sum;
    tp *= t;
  }
  if (clamp) v = ((v % PI2) + PI2) % PI2;
  return v;
}
function vsopXYZ(planet, tt) {
  const t = tt / DPM;
  const L = vsopEval(VSOP[planet][0], t, true);
  const B = vsopEval(VSOP[planet][1], t, false);
  const R = vsopEval(VSOP[planet][2], t, false);
  const cb = Math.cos(B);
  return {
    L,
    R,
    x: R * cb * Math.cos(L),
    y: R * cb * Math.sin(L),
    z: R * Math.sin(B),
  };
}

// Ecliptic precession J2000→date (degrees)
function precLon(T) {
  return (5029.0966 * T + 1.112 * T * T) / 3600;
}
// Nutation in longitude (IAU 1980 simplified, degrees)
function nutLon(T) {
  const Om = nm360(125.04452 - 1934.136261 * T) * D2R;
  const Ls = nm360(280.4665 + 36000.7698 * T) * D2R;
  const Lm = nm360(218.3165 + 481267.8813 * T) * D2R;
  return (
    (-17.2 * Math.sin(Om) -
      1.32 * Math.sin(2 * Ls) -
      0.23 * Math.sin(2 * Lm) +
      0.21 * Math.sin(2 * Om)) /
    3600
  );
}

// Geocentric ecliptic longitude (planets) with light-time correction + precession + nutation
function geoEclLon(planet, tt, T) {
  const earth = vsopXYZ("Earth", tt);
  let lt = 0,
    dx,
    dy;
  for (let i = 0; i < 3; i++) {
    const p = vsopXYZ(planet, tt - lt);
    dx = p.x - earth.x;
    dy = p.y - earth.y;
    const dz = p.z - earth.z;
    lt = Math.sqrt(dx * dx + dy * dy + dz * dz) / C_AUDAY;
  }
  return nm360(Math.atan2(dy, dx) * R2D + precLon(T) + nutLon(T));
}
// Sun longitude with aberration
function sunLonVsop(tt, T) {
  const e = vsopXYZ("Earth", tt);
  return nm360(e.L * R2D + 180 + precLon(T) + nutLon(T) - 20.496 / 3600);
}

// Moon (Meeus Ch47 - Full ELP/82 with E correction)
function calcMoon(T) {
  const T2 = T * T,
    T3 = T2 * T;
  const Lp = nm360(
    218.3164477 +
      481267.88123421 * T -
      0.0015786 * T2 +
      T3 / 538841 -
      (T3 * T) / 65194000
  );
  const D = nm360(
    297.8501921 +
      445267.1114034 * T -
      0.0018819 * T2 +
      T3 / 545868 -
      (T3 * T) / 113065000
  );
  const M = nm360(
    357.5291092 + 35999.0502909 * T - 0.0001536 * T2 + T3 / 24490000
  );
  const Mp = nm360(
    134.9633964 +
      477198.8675055 * T +
      0.0087414 * T2 +
      T3 / 69699 -
      (T3 * T) / 14712000
  );
  const F = nm360(
    93.272095 +
      483202.0175233 * T -
      0.0036539 * T2 -
      T3 / 3526000 +
      (T3 * T) / 863310000
  );
  const A1 = nm360(119.75 + 131.849 * T),
    A2 = nm360(53.09 + 479264.29 * T);
  const Dr = D * D2R,
    Mr = M * D2R,
    Mpr = Mp * D2R,
    Fr = F * D2R,
    A1r = A1 * D2R,
    A2r = A2 * D2R;
  const E = 1 - 0.002516 * T - 0.0000074 * T2;
  const E2 = E * E;
  const LT = [
    [0, 0, 1, 0, 6288774],
    [2, 0, -1, 0, 1274027],
    [2, 0, 0, 0, 658314],
    [0, 0, 2, 0, 213618],
    [0, 1, 0, 0, -185116],
    [0, 0, 0, 2, -114332],
    [2, 0, -2, 0, 58793],
    [2, -1, -1, 0, 57066],
    [2, 0, 1, 0, 53322],
    [2, -1, 0, 0, 45758],
    [0, 1, -1, 0, -40923],
    [1, 0, 0, 0, -34720],
    [0, 1, 1, 0, -30383],
    [2, 0, 0, -2, 15327],
    [0, 0, 1, 2, -12528],
    [0, 0, 1, -2, 10980],
    [4, 0, -1, 0, 10675],
    [0, 0, 3, 0, 10034],
    [4, 0, -2, 0, 8548],
    [2, 1, -1, 0, -7888],
    [2, 1, 0, 0, -6766],
    [1, 0, -1, 0, -5163],
    [1, 1, 0, 0, 4987],
    [2, -1, 1, 0, 4036],
    [2, 0, 2, 0, 3994],
    [4, 0, 0, 0, 3861],
    [2, 0, -3, 0, 3665],
    [0, 1, -2, 0, -2689],
    [2, 0, -1, 2, -2602],
    [2, -1, -2, 0, 2390],
    [1, 0, 1, 0, -2348],
    [2, -2, 0, 0, 2236],
    [0, 1, 2, 0, -2120],
    [0, 2, 0, 0, -2069],
    [2, -2, -1, 0, 2048],
    [2, 0, 1, -2, -1773],
    [2, 0, 0, 2, -1595],
    [4, -1, -1, 0, 1215],
    [0, 0, 2, 2, -1110],
    [3, 0, -1, 0, -892],
    [2, 1, 1, 0, -810],
    [4, -1, -2, 0, 759],
    [0, 2, -1, 0, -713],
    [2, 2, -1, 0, -700],
    [2, 1, -2, 0, 691],
    [2, -1, 0, -2, 596],
    [4, 0, 1, 0, 549],
    [0, 0, 4, 0, 537],
    [4, -1, 0, 0, 520],
    [1, 0, -2, 0, -487],
    [2, 1, 0, -2, -399],
    [0, 0, 2, -2, -381],
    [1, 1, 1, 0, 351],
    [3, 0, -2, 0, -340],
    [4, 0, -3, 0, 330],
    [2, -1, 2, 0, 327],
    [0, 2, 1, 0, -323],
    [1, 1, -1, 0, 299],
    [2, 0, 3, 0, 294],
  ];
  let sL = 0;
  LT.forEach(([d, m, mp, f, c0]) => {
    let c = c0;
    if (Math.abs(m) === 1) c = c0 * E;
    else if (Math.abs(m) === 2) c = c0 * E2;
    sL += c * Math.sin(d * Dr + m * Mr + mp * Mpr + f * Fr);
  });
  sL +=
    3958 * Math.sin(A1r) + 1962 * Math.sin(Lp * D2R - Fr) + 318 * Math.sin(A2r);
  return nm360(Lp + sL / 1000000);
}

// Ascendant (tropical)
function calcAscTrop(jd, lat, lon) {
  const T = (jd - 2451545) / 36525;
  const th = nm360(
    280.46061837 + 360.98564736629 * (jd - 2451545) + 0.000387933 * T * T
  );
  const LST = nm360(th + lon) * D2R;
  const eps = (23.4393 - 0.013 * T) * D2R;
  const latR = lat * D2R;
  return nm360(
    Math.atan2(
      Math.cos(LST),
      -(Math.sin(eps) * Math.tan(latR) + Math.cos(eps) * Math.sin(LST))
    ) * R2D
  );
}

// Rahu (mean & true node)
function calcRahu(T, type) {
  const T2 = T * T,
    T3 = T2 * T;
  const rm = nm360(
    125.0445479 -
      1934.1362891 * T +
      0.0020754 * T2 +
      T3 / 467441 -
      (T3 * T) / 60616000
  );
  if (type === "true") {
    const Mr = nm360(357.529 + 35999.05 * T) * D2R;
    const Dr = nm360(297.85 + 445267.111 * T) * D2R;
    const Fr = nm360(93.272 + 483202.018 * T) * D2R;
    return nm360(
      rm -
        1.4979 * Math.sin(2 * nm360(183.3 + 331.3 * T) * D2R) -
        0.15 * Math.sin(Mr) -
        0.1226 * Math.sin(2 * Dr) +
        0.1176 * Math.sin(2 * Fr)
    );
  }
  return rm;
}

// Main chart calculation
function calcChart(dateStr, timeStr, lat, lon, tz, stg) {
  const [y, mo, d] = (dateStr || "1990-07-15").split("-").map(Number);
  const [hh, mm, ss] = (timeStr || "12:00:00").split(":").map(Number);
  const tzOff = getTZOff(dateStr, tz || "UTC");
  const utH = hh + mm / 60 + (ss || 0) / 3600 - tzOff;
  const jd = toJD(y, mo, d, utH);
  const dT = deltaT(y + (mo - 1) / 12) / 86400;
  const tt = jd - 2451545 + dT;
  const T = tt / 36525;
  const aya = calcAya(jd, stg?.ayanamsha);
  const asc = calcAscTrop(jd, lat || 35.664, lon || 139.698);
  const sunTrop = sunLonVsop(tt, T);
  const moonTrop = calcMoon(T);
  const rahuTrop = calcRahu(T, stg?.nodeType === "true" ? "true" : "mean");
  const toS = (lon) => ({
    sign: Math.floor(nm360(lon) / 30) + 1,
    deg: nm360(lon) % 30,
  });
  // Retrograde: compare with next day
  const tt2 = tt + 1,
    T2n = tt2 / 36525;
  const sunTrop2 = sunLonVsop(tt2, T2n),
    moonTrop2 = calcMoon(T2n);
  const isRetro = (a, b) => nm360(b - a) > 180;
  const mkP = (trop, trop2) => ({
    ...toS(nm360(trop - aya)),
    retro: isRetro(trop, trop2),
  });
  const plNames = ["Mercury", "Venus", "Mars", "Jupiter", "Saturn"];
  const plIds = ["Me", "Ve", "Ma", "Ju", "Sa"];
  const planets = {
    As: { ...toS(nm360(asc - aya)), retro: false },
    Su: mkP(sunTrop, sunTrop2),
    Mo: mkP(moonTrop, moonTrop2),
  };
  plNames.forEach((name, i) => {
    const lon1 = geoEclLon(name, tt, T);
    const lon2 = geoEclLon(name, tt2, T2n);
    planets[plIds[i]] = mkP(lon1, lon2);
  });
  planets.Ra = { ...toS(nm360(rahuTrop - aya)), retro: true };
  planets.Ke = { ...toS(nm360(rahuTrop + 180 - aya)), retro: true };
  return planets;
}

// Default settings (KN Rao method)
const DEF_STG = {
  ayanamsha: "lahiri",
  nodeType: "mean",
  karakaSystem: "7",
  houseSystem: "sripati",
};
const NEW_BD = {
  name: "",
  date: "1990-01-01",
  time: "12:00:00",
  place: "",
  lat: 0,
  lon: 0,
  tz: "Asia/Tokyo",
  notes: "",
};
const VI = [
  { id: "D1", n: "Rashi" },
  { id: "D2", n: "Hora" },
  { id: "D3", n: "Drekkana" },
  { id: "D4", n: "Chaturthamsa" },
  { id: "D7", n: "Saptamsa" },
  { id: "D9", n: "Navamsa" },
  { id: "D10", n: "Dasamsa" },
  { id: "D12", n: "Dwadasamsa" },
  { id: "D16", n: "Shodasamsa" },
  { id: "D20", n: "Vimsamsa" },
  { id: "D24", n: "Chaturvimsamsa" },
  { id: "D27", n: "Nakshatramsa" },
  { id: "D30", n: "Trimsamsa" },
  { id: "D40", n: "Khavedamsa" },
  { id: "D45", n: "Akshavedamsa" },
  { id: "D60", n: "Shashtiamsa" },
];
const SI = [
  { id: "BC", n: "Bhava Chalit", jp: "バーヴァチャリタ" },
  { id: "ML", n: "Moon Lagna", jp: "月ラグナ" },
  { id: "SuL", n: "Sun Lagna", jp: "太陽ラグナ" },
  { id: "JP", n: "Jaimini Pada", jp: "パダ" },
  { id: "AV", n: "Ashtakavarga", jp: "アシュタカヴァルガ" },
  { id: "SL", n: "Special Lagna", jp: "スペシャルラグナ" },
  { id: "UG", n: "Upagraha", jp: "ウパグラハ" },
];

// ===== CALC =====
function gNak(s, d) {
  return NAK[Math.floor(((s - 1) * 30 + d) / (360 / 27)) % 27];
}
function fD(d) {
  const i = Math.floor(d);
  return `${i}°${Math.round((d - i) * 60)
    .toString()
    .padStart(2, "0")}'`;
}
function pLb(pid, p) {
  return p[pid]?.retro ? `${pid}*` : pid;
}
function cV(p, vid) {
  if (vid === "D1") return p;
  const n = parseInt(vid.slice(1));
  if (isNaN(n)) return p;
  const r = {};
  Object.entries(p).forEach(([pid, { sign, deg, retro }]) => {
    const ns = vS(sign, deg, n),
      sp = 30 / n,
      pos = deg % sp;
    r[pid] = { sign: ns, deg: (pos / sp) * 30, retro };
  });
  return r;
}
function vS(s, d, n) {
  switch (n) {
    case 1:
      return s;
    case 2: {
      const o = s % 2 === 1,
        f = d < 15;
      return o ? (f ? 5 : 4) : f ? 4 : 5;
    }
    case 3:
      return ((s - 1 + [0, 4, 8][Math.floor(d / 10)]) % 12) + 1;
    case 4:
      return ((s - 1 + [0, 3, 6, 9][Math.floor(d / 7.5)]) % 12) + 1;
    case 7: {
      const p = Math.floor(d / (30 / 7)),
        ss = s % 2 === 1 ? s : ((s + 5) % 12) + 1;
      return ((ss - 1 + p) % 12) + 1;
    }
    case 9: {
      const e = (s - 1) % 4,
        st = [1, 10, 7, 4];
      return ((st[e] - 1 + Math.floor(d / (30 / 9))) % 12) + 1;
    }
    case 10: {
      const p = Math.floor(d / 3),
        ss = s % 2 === 1 ? s : ((s + 7) % 12) + 1;
      return ((ss - 1 + p) % 12) + 1;
    }
    case 12:
      return ((s - 1 + Math.floor(d / 2.5)) % 12) + 1;
    default:
      return ((s - 1 + Math.floor(d / (30 / n))) % 12) + 1;
  }
}
const KN2 = ["AK", "AmK", "BK", "MK", "PK", "GK", "DK"],
  KPL = ["Su", "Mo", "Ma", "Me", "Ju", "Ve", "Sa"];
function cK(p) {
  const s = KPL.map((x) => ({ p: x, d: p[x].deg })).sort((a, b) => b.d - a.d);
  const m = {};
  s.forEach((e, i) => {
    m[e.p] = KN2[i];
  });
  return m;
}
function cA(p) {
  const m = {};
  for (let i = 1; i <= 12; i++) m[i] = [];
  ["Su", "Mo", "Ma", "Me", "Ju", "Ve", "Sa", "Ra", "Ke"].forEach((pid) => {
    const s = p[pid]?.sign;
    if (!s) return;
    const pl = PL.find((x) => x.id === pid);
    const off = [6];
    if (pid === "Ma") off.push(3, 7);
    if (pid === "Ju") off.push(4, 8);
    if (pid === "Sa") off.push(2, 9);
    off.forEach((o) => {
      const t = ((s - 1 + o) % 12) + 1;
      if (t !== s) m[t].push({ id: pid, color: pl.color });
    });
  });
  return m;
}
function cFN(asc) {
  const hl = {};
  for (let h = 1; h <= 12; h++) {
    const s = ((asc - 1 + h - 1) % 12) + 1,
      l = SR[s];
    if (!hl[l]) hl[l] = [];
    hl[l].push(h);
  }
  const r = {};
  Object.entries(hl).forEach(([pid, houses]) => {
    const tri = houses.some((h) => [1, 5, 9].includes(h)),
      ken = houses.some((h) => [4, 7, 10].includes(h)),
      dus = houses.some((h) => [6, 8, 12].includes(h)),
      trs = houses.some((h) => [3, 11].includes(h));
    if (tri && ken) r[pid] = "YK";
    else if (houses.includes(1) || tri) r[pid] = "B";
    else if (ken && !dus && !trs) r[pid] = "N";
    else if (dus || trs) r[pid] = "M";
    else r[pid] = "N";
  });
  r["As"] = "—";
  r["Ra"] = "—";
  r["Ke"] = "—";
  return r;
}
function fnL(n) {
  return (
    {
      YK: { t: "YK", c: "#f0c040" },
      B: { t: "B", c: "#5cb85c" },
      M: { t: "M", c: "#e05555" },
      N: { t: "N", c: "#7888a0" },
    }[n] || { t: "—", c: "#2a2535" }
  );
}

const MB_D = {
  Su: [20, 9, 12, 6, 8, 24, 16, 17, 22, 2, 3, 23],
  Mo: [26, 12, 13, 25, 24, 11, 26, 14, 13, 25, 5, 12],
  Ma: [19, 28, 25, 23, 29, 28, 14, 21, 2, 15, 11, 6],
  Me: [15, 14, 13, 12, 8, 18, 20, 10, 21, 22, 7, 15],
  Ju: [19, 29, 12, 27, 6, 4, 13, 10, 17, 11, 15, 28],
  Ve: [28, 15, 11, 17, 10, 13, 24, 1, 15, 20, 25, 15],
  Sa: [10, 4, 7, 9, 12, 16, 3, 18, 28, 14, 13, 15],
};
function chkG(s, d) {
  if ([4, 8, 12].includes(s) && d >= 26.667) return "G";
  if ([1, 5, 9].includes(s) && d <= 3.333) return "G";
  return "";
}
function chkMB(pid, s, d) {
  if (!MB_D[pid]) return "";
  return Math.abs(d - MB_D[pid][s - 1]) <= 1 ? "m" : "";
}

// SAV
const AVR = {
  Su: {
    Su: [1, 2, 4, 7, 8, 9, 10, 11],
    Mo: [3, 6, 10, 11],
    Ma: [1, 2, 4, 7, 8, 9, 10, 11],
    Me: [3, 5, 6, 9, 10, 11, 12],
    Ju: [5, 6, 9, 11],
    Ve: [6, 7, 12],
    Sa: [1, 2, 4, 7, 8, 9, 10, 11],
    As: [3, 4, 6, 10, 11, 12],
  },
  Mo: {
    Su: [3, 6, 7, 8, 10, 11],
    Mo: [1, 3, 6, 7, 10, 11],
    Ma: [2, 3, 5, 6, 9, 10, 11],
    Me: [1, 3, 4, 5, 7, 8, 10, 11],
    Ju: [1, 4, 7, 8, 10, 11, 12],
    Ve: [3, 4, 5, 7, 9, 10, 11],
    Sa: [3, 5, 6, 11],
    As: [3, 6, 10, 11],
  },
  Ma: {
    Su: [3, 5, 6, 10, 11],
    Mo: [3, 6, 11],
    Ma: [1, 2, 4, 7, 8, 10, 11],
    Me: [3, 5, 6, 11],
    Ju: [6, 10, 11, 12],
    Ve: [6, 8, 11, 12],
    Sa: [1, 4, 7, 8, 9, 10, 11],
    As: [1, 3, 6, 10, 11],
  },
  Me: {
    Su: [5, 6, 9, 11, 12],
    Mo: [2, 4, 6, 8, 10, 11],
    Ma: [1, 2, 4, 7, 8, 9, 10, 11],
    Me: [1, 3, 5, 6, 9, 10, 11, 12],
    Ju: [6, 8, 11, 12],
    Ve: [1, 2, 3, 4, 5, 8, 9, 11],
    Sa: [1, 2, 4, 7, 8, 9, 10, 11],
    As: [1, 2, 4, 6, 8, 10, 11],
  },
  Ju: {
    Su: [1, 2, 3, 4, 7, 8, 9, 10, 11],
    Mo: [2, 5, 7, 9, 11],
    Ma: [1, 2, 4, 7, 8, 10, 11],
    Me: [1, 2, 4, 5, 6, 9, 10, 11],
    Ju: [1, 2, 3, 4, 7, 8, 10, 11],
    Ve: [2, 5, 6, 9, 10, 11],
    Sa: [3, 5, 6, 12],
    As: [1, 2, 4, 5, 6, 7, 9, 10, 11],
  },
  Ve: {
    Su: [8, 11, 12],
    Mo: [1, 2, 3, 4, 5, 8, 9, 11, 12],
    Ma: [3, 5, 6, 9, 11, 12],
    Me: [3, 5, 6, 9, 11],
    Ju: [5, 8, 9, 10, 11],
    Ve: [1, 2, 3, 4, 5, 8, 9, 10, 11],
    Sa: [3, 4, 5, 8, 9, 10, 11],
    As: [1, 2, 3, 4, 5, 8, 9, 11],
  },
  Sa: {
    Su: [1, 2, 4, 7, 8, 10, 11],
    Mo: [3, 6, 11],
    Ma: [3, 5, 6, 10, 11, 12],
    Me: [6, 8, 9, 10, 11, 12],
    Ju: [5, 6, 11, 12],
    Ve: [6, 11, 12],
    Sa: [3, 5, 6, 11],
    As: [1, 3, 4, 6, 10, 11],
  },
};
function cSAV(p) {
  const sv = Array(12).fill(0);
  const rf = ["Su", "Mo", "Ma", "Me", "Ju", "Ve", "Sa"];
  rf.forEach((pl) => {
    const ru = AVR[pl];
    if (!ru) return;
    [...rf, "As"].forEach((ref) => {
      const rs = p[ref]?.sign;
      if (!rs || !ru[ref]) return;
      ru[ref].forEach((h) => {
        sv[(rs - 1 + h - 1) % 12]++;
      });
    });
  });
  return sv;
}

// Upagraha
function cUG(p) {
  const sL = (p.Su.sign - 1) * 30 + p.Su.deg;
  const toSD = (l) => {
    const v = ((l % 360) + 360) % 360;
    return { sign: Math.floor(v / 30) + 1, deg: v % 30 };
  };
  const ugs = [
    { id: "Gu", jp: "グリカ", ...toSD((sL + 150) % 360) },
    { id: "Dh", jp: "ドゥーマ", ...toSD((sL + 133.333) % 360) },
    {
      id: "Vy",
      jp: "ヴィヤティ",
      ...toSD((360 - ((sL + 133.333) % 360) + 360) % 360),
    },
    {
      id: "Pa",
      jp: "パリヴェーシャ",
      ...toSD((((360 - ((sL + 133.333) % 360) + 360) % 360) + 180) % 360),
    },
    {
      id: "In",
      jp: "インドラ",
      ...toSD(
        (360 -
          ((((360 - ((sL + 133.333) % 360) + 360) % 360) + 180) % 360) +
          360) %
          360
      ),
    },
    {
      id: "Up",
      jp: "ウパケートゥ",
      ...toSD(
        (((360 -
          ((((360 - ((sL + 133.333) % 360) + 360) % 360) + 180) % 360) +
          360) %
          360) +
          16.667) %
          360
      ),
    },
  ];
  ugs.forEach((ug) => {
    const uL = (ug.sign - 1) * 30 + ug.deg;
    ug.warn = false;
    ["Su", "Mo", "Ma", "Me", "Ju", "Ve", "Sa", "Ra", "Ke"].forEach((pid) => {
      const pL = (p[pid].sign - 1) * 30 + p[pid].deg;
      const d = Math.min(Math.abs(uL - pL), 360 - Math.abs(uL - pL));
      if (d <= 5) ug.warn = true;
    });
  });
  return ugs;
}

// Special Lagnas
function cSL(p) {
  const aL = (p.As.sign - 1) * 30 + p.As.deg;
  const toSD = (l) => {
    const v = ((l % 360) + 360) % 360;
    return { sign: Math.floor(v / 30) + 1, deg: v % 30 };
  };
  return [
    { id: "HL", jp: "ホーラ", ...toSD(aL + 45.5) },
    { id: "GL", jp: "ガティ", ...toSD(aL + 112.3) },
    { id: "BL", jp: "バーヴァ", ...toSD(aL + 22.8) },
    { id: "VL", jp: "ヴァルナダ", ...toSD(aL + 195.5) },
    { id: "IL", jp: "インドゥ", ...toSD(aL + 67.2) },
    { id: "PL", jp: "プラーナパダ", ...toSD(aL + 200.7) },
  ];
}

// Jaimini Pada
function cJP(p, asc) {
  const pd = [];
  for (let h = 1; h <= 12; h++) {
    const hs = ((asc - 1 + h - 1) % 12) + 1;
    const lord = SR[hs];
    const ls = p[lord]?.sign || hs;
    let dist = ((ls - hs + 12) % 12) + 1;
    let ps = ((ls - 1 + dist - 1) % 12) + 1;
    if (ps === hs) ps = ((hs - 1 + 9) % 12) + 1;
    pd.push({ house: h, sign: ps, label: h === 1 ? "AL" : `A${h}` });
  }
  return pd;
}

const NCA = "#e8b04a90",
  NC = "#6a608090";

// ===== SVG =====
function AD2({ dots, x, y, mx }) {
  if (!dots || !dots.length) return null;
  const m = mx || 5;
  return (
    <>
      {dots.map((d, i) => (
        <circle
          key={`${d.id}-${i}`}
          cx={x + (i % m) * 7}
          cy={y + Math.floor(i / m) * 7}
          r={2.5}
          fill={d.color}
          opacity="0.85"
        />
      ))}
    </>
  );
}
function PG({ planets, pl, kMap, cx, cy, cs, rs }) {
  const c2 = cs || 32,
    r2 = rs || 26,
    cols = Math.min(planets.length, 3),
    rows = Math.ceil(planets.length / cols);
  return (
    <>
      {planets.map((p, i) => {
        const ri = Math.floor(i / cols),
          ci = i % cols,
          cr = ri < rows - 1 ? cols : planets.length - ri * cols;
        const px = cx - ((cr - 1) * c2) / 2 + ci * c2,
          py = cy - ((rows - 1) * r2) / 2 + ri * r2;
        const k = kMap[p.id];
        return (
          <g key={p.id}>
            {k && (
              <text
                x={px}
                y={py - 12}
                textAnchor="middle"
                fill="#8a80a0"
                fontSize="7"
                fontWeight="600"
                fontFamily="'JetBrains Mono',monospace"
              >
                {k}
              </text>
            )}
            <text
              x={px}
              y={py}
              textAnchor="middle"
              fill={p.color}
              fontSize="14"
              fontWeight="bold"
              fontFamily="'JetBrains Mono',monospace"
            >
              {pLb(p.id, pl)}
            </text>
            <text
              x={px}
              y={py + 11}
              textAnchor="middle"
              fill={p.color}
              fontSize="7"
              opacity="0.5"
            >
              {fD(pl[p.id].deg)}
            </text>
          </g>
        );
      })}
    </>
  );
}
function pgB2(n, cy, rs) {
  return cy + ((Math.ceil(n / 3) - 1) * (rs || 26)) / 2 + 16;
}

const SG = {
  12: [0, 0],
  1: [1, 0],
  2: [2, 0],
  3: [3, 0],
  11: [0, 1],
  4: [3, 1],
  10: [0, 2],
  5: [3, 2],
  9: [0, 3],
  8: [1, 3],
  7: [2, 3],
  6: [3, 3],
};
function SCh({ pl, ascSign, kMap, label, onSignTap }) {
  const cs = 105,
    g = 2,
    ts = cs * 4 + g * 5,
    am = cA(pl);
  const getP = (s) =>
    Object.entries(pl)
      .filter(([, v]) => v.sign === s)
      .map(([k]) => PL.find((p) => p.id === k));
  const hN = (s) => ((s - ascSign + 12) % 12) + 1;
  return (
    <svg viewBox={`0 0 ${ts} ${ts}`} width="100%" style={{ maxWidth: 440 }}>
      <defs>
        <linearGradient id="cg" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stopColor="#1a1520" />
          <stop offset="100%" stopColor="#0f0d14" />
        </linearGradient>
        <linearGradient id="ag" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stopColor="#2a1f10" />
          <stop offset="100%" stopColor="#1a1510" />
        </linearGradient>
      </defs>
      <rect width={ts} height={ts} rx="8" fill="#08060c" />
      {Object.entries(SG).map(([ss, [col, row]]) => {
        const sid = parseInt(ss),
          planets = getP(sid),
          hn = hN(sid),
          x = g + col * (cs + g),
          y = g + row * (cs + g),
          isA = hn === 1,
          asp = am[sid] || [];
        return (
          <g
            key={sid}
            onClick={() => onSignTap && onSignTap(sid)}
            style={{ cursor: onSignTap ? "pointer" : "default" }}
          >
            <rect
              x={x}
              y={y}
              width={cs}
              height={cs}
              rx="4"
              fill={isA ? "url(#ag)" : "url(#cg)"}
              stroke={isA ? "#e8b04a" : "#2a2535"}
              strokeWidth={isA ? 1.5 : 0.5}
            />
            <text
              x={x + cs - 7}
              y={y + cs - 7}
              textAnchor="end"
              fill={isA ? NCA : NC}
              fontSize="11"
              fontFamily="'JetBrains Mono',monospace"
            >
              {hn}
            </text>
            <AD2 dots={asp} x={x + 7} y={y + 8} />
            <PG
              planets={planets}
              pl={pl}
              kMap={kMap}
              cx={x + cs / 2}
              cy={y + cs / 2}
            />
          </g>
        );
      })}
      <rect
        x={g + cs + g}
        y={g + cs + g}
        width={cs * 2 + g}
        height={cs * 2 + g}
        rx="4"
        fill="#0a0810"
        stroke="#1a1520"
        strokeWidth="0.5"
      />
      <text
        x={ts / 2}
        y={ts / 2 - 4}
        textAnchor="middle"
        fill="#4a4058"
        fontSize="11"
      >
        {label}
      </text>
      <text
        x={ts / 2}
        y={ts / 2 + 12}
        textAnchor="middle"
        fill="#5a5068"
        fontSize="9"
      >
        南インド式
      </text>
    </svg>
  );
}

const SS2 = 400,
  HH2 = SS2 / 2,
  QQ2 = SS2 / 4;
const NH2 = {
  1: {
    p: [
      [HH2, 0],
      [HH2 + QQ2, QQ2],
      [HH2, HH2],
      [HH2 - QQ2, QQ2],
    ],
  },
  2: {
    p: [
      [0, 0],
      [HH2, 0],
      [HH2 - QQ2, QQ2],
    ],
  },
  3: {
    p: [
      [0, 0],
      [0, HH2],
      [HH2 - QQ2, QQ2],
    ],
  },
  4: {
    p: [
      [0, HH2],
      [HH2 - QQ2, QQ2],
      [HH2, HH2],
      [HH2 - QQ2, HH2 + QQ2],
    ],
  },
  5: {
    p: [
      [0, HH2],
      [0, SS2],
      [HH2 - QQ2, HH2 + QQ2],
    ],
  },
  6: {
    p: [
      [0, SS2],
      [HH2, SS2],
      [HH2 - QQ2, HH2 + QQ2],
    ],
  },
  7: {
    p: [
      [HH2, SS2],
      [HH2 - QQ2, HH2 + QQ2],
      [HH2, HH2],
      [HH2 + QQ2, HH2 + QQ2],
    ],
  },
  8: {
    p: [
      [HH2, SS2],
      [SS2, SS2],
      [HH2 + QQ2, HH2 + QQ2],
    ],
  },
  9: {
    p: [
      [SS2, SS2],
      [SS2, HH2],
      [HH2 + QQ2, HH2 + QQ2],
    ],
  },
  10: {
    p: [
      [SS2, HH2],
      [HH2 + QQ2, HH2 + QQ2],
      [HH2, HH2],
      [HH2 + QQ2, QQ2],
    ],
  },
  11: {
    p: [
      [SS2, HH2],
      [SS2, 0],
      [HH2 + QQ2, QQ2],
    ],
  },
  12: {
    p: [
      [SS2, 0],
      [HH2, 0],
      [HH2 + QQ2, QQ2],
    ],
  },
};
const NSP2 = {
  1: { x: HH2, y: 32, a: "middle" },
  2: { x: 28, y: 26, a: "start" },
  3: { x: 14, y: 46, a: "start" },
  4: { x: 18, y: HH2 + 10, a: "start" },
  5: { x: 14, y: SS2 - 34, a: "start" },
  6: { x: 28, y: SS2 - 16, a: "start" },
  7: { x: HH2, y: SS2 - 18, a: "middle" },
  8: { x: SS2 - 28, y: SS2 - 16, a: "end" },
  9: { x: SS2 - 14, y: SS2 - 34, a: "end" },
  10: { x: SS2 - 18, y: HH2 + 10, a: "end" },
  11: { x: SS2 - 14, y: 46, a: "end" },
  12: { x: SS2 - 28, y: 26, a: "end" },
};
function NCh({ pl, ascSign, kMap, label, onSignTap }) {
  const am = cA(pl),
    sF = (h) => ((ascSign - 1 + h - 1) % 12) + 1;
  const getP = (h) => {
    const s = sF(h);
    return Object.entries(pl)
      .filter(([, v]) => v.sign === s)
      .map(([k]) => PL.find((p) => p.id === k));
  };
  return (
    <svg
      viewBox={`-10 -10 ${SS2 + 20} ${SS2 + 20}`}
      width="100%"
      style={{ maxWidth: 440 }}
    >
      <rect
        x="-10"
        y="-10"
        width={SS2 + 20}
        height={SS2 + 20}
        rx="8"
        fill="#08060c"
      />
      {Object.entries(NH2).map(([hs, { p: poly }]) => {
        const house = parseInt(hs),
          sign = sF(house),
          planets = getP(house),
          isA = house === 1;
        const pts = poly.map((pp) => pp.join(",")).join(" "),
          asp = am[sF(house)] || [];
        const cx = poly.reduce((s, pp) => s + pp[0], 0) / poly.length,
          cy = poly.reduce((s, pp) => s + pp[1], 0) / poly.length;
        const sp = NSP2[house],
          by = planets.length > 0 ? pgB2(planets.length, cy - 4, 24) : cy + 8,
          dx = cx - ((Math.min(asp.length, 4) - 1) * 7) / 2;
        return (
          <g
            key={house}
            onClick={() => onSignTap && onSignTap(sign)}
            style={{ cursor: onSignTap ? "pointer" : "default" }}
          >
            <polygon
              points={pts}
              fill={isA ? "#1a1510" : "#0f0d14"}
              stroke={isA ? "#e8b04a" : "#2a2535"}
              strokeWidth={isA ? 1.5 : 0.7}
            />
            <text
              x={sp.x}
              y={sp.y}
              textAnchor={sp.a}
              fill={isA ? NCA : NC}
              fontSize="12"
              fontWeight="600"
              fontFamily="'JetBrains Mono',monospace"
            >
              {sign}
            </text>
            <PG
              planets={planets}
              pl={pl}
              kMap={kMap}
              cx={cx}
              cy={cy - 4}
              cs={28}
              rs={24}
            />
            <AD2 dots={asp} x={dx} y={by} max={5} />
          </g>
        );
      })}
      <text
        x={HH2}
        y={HH2 - 4}
        textAnchor="middle"
        fill="#4a4058"
        fontSize="11"
      >
        {label}
      </text>
      <text
        x={HH2}
        y={HH2 + 12}
        textAnchor="middle"
        fill="#5a5068"
        fontSize="9"
      >
        北インド式
      </text>
    </svg>
  );
}

// Overlay chart for special items
function OvCh({ items, ascSign, label, sub, style: st }) {
  const cs = 105,
    g = 2,
    ts = cs * 4 + g * 5;
  const hN = (s) => ((s - ascSign + 12) % 12) + 1;
  const byS = {};
  items.forEach((it) => {
    if (!byS[it.sign]) byS[it.sign] = [];
    byS[it.sign].push(it);
  });
  return (
    <svg viewBox={`0 0 ${ts} ${ts}`} width="100%" style={{ maxWidth: 440 }}>
      <defs>
        <linearGradient id="cg2" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stopColor="#1a1520" />
          <stop offset="100%" stopColor="#0f0d14" />
        </linearGradient>
        <linearGradient id="ag2" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stopColor="#2a1f10" />
          <stop offset="100%" stopColor="#1a1510" />
        </linearGradient>
      </defs>
      <rect width={ts} height={ts} rx="8" fill="#08060c" />
      {Object.entries(SG).map(([ss, [col, row]]) => {
        const sid = parseInt(ss),
          hn = hN(sid),
          isA = hn === 1;
        const x = g + col * (cs + g),
          y = g + row * (cs + g);
        const grp = byS[sid] || [];
        const cols2 = Math.min(grp.length, 3),
          rows2 = Math.ceil(grp.length / cols2 || 1);
        return (
          <g key={sid}>
            <rect
              x={x}
              y={y}
              width={cs}
              height={cs}
              rx="4"
              fill={isA ? "url(#ag2)" : "url(#cg2)"}
              stroke={isA ? "#e8b04a" : "#2a2535"}
              strokeWidth={isA ? 1.5 : 0.5}
            />
            <text
              x={x + cs - 7}
              y={y + cs - 7}
              textAnchor="end"
              fill={isA ? NCA : NC}
              fontSize="11"
              fontFamily="'JetBrains Mono',monospace"
            >
              {hn}
            </text>
            {grp.map((it, i) => {
              const ri = Math.floor(i / cols2),
                ci = i % cols2,
                cr = ri < rows2 - 1 ? cols2 : grp.length - ri * cols2;
              const px = x + cs / 2 - ((cr - 1) * 30) / 2 + ci * 30,
                py = y + cs / 2 - ((rows2 - 1) * 22) / 2 + ri * 22;
              return (
                <g key={it.id}>
                  <text
                    x={px}
                    y={py}
                    textAnchor="middle"
                    fill={it.warn ? "#e05555" : it.color}
                    fontSize="12"
                    fontWeight="700"
                    fontFamily="'JetBrains Mono',monospace"
                  >
                    {it.id}
                  </text>
                  {it.deg !== undefined && (
                    <text
                      x={px}
                      y={py + 10}
                      textAnchor="middle"
                      fill={it.warn ? "#e0555580" : it.color + "70"}
                      fontSize="7"
                    >
                      {fD(it.deg)}
                    </text>
                  )}
                </g>
              );
            })}
          </g>
        );
      })}
      <rect
        x={g + cs + g}
        y={g + cs + g}
        width={cs * 2 + g}
        height={cs * 2 + g}
        rx="4"
        fill="#0a0810"
        stroke="#1a1520"
        strokeWidth="0.5"
      />
      <text
        x={ts / 2}
        y={ts / 2 - 4}
        textAnchor="middle"
        fill="#4a4058"
        fontSize="11"
      >
        {label}
      </text>
      {sub && (
        <text
          x={ts / 2}
          y={ts / 2 + 12}
          textAnchor="middle"
          fill="#5a5068"
          fontSize="9"
        >
          {sub}
        </text>
      )}
    </svg>
  );
}

// SAV Chart
function SAVCh({ sav, ascSign }) {
  const cs = 105,
    g = 2,
    ts = cs * 4 + g * 5;
  const hN = (s) => ((s - ascSign + 12) % 12) + 1;
  return (
    <svg viewBox={`0 0 ${ts} ${ts}`} width="100%" style={{ maxWidth: 440 }}>
      <rect width={ts} height={ts} rx="8" fill="#08060c" />
      {Object.entries(SG).map(([ss, [col, row]]) => {
        const sid = parseInt(ss),
          x = g + col * (cs + g),
          y = g + row * (cs + g),
          isA = hN(sid) === 1,
          val = sav[sid - 1];
        const color =
          val >= 30
            ? "#5cb85c"
            : val >= 25
            ? "#c8c0d0"
            : val >= 20
            ? "#7888a0"
            : "#e05555";
        return (
          <g key={sid}>
            <rect
              x={x}
              y={y}
              width={cs}
              height={cs}
              rx="4"
              fill={isA ? "#1a1510" : "#0f0d14"}
              stroke={isA ? "#e8b04a" : "#2a2535"}
              strokeWidth={isA ? 1.5 : 0.5}
            />
            <text
              x={x + cs / 2}
              y={y + cs / 2 + 6}
              textAnchor="middle"
              fill={color}
              fontSize="24"
              fontWeight="700"
              fontFamily="'JetBrains Mono',monospace"
            >
              {val}
            </text>
            <text
              x={x + cs - 7}
              y={y + cs - 7}
              textAnchor="end"
              fill={isA ? NCA : NC}
              fontSize="10"
              fontFamily="'JetBrains Mono',monospace"
            >
              {SGN[sid - 1].ab}
            </text>
          </g>
        );
      })}
      <rect
        x={g + cs + g}
        y={g + cs + g}
        width={cs * 2 + g}
        height={cs * 2 + g}
        rx="4"
        fill="#0a0810"
        stroke="#1a1520"
        strokeWidth="0.5"
      />
      <text
        x={ts / 2}
        y={ts / 2 - 4}
        textAnchor="middle"
        fill="#4a4058"
        fontSize="11"
      >
        SAV
      </text>
      <text
        x={ts / 2}
        y={ts / 2 + 12}
        textAnchor="middle"
        fill="#5a5068"
        fontSize="9"
      >
        合計値
      </text>
    </svg>
  );
}

// Table
function PTb({ pl, kMap, fn }) {
  return (
    <div style={{ overflowX: "auto" }}>
      <table
        style={{
          width: "100%",
          borderCollapse: "collapse",
          fontSize: "11px",
          fontFamily: "'Noto Sans','JetBrains Mono',monospace",
        }}
      >
        <thead>
          <tr style={{ borderBottom: "1px solid #2a2535" }}>
            {["惑星", "", "座", "度数", "Nak", "R", "K", "機", "Dig", "MG"].map(
              (h) => (
                <th
                  key={h}
                  style={{
                    padding: "7px 3px",
                    textAlign: "left",
                    color: "#5a5068",
                    fontWeight: 500,
                    fontSize: "8px",
                  }}
                >
                  {h}
                </th>
              )
            )}
          </tr>
        </thead>
        <tbody>
          {PL.map((p) => {
            const d = pl[p.id],
              s = SGN[d.sign - 1],
              k = kMap[p.id] || "—",
              f = fnL(fn[p.id]),
              mg = [chkMB(p.id, d.sign, d.deg), chkG(d.sign, d.deg)]
                .filter(Boolean)
                .join(" "),
              dig = getDig(p.id, d.sign, d.deg);
            return (
              <tr key={p.id} style={{ borderBottom: "1px solid #1a1520" }}>
                <td
                  style={{
                    padding: "5px 3px",
                    color: p.color,
                    fontWeight: 600,
                    fontSize: "10px",
                  }}
                >
                  {p.jp}
                </td>
                <td
                  style={{ padding: "5px 3px", color: p.color, opacity: 0.7 }}
                >
                  {pLb(p.id, pl)}
                </td>
                <td style={{ padding: "5px 3px", color: "#c8c0d0" }}>{s.ab}</td>
                <td style={{ padding: "5px 3px", color: "#a098b0" }}>
                  {fD(d.deg)}
                </td>
                <td
                  style={{
                    padding: "5px 3px",
                    color: "#8078a0",
                    fontSize: "9px",
                  }}
                >
                  {gNak(d.sign, d.deg)}
                </td>
                <td
                  style={{
                    padding: "5px 3px",
                    color: d.retro ? "#e05555" : "#2a2535",
                  }}
                >
                  {d.retro ? "R" : "—"}
                </td>
                <td
                  style={{
                    padding: "5px 3px",
                    color: "#8a80a0",
                    fontWeight: 600,
                    fontSize: "9px",
                  }}
                >
                  {k}
                </td>
                <td
                  style={{
                    padding: "5px 3px",
                    color: f.c,
                    fontWeight: 600,
                    fontSize: "9px",
                  }}
                >
                  {f.t}
                </td>
                <td
                  style={{
                    padding: "5px 3px",
                    color: dig.c,
                    fontWeight: 700,
                    fontSize: "9px",
                  }}
                >
                  {dig.t}
                </td>
                <td
                  style={{
                    padding: "5px 3px",
                    color: mg ? "#e05555" : "#2a2535",
                    fontWeight: 700,
                    fontSize: "9px",
                  }}
                >
                  {mg || "—"}
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
}

// ===== DASHA ENGINE =====
const VO = ["Ke", "Ve", "Su", "Mo", "Ma", "Ra", "Ju", "Sa", "Me"];
const VY = {
  Ke: 7,
  Ve: 20,
  Su: 6,
  Mo: 10,
  Ma: 7,
  Ra: 18,
  Ju: 16,
  Sa: 19,
  Me: 17,
};
const NL = [
  "Ke",
  "Ve",
  "Su",
  "Mo",
  "Ma",
  "Ra",
  "Ju",
  "Sa",
  "Me",
  "Ke",
  "Ve",
  "Su",
  "Mo",
  "Ma",
  "Ra",
  "Ju",
  "Sa",
  "Me",
  "Ke",
  "Ve",
  "Su",
  "Mo",
  "Ma",
  "Ra",
  "Ju",
  "Sa",
  "Me",
];
const YOG = [
  { n: "Mangala", l: "Mo", y: 1 },
  { n: "Pingala", l: "Su", y: 2 },
  { n: "Dhanya", l: "Ju", y: 3 },
  { n: "Bhramari", l: "Ma", y: 4 },
  { n: "Bhadrika", l: "Me", y: 5 },
  { n: "Ulka", l: "Sa", y: 6 },
  { n: "Siddha", l: "Ve", y: 7 },
  { n: "Sankata", l: "Ra", y: 8 },
];
const D365 = 365.25 * 86400000;

function fDt(d) {
  if (!d) return "";
  return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(
    2,
    "0"
  )}/${String(d.getDate()).padStart(2, "0")}`;
}
function isNow(s, e) {
  const n = new Date();
  return n >= s && n <= e;
}
function addY(d, y) {
  return new Date(d.getTime() + y * D365);
}
function pCol(pid) {
  return PL.find((p) => p.id === pid)?.color || "#7888a0";
}

// Vimshottari - generic sub-level generator
function vimSubs(startIdx, years, startDate, level) {
  if (level > 4) return [];
  const subs = [];
  let cur = new Date(startDate);
  for (let j = 0; j < 9; j++) {
    const aidx = (startIdx + j) % 9;
    const lord = VO[aidx];
    const subY = (years * VY[lord]) / 120;
    const start = new Date(cur);
    cur = addY(cur, subY);
    subs.push({ lord, start, end: new Date(cur), years: subY, idx: aidx });
  }
  return subs;
}

function computeVim(pl, bd) {
  const mL = (pl.Mo.sign - 1) * 30 + pl.Mo.deg;
  const ni = Math.floor(mL / (360 / 27));
  const nf = (mL % (360 / 27)) / (360 / 27);
  const si = VO.indexOf(NL[ni]);
  const bal = (1 - nf) * VY[NL[ni]];
  const periods = [];
  let cur = new Date(bd);
  for (let i = 0; i < 9; i++) {
    const idx = (si + i) % 9;
    const lord = VO[idx];
    const y = i === 0 ? bal : VY[lord];
    const start = new Date(cur);
    cur = addY(cur, y);
    periods.push({ lord, start, end: new Date(cur), years: y, idx });
  }
  return periods;
}

// Yogini - with sub-levels
function yogSubs(startIdx, years, startDate) {
  const subs = [];
  let cur = new Date(startDate);
  const total = YOG.reduce((s, y) => s + y.y, 0);
  for (let j = 0; j < 8; j++) {
    const aidx = (startIdx + j) % 8;
    const y = YOG[aidx];
    const subY = (years * y.y) / total;
    const start = new Date(cur);
    cur = addY(cur, subY);
    subs.push({
      lord: y.l,
      name: y.n,
      start,
      end: new Date(cur),
      years: subY,
      idx: aidx,
    });
  }
  return subs;
}

function computeYog(pl, bd) {
  const mL = (pl.Mo.sign - 1) * 30 + pl.Mo.deg;
  const ni = Math.floor(mL / (360 / 27));
  const nf = (mL % (360 / 27)) / (360 / 27);
  const yi = (ni + 3) % 8;
  const bal = (1 - nf) * YOG[yi].y;
  const periods = [];
  let cur = new Date(bd);
  for (let i = 0; i < 8; i++) {
    const idx = (yi + i) % 8;
    const y = YOG[idx];
    const yrs = i === 0 ? bal : y.y;
    const start = new Date(cur);
    cur = addY(cur, yrs);
    periods.push({
      lord: y.l,
      name: y.n,
      start,
      end: new Date(cur),
      years: yrs,
      idx,
    });
  }
  return periods;
}

// KN Rao Chara Dasha
function charaLord(sign, pl) {
  // Scorpio: Ma primary, Ke secondary
  if (sign === 8) {
    if (pl.Ma.sign === 8 && pl.Ke.sign === 8) return "Ma";
    if (pl.Ma.sign === 8) return "Ke";
    return "Ma";
  }
  // Aquarius: Sa primary, Ra secondary
  if (sign === 11) {
    if (pl.Sa.sign === 11 && pl.Ra.sign === 11) return "Sa";
    if (pl.Sa.sign === 11) return "Ra";
    return "Sa";
  }
  return SR[sign];
}

function charaDist(sign, lordSign, isOdd) {
  let dist;
  if (isOdd) dist = (lordSign - sign + 12) % 12;
  else dist = (sign - lordSign + 12) % 12;
  if (dist === 0) dist = 12;
  return dist;
}

function computeCharaKN(pl, ascSign) {
  const isOddAsc = ascSign % 2 === 1;
  const signs = [];
  for (let i = 0; i < 12; i++) {
    signs.push(
      isOddAsc
        ? ((ascSign - 1 + i) % 12) + 1
        : ((ascSign - 1 - i + 120) % 12) + 1
    );
  }
  return signs.map((sign) => {
    const lord = charaLord(sign, pl);
    const ls = pl[lord]?.sign || sign;
    const isOdd = sign % 2 === 1;
    const years = charaDist(sign, ls, isOdd);
    return { sign, lord, years, label: SGN[sign - 1].ab };
  });
}

// Sign-based sub-levels (Chara/Nav/Mandook)
function signSubs(parentSign, parentYears, startDate, allPeriods) {
  const subs = [];
  let cur = new Date(startDate);
  const total = allPeriods.reduce((s, p) => s + p.years, 0);
  const isOdd = parentSign % 2 === 1;
  const ordered = [];
  for (let i = 0; i < 12; i++) {
    ordered.push(
      isOdd
        ? ((parentSign - 1 + i) % 12) + 1
        : ((parentSign - 1 - i + 120) % 12) + 1
    );
  }
  ordered.forEach((sign) => {
    const match = allPeriods.find((p) => p.sign === sign);
    const subY = (parentYears * (match?.years || 1)) / total;
    const start = new Date(cur);
    cur = addY(cur, subY);
    subs.push({
      sign,
      lord: match?.lord || SR[sign],
      years: subY,
      label: SGN[sign - 1].ab,
      start,
      end: new Date(cur),
    });
  });
  return subs;
}

// Nav Dasha
function computeNavD(pl) {
  const np = cV(pl, "D9");
  return computeCharaKN(np, np.As.sign);
}

// Mandook KN Rao
function computeMandKN(pl, ascSign) {
  const order = [];
  let s = ascSign;
  for (let i = 0; i < 6; i++) {
    order.push(s);
    s = ((s - 1 + 2) % 12) + 1;
  }
  s = (ascSign % 12) + 1;
  for (let i = 0; i < 6; i++) {
    order.push(s);
    s = ((s - 1 + 2) % 12) + 1;
  }
  return order.map((sign) => {
    const lord = charaLord(sign, pl);
    const ls = pl[lord]?.sign || sign;
    const isOdd = sign % 2 === 1;
    const years = charaDist(sign, ls, isOdd);
    return { sign, lord, years, label: SGN[sign - 1].ab };
  });
}

// ===== DASHA UI =====
const DT = [
  { id: "vim", l: "Vim", f: "ヴィムショッタリー" },
  { id: "yog", l: "Yog", f: "ヨーギニー" },
  { id: "chara", l: "Chara(KN)", f: "チャラ KNラオ" },
  { id: "nav", l: "Nav", f: "ナヴァムシャ" },
  { id: "mand", l: "Mand(KN)", f: "マンドゥーク KNラオ" },
];

function DashaPanel({ placements: pl, birthDate: bd, ascSign }) {
  const [dt, setDt] = useState("vim");
  const [exp, setExp] = useState({});
  const toggle = (key) => setExp((prev) => ({ ...prev, [key]: !prev[key] }));
  const vim = computeVim(pl, bd);
  const yog = computeYog(pl, bd);
  const chara = computeCharaKN(pl, ascSign);
  const nav = computeNavD(pl);
  const mand = computeMandKN(pl, ascSign);

  function addDates(periods, bd2) {
    let cur = new Date(bd2);
    return periods.map((p) => {
      const start = new Date(cur);
      cur = addY(cur, p.years);
      return { ...p, start, end: new Date(cur) };
    });
  }
  const charaD = addDates(chara, bd);
  const navD = addDates(nav, bd);
  const mandD = addDates(mand, bd);

  // Row component
  function Row({
    lord,
    label,
    years,
    start,
    end,
    indent,
    sign,
    isSign,
    children,
    rkey,
  }) {
    const cur = isNow(start, end);
    const hasKids = !!children;
    return (
      <div style={{ marginLeft: indent || 0 }}>
        <button
          onClick={() => hasKids && toggle(rkey)}
          style={{
            width: "100%",
            display: "flex",
            justifyContent: "space-between",
            alignItems: "center",
            padding: `${indent > 30 ? "4px" : "8px"} ${
              indent > 30 ? "6px" : "10px"
            }`,
            border: "none",
            cursor: hasKids ? "pointer" : "default",
            textAlign: "left",
            background: cur ? "#1a151080" : "transparent",
            borderLeft:
              cur && indent === 0
                ? "3px solid #e8b04a"
                : "3px solid transparent",
            borderRadius: 2,
            marginBottom: 1,
          }}
        >
          <div
            style={{
              display: "flex",
              alignItems: "center",
              gap: 6,
              minWidth: 0,
            }}
          >
            {isSign ? (
              <span
                style={{
                  color: "#c8c0d0",
                  fontWeight: 700,
                  fontFamily: "'JetBrains Mono',monospace",
                  fontSize: indent > 30 ? "10px" : "13px",
                }}
              >
                {label}
              </span>
            ) : (
              <span
                style={{
                  color: pCol(lord),
                  fontWeight: 700,
                  fontFamily: "'JetBrains Mono',monospace",
                  fontSize: indent > 30 ? "10px" : "13px",
                  minWidth: 18,
                }}
              >
                {lord}
              </span>
            )}
            {sign && (
              <span style={{ color: pCol(lord), fontSize: "9px" }}>{lord}</span>
            )}
            <span
              style={{
                color: "#4a4058",
                fontSize: indent > 30 ? "8px" : "9px",
              }}
            >
              {years < 1
                ? (years * 12).toFixed(1) + "m"
                : years.toFixed(1) + "y"}
            </span>
            {cur && (
              <span
                style={{
                  color: "#e8b04a",
                  fontSize: "7px",
                  fontWeight: 700,
                  padding: "1px 4px",
                  background: "#e8b04a20",
                  borderRadius: 3,
                }}
              >
                {indent === 0 ? "NOW" : "●"}
              </span>
            )}
            {hasKids && (
              <span style={{ color: "#3a3048", fontSize: "8px" }}>
                {exp[rkey] ? "▾" : "▸"}
              </span>
            )}
          </div>
          <span
            style={{
              fontSize: indent > 30 ? "8px" : "9px",
              color: "#4a4058",
              fontFamily: "'JetBrains Mono',monospace",
              flexShrink: 0,
            }}
          >
            {fDt(start)}-{fDt(end)}
          </span>
        </button>
        {hasKids && exp[rkey] && children}
      </div>
    );
  }

  return (
    <div>
      <div
        style={{
          display: "flex",
          gap: 3,
          overflowX: "auto",
          padding: "4px 0 12px",
          WebkitOverflowScrolling: "touch",
        }}
      >
        {DT.map((t) => (
          <button
            key={t.id}
            onClick={() => {
              setDt(t.id);
              setExp({});
            }}
            style={{
              padding: "5px 8px",
              border: "none",
              borderRadius: 4,
              cursor: "pointer",
              flexShrink: 0,
              background: dt === t.id ? "#1a1520" : "transparent",
              color: dt === t.id ? "#e8b04a" : "#4a4058",
              fontSize: "9px",
              fontWeight: dt === t.id ? 700 : 400,
              fontFamily: "'JetBrains Mono',monospace",
              whiteSpace: "nowrap",
            }}
          >
            {t.l}
          </button>
        ))}
      </div>
      <div
        style={{
          fontSize: "9px",
          color: "#5a5068",
          padding: "0 0 6px",
          fontWeight: 600,
        }}
      >
        {DT.find((t) => t.id === dt)?.f} — 第4レベルまで展開可
      </div>

      {/* Vimshottari 4 levels */}
      {dt === "vim" &&
        vim.map((md, mi) => (
          <Row
            key={mi}
            rkey={`v${mi}`}
            lord={md.lord}
            years={md.years}
            start={md.start}
            end={md.end}
            indent={0}
            children={
              <div style={{ borderLeft: "1px solid #1a1520", marginLeft: 12 }}>
                {vimSubs(md.idx, md.years, md.start, 2).map((ad, ai) => (
                  <Row
                    key={ai}
                    rkey={`v${mi}-${ai}`}
                    lord={ad.lord}
                    years={ad.years}
                    start={ad.start}
                    end={ad.end}
                    indent={10}
                    children={
                      <div
                        style={{
                          borderLeft: "1px solid #1a1520",
                          marginLeft: 12,
                        }}
                      >
                        {vimSubs(ad.idx, ad.years, ad.start, 3).map(
                          (pd, pi) => (
                            <Row
                              key={pi}
                              rkey={`v${mi}-${ai}-${pi}`}
                              lord={pd.lord}
                              years={pd.years}
                              start={pd.start}
                              end={pd.end}
                              indent={20}
                              children={
                                <div
                                  style={{
                                    borderLeft: "1px solid #14121c",
                                    marginLeft: 10,
                                  }}
                                >
                                  {vimSubs(pd.idx, pd.years, pd.start, 4).map(
                                    (sd, si) => (
                                      <Row
                                        key={si}
                                        rkey={`v${mi}-${ai}-${pi}-${si}`}
                                        lord={sd.lord}
                                        years={sd.years}
                                        start={sd.start}
                                        end={sd.end}
                                        indent={30}
                                      />
                                    )
                                  )}
                                </div>
                              }
                            />
                          )
                        )}
                      </div>
                    }
                  />
                ))}
              </div>
            }
          />
        ))}

      {/* Yogini 4 levels */}
      {dt === "yog" &&
        yog.map((md, mi) => (
          <Row
            key={mi}
            rkey={`y${mi}`}
            lord={md.lord}
            label={md.name}
            years={md.years}
            start={md.start}
            end={md.end}
            indent={0}
            children={
              <div style={{ borderLeft: "1px solid #1a1520", marginLeft: 12 }}>
                {yogSubs(md.idx, md.years, md.start).map((ad, ai) => (
                  <Row
                    key={ai}
                    rkey={`y${mi}-${ai}`}
                    lord={ad.lord}
                    label={ad.name}
                    years={ad.years}
                    start={ad.start}
                    end={ad.end}
                    indent={10}
                    children={
                      <div
                        style={{
                          borderLeft: "1px solid #1a1520",
                          marginLeft: 12,
                        }}
                      >
                        {yogSubs(ad.idx, ad.years, ad.start).map((pd, pi) => (
                          <Row
                            key={pi}
                            rkey={`y${mi}-${ai}-${pi}`}
                            lord={pd.lord}
                            label={pd.name}
                            years={pd.years}
                            start={pd.start}
                            end={pd.end}
                            indent={20}
                            children={
                              <div
                                style={{
                                  borderLeft: "1px solid #14121c",
                                  marginLeft: 10,
                                }}
                              >
                                {yogSubs(pd.idx, pd.years, pd.start).map(
                                  (sd, si) => (
                                    <Row
                                      key={si}
                                      rkey={`y${mi}-${ai}-${pi}-${si}`}
                                      lord={sd.lord}
                                      years={sd.years}
                                      start={sd.start}
                                      end={sd.end}
                                      indent={30}
                                    />
                                  )
                                )}
                              </div>
                            }
                          />
                        ))}
                      </div>
                    }
                  />
                ))}
              </div>
            }
          />
        ))}

      {/* Sign-based dashas: Chara/Nav/Mandook with 4 levels */}
      {(dt === "chara" || dt === "nav" || dt === "mand") &&
        (() => {
          const data = dt === "chara" ? charaD : dt === "nav" ? navD : mandD;
          const allP = dt === "chara" ? chara : dt === "nav" ? nav : mand;
          return data.map((md, mi) => (
            <Row
              key={mi}
              rkey={`s${mi}`}
              label={md.label}
              lord={md.lord}
              years={md.years}
              start={md.start}
              end={md.end}
              indent={0}
              isSign
              children={
                <div
                  style={{ borderLeft: "1px solid #1a1520", marginLeft: 12 }}
                >
                  {signSubs(md.sign, md.years, md.start, allP).map((ad, ai) => (
                    <Row
                      key={ai}
                      rkey={`s${mi}-${ai}`}
                      label={ad.label}
                      lord={ad.lord}
                      years={ad.years}
                      start={ad.start}
                      end={ad.end}
                      indent={10}
                      isSign
                      children={
                        <div
                          style={{
                            borderLeft: "1px solid #1a1520",
                            marginLeft: 12,
                          }}
                        >
                          {signSubs(ad.sign, ad.years, ad.start, allP).map(
                            (pd, pi) => (
                              <Row
                                key={pi}
                                rkey={`s${mi}-${ai}-${pi}`}
                                label={pd.label}
                                lord={pd.lord}
                                years={pd.years}
                                start={pd.start}
                                end={pd.end}
                                indent={20}
                                isSign
                                children={
                                  <div
                                    style={{
                                      borderLeft: "1px solid #14121c",
                                      marginLeft: 10,
                                    }}
                                  >
                                    {signSubs(
                                      pd.sign,
                                      pd.years,
                                      pd.start,
                                      allP
                                    ).map((sd, si) => (
                                      <Row
                                        key={si}
                                        rkey={`s${mi}-${ai}-${pi}-${si}`}
                                        label={sd.label}
                                        lord={sd.lord}
                                        years={sd.years}
                                        start={sd.start}
                                        end={sd.end}
                                        indent={30}
                                        isSign
                                      />
                                    ))}
                                  </div>
                                }
                              />
                            )
                          )}
                        </div>
                      }
                    />
                  ))}
                </div>
              }
            />
          ));
        })()}
    </div>
  );
}

// ===== YOGA ENGINE =====
const EXA = { Su: 1, Mo: 2, Ma: 10, Me: 6, Ju: 4, Ve: 12, Sa: 7 }; // exaltation signs
const DEB = { Su: 7, Mo: 8, Ma: 4, Me: 12, Ju: 10, Ve: 6, Sa: 1 }; // debilitation signs
const OWN = {
  Su: [5],
  Mo: [4],
  Ma: [1, 8],
  Me: [3, 6],
  Ju: [9, 12],
  Ve: [2, 7],
  Sa: [10, 11],
};
const MT2 = {
  Su: { s: 5, f: 0, t: 20 },
  Mo: { s: 2, f: 0, t: 3 },
  Ma: { s: 1, f: 0, t: 12 },
  Me: { s: 6, f: 16, t: 20 },
  Ju: { s: 9, f: 0, t: 5 },
  Ve: { s: 12, f: 0, t: 15 },
  Sa: { s: 11, f: 0, t: 20 },
}; // moolatrikona
const BEN = ["Me", "Ju", "Ve"];
const MAL = ["Su", "Ma", "Sa", "Ra", "Ke"];
function getDig(pid, sign, deg) {
  if (!EXA[pid]) return { t: "—", c: "#2a2535" };
  if (EXA[pid] === sign) return { t: "Ex", c: "#5cb85c" };
  if (DEB[pid] === sign) return { t: "Db", c: "#e05555" };
  const mt = MT2[pid];
  if (mt && mt.s === sign && deg >= mt.f && deg <= mt.t)
    return { t: "MT", c: "#e8b04a" };
  if (OWN[pid]?.includes(sign)) return { t: "Sw", c: "#40a0e0" };
  // Friend/enemy simplified
  return { t: "—", c: "#2a2535" };
}

function hOf(pid, pl, asc) {
  return ((pl[pid].sign - asc + 12) % 12) + 1;
}
function sameSign(a, b, pl) {
  return pl[a]?.sign === pl[b]?.sign;
}
function inKendra(h) {
  return [1, 4, 7, 10].includes(h);
}
function inTrine(h) {
  return [1, 5, 9].includes(h);
}
function inDusthana(h) {
  return [6, 8, 12].includes(h);
}
function lordOf(h, asc) {
  return SR[((asc - 1 + h - 1) % 12) + 1];
}
function isOwn(pid, sign) {
  return OWN[pid]?.includes(sign);
}
function isExalted(pid, sign) {
  return EXA[pid] === sign;
}

function detectYogas(pl, ascSign, lang) {
  const Y = [];
  const jp = lang === "jp";
  const h = (pid) => hOf(pid, pl, ascSign);
  const ps = ["Su", "Mo", "Ma", "Me", "Ju", "Ve", "Sa"];

  // --- RAJA YOGA: Trine lord + Kendra lord conjunction ---
  const triH = [1, 5, 9],
    kenH = [1, 4, 7, 10];
  const triL = triH.map((hh) => lordOf(hh, ascSign));
  const kenL = kenH.map((hh) => lordOf(hh, ascSign));
  for (const tl of [...new Set(triL)]) {
    for (const kl of [...new Set(kenL)]) {
      if (tl !== kl && sameSign(tl, kl, pl)) {
        Y.push({
          type: "+",
          cat: jp ? "ラージャ" : "Raja",
          planets: [tl, kl],
          desc: jp
            ? `${tl}(トリコーナ主)+${kl}(ケンドラ主) 同居→王のヨーガ。権力・地位・成功。`
            : `${tl}(trine lord)+${kl}(kendra lord) conjunct. Power, status, success.`,
        });
      }
    }
  }

  // --- DHANA YOGA: 2nd/11th lord with trine/kendra lords ---
  const dL = [lordOf(2, ascSign), lordOf(11, ascSign)];
  for (const dl of [...new Set(dL)]) {
    for (const tl of [...new Set([...triL, ...kenL])]) {
      if (dl !== tl && sameSign(dl, tl, pl)) {
        Y.push({
          type: "+",
          cat: jp ? "ダナ" : "Dhana",
          planets: [dl, tl],
          desc: jp
            ? `${dl}(財の支配星)+${tl} 同居→富のヨーガ。財産・収入の増大。`
            : `${dl}(wealth lord)+${tl} conjunct. Wealth, financial prosperity.`,
        });
      }
    }
  }

  // --- GAJAKESARI: Ju in kendra from Mo ---
  {
    const jh = ((pl.Ju.sign - pl.Mo.sign + 12) % 12) + 1;
    if ([1, 4, 7, 10].includes(jh)) {
      Y.push({
        type: "+",
        cat: jp ? "ガジャケーサリー" : "Gajakesari",
        planets: ["Ju", "Mo"],
        desc: jp
          ? "木星が月からケンドラ→知恵・名声・幸福のヨーガ。"
          : "Jupiter in kendra from Moon. Fame, wisdom, prosperity.",
      });
    }
  }

  // --- CHANDRA MANGALA: Mo-Ma conjunction ---
  if (sameSign("Mo", "Ma", pl)) {
    Y.push({
      type: "+",
      cat: jp ? "チャンドラマンガラ" : "Chandra Mangala",
      planets: ["Mo", "Ma"],
      desc: jp
        ? "月と火星の同居→富を得る力。事業での成功。"
        : "Moon-Mars conjunction. Earning power, business success.",
    });
  }

  // --- BUDHADITYA: Su-Me conjunction ---
  if (sameSign("Su", "Me", pl)) {
    const hh = h("Su");
    const good = inKendra(hh) || inTrine(hh);
    Y.push({
      type: good ? "+" : "~",
      cat: jp ? "ブッダーディティヤ" : "Budhaditya",
      planets: ["Su", "Me"],
      desc: jp
        ? `太陽+水星 同居（${hh}H）→知性・学問。${
            good ? "ケンドラ/トリコーナで強力。" : "燃焼注意。"
          }`
        : `Sun+Mercury conjunct (H${hh}). Intelligence, learning.${
            good ? " Strong in kendra/trine." : " Combustion may weaken."
          }`,
    });
  }

  // --- PANCHA MAHAPURUSHA ---
  for (const pid of ["Ma", "Me", "Ju", "Ve", "Sa"]) {
    const s = pl[pid].sign;
    const hh = h(pid);
    if (inKendra(hh) && (isOwn(pid, s) || isExalted(pid, s))) {
      const names = {
        Ma: jp ? "ルチャカ" : "Ruchaka",
        Me: jp ? "バドラ" : "Bhadra",
        Ju: jp ? "ハンサ" : "Hamsa",
        Ve: jp ? "マーラヴィヤ" : "Malavya",
        Sa: jp ? "シャシャ" : "Shasha",
      };
      const descs = {
        Ma: jp
          ? "勇気・武力・リーダーシップ"
          : "Courage, leadership, military prowess",
        Me: jp
          ? "知性・商才・コミュニケーション"
          : "Intelligence, commerce, communication",
        Ju: jp
          ? "法・道徳・教養・精神性"
          : "Dharma, morality, spiritual wisdom",
        Ve: jp ? "美・芸術・快適・恋愛" : "Beauty, art, luxury, romance",
        Sa: jp ? "勤勉・忍耐・権威・規律" : "Discipline, patience, authority",
      };
      Y.push({
        type: "+",
        cat: names[pid],
        planets: [pid],
        desc: `${pid} ${
          jp ? "がケンドラで自室/高揚→" : "in own/exalted in kendra. "
        }${descs[pid]}`,
      });
    }
  }

  // --- VIPARITA RAJA: 6/8/12 lords in 6/8/12 ---
  const dustL = [lordOf(6, ascSign), lordOf(8, ascSign), lordOf(12, ascSign)];
  for (const dl of [...new Set(dustL)]) {
    const hh = h(dl);
    if (inDusthana(hh)) {
      Y.push({
        type: "+",
        cat: jp ? "ヴィパリータラージャ" : "Viparita Raja",
        planets: [dl],
        desc: jp
          ? `${dl}(ドゥシュタナ主)が${hh}Hドゥシュタナ在住→逆転の成功。困難が幸運に変わる。`
          : `${dl}(dusthana lord) in H${hh} dusthana. Reversal of fortune, obstacles become advantages.`,
      });
    }
  }

  // --- NEECHABHANGA RAJA ---
  for (const pid of ps) {
    const s = pl[pid].sign;
    if (DEB[pid] === s) {
      const debLord = SR[s];
      const exLord = SR[EXA[pid]];
      const cancel =
        inKendra(h(pid)) ||
        inKendra(h(debLord)) ||
        pl[debLord]?.sign === EXA[debLord];
      if (cancel) {
        Y.push({
          type: "+",
          cat: jp ? "ニーチャバンガ" : "Neechabhanga Raja",
          planets: [pid],
          desc: jp
            ? `${pid}が減衰だが条件により解消→大きな逆転の成功。低い状態からの躍進。`
            : `${pid} debilitated but cancelled. Rise from humble beginnings, great reversal.`,
        });
      } else {
        Y.push({
          type: "-",
          cat: jp ? "ニーチャ（減衰）" : "Neecha",
          planets: [pid],
          desc: jp
            ? `${pid}が${SGN[s - 1].ab}で減衰→弱化。その分野で困難。`
            : `${pid} debilitated in ${
                SGN[s - 1].ab
              }. Weakness in related significations.`,
        });
      }
    }
  }

  // --- PARIVARTANA (Sign Exchange) ---
  for (let i = 0; i < ps.length; i++) {
    for (let j = i + 1; j < ps.length; j++) {
      const a = ps[i],
        b = ps[j];
      const aLords = OWN[a] || [];
      const bLords = OWN[b] || [];
      if (aLords.includes(pl[b].sign) && bLords.includes(pl[a].sign)) {
        const ha = h(a),
          hb = h(b);
        const good =
          (inKendra(ha) || inTrine(ha)) && (inKendra(hb) || inTrine(hb));
        const bad = inDusthana(ha) || inDusthana(hb);
        Y.push({
          type: bad ? "-" : "+",
          cat: jp
            ? "パリヴァルタナ（星座交換）"
            : "Parivartana (Sign Exchange)",
          planets: [a, b],
          desc: jp
            ? `${a}(${SGN[pl[a].sign - 1].ab})↔${b}(${
                SGN[pl[b].sign - 1].ab
              }) 互いの星座を交換→${
                good
                  ? "強力な相互強化。"
                  : bad
                  ? "ドゥシュタナ絡みで問題あり。"
                  : "両惑星が強化される。"
              }`
            : `${a}(${SGN[pl[a].sign - 1].ab})↔${b}(${
                SGN[pl[b].sign - 1].ab
              }) mutual exchange. ${
                good
                  ? "Powerful mutual strengthening."
                  : bad
                  ? "Dusthana involvement, challenges."
                  : "Both planets strengthened."
              }`,
        });
      }
    }
  }

  // --- NAKSHATRA PARIVARTANA (Nak lord exchange) ---
  for (let i = 0; i < ps.length; i++) {
    for (let j = i + 1; j < ps.length; j++) {
      const a = ps[i],
        b = ps[j];
      const aLong = (pl[a].sign - 1) * 30 + pl[a].deg;
      const bLong = (pl[b].sign - 1) * 30 + pl[b].deg;
      const aNakI = Math.floor(aLong / (360 / 27)) % 27;
      const bNakI = Math.floor(bLong / (360 / 27)) % 27;
      const aNakLord = NL[aNakI];
      const bNakLord = NL[bNakI];
      if (aNakLord === b && bNakLord === a) {
        Y.push({
          type: "~",
          cat: jp ? "ナクシャトラ交換" : "Nakshatra Exchange",
          planets: [a, b],
          desc: jp
            ? `${a}が${b}のナクシャトラに、${b}が${a}のナクシャトラに在住→微細なレベルでの惑星交換。エネルギーの相互作用。`
            : `${a} in ${b}'s nakshatra and vice versa. Subtle planetary exchange at star level.`,
        });
      }
    }
  }

  // --- ADHI YOGA: Benefics in 6/7/8 from Moon ---
  {
    const bens = BEN.filter((pid) => {
      const hh = ((pl[pid].sign - pl.Mo.sign + 12) % 12) + 1;
      return [6, 7, 8].includes(hh);
    });
    if (bens.length >= 2) {
      Y.push({
        type: "+",
        cat: jp ? "アディ" : "Adhi",
        planets: ["Mo", ...bens],
        desc: jp
          ? `吉星${bens.join(",")}が月から6/7/8H→指導力・権威・信頼。`
          : `Benefics ${bens.join(
              ","
            )} in 6/7/8 from Moon. Leadership, authority, trust.`,
      });
    }
  }

  // --- KEMADRUMA: No planets in 2/12 from Moon ---
  {
    const around = ps.filter((pid) => {
      if (pid === "Mo") return false;
      const hh = ((pl[pid].sign - pl.Mo.sign + 12) % 12) + 1;
      return hh === 2 || hh === 12;
    });
    if (around.length === 0) {
      Y.push({
        type: "-",
        cat: jp ? "ケーマドルマ" : "Kemadruma",
        planets: ["Mo"],
        desc: jp
          ? "月の前後に惑星なし→孤独・不安定・経済的困難の可能性。"
          : "No planets in 2/12 from Moon. Loneliness, instability, financial challenges.",
      });
    }
  }

  // --- SHAKATA: Ju in 6/8 from Moon ---
  {
    const jmh = ((pl.Ju.sign - pl.Mo.sign + 12) % 12) + 1;
    if (jmh === 6 || jmh === 8) {
      Y.push({
        type: "-",
        cat: jp ? "シャカタ" : "Shakata",
        planets: ["Ju", "Mo"],
        desc: jp
          ? `木星が月から${jmh}H→運勢の浮き沈み。良い時期と悪い時期が交互に来る。`
          : `Jupiter ${jmh}th from Moon. Fluctuating fortune, alternating good and bad periods.`,
      });
    }
  }

  // --- SARASWATI: Ju/Ve/Me in kendra/trine/2H ---
  {
    const goodH = (p) => inKendra(h(p)) || inTrine(h(p)) || h(p) === 2;
    if (goodH("Ju") && goodH("Ve") && goodH("Me")) {
      Y.push({
        type: "+",
        cat: jp ? "サラスヴァティ" : "Saraswati",
        planets: ["Ju", "Ve", "Me"],
        desc: jp
          ? "木星・金星・水星が良い配置→学問・芸術・音楽の才能。弁舌。"
          : "Ju/Ve/Me well-placed. Learning, art, music, eloquence.",
      });
    }
  }

  // --- AMALA: Benefic in 10th from Asc or Moon ---
  {
    for (const ref of [ascSign, pl.Mo.sign]) {
      const benIn10 = BEN.filter(
        (pid) => ((pl[pid].sign - ref + 12) % 12) + 1 === 10
      );
      if (benIn10.length > 0) {
        Y.push({
          type: "+",
          cat: jp ? "アマラ" : "Amala",
          planets: benIn10,
          desc: jp
            ? `${benIn10.join(",")}が10H→清らかな行為。良い評判・道徳的な名声。`
            : `${benIn10.join(
                ","
              )} in 10th. Pure conduct, moral reputation, good fame.`,
        });
        break;
      }
    }
  }

  // --- DARIDRA: Lord of 11 in 6/8/12 ---
  {
    const l11 = lordOf(11, ascSign);
    const hh = h(l11);
    if (inDusthana(hh)) {
      Y.push({
        type: "-",
        cat: jp ? "ダリドラ" : "Daridra",
        planets: [l11],
        desc: jp
          ? `11室主${l11}が${hh}Hドゥシュタナ→収入の困難。財政的な障害。`
          : `11th lord ${l11} in H${hh} dusthana. Income difficulties, financial obstacles.`,
      });
    }
  }

  // --- Arishta: Lagna lord in 6/8/12 ---
  {
    const l1 = lordOf(1, ascSign);
    const hh = h(l1);
    if (inDusthana(hh)) {
      Y.push({
        type: "-",
        cat: jp ? "ラグナアリシュタ" : "Lagna Arishta",
        planets: [l1],
        desc: jp
          ? `ラグナ主${l1}が${hh}Hドゥシュタナ→健康・活力の問題。自己実現の障害。`
          : `Lagna lord ${l1} in H${hh} dusthana. Health, vitality challenges.`,
      });
    }
  }

  // --- Malefics in 1/4/7/10 (Kendras) ---
  {
    const malInKen = MAL.filter((pid) => pl[pid] && inKendra(h(pid)));
    if (malInKen.length >= 3) {
      Y.push({
        type: "-",
        cat: jp ? "ケンドラ凶星集中" : "Malefics in Kendras",
        planets: malInKen,
        desc: jp
          ? `凶星${malInKen.join(
              ","
            )}がケンドラに集中→人生の柱に困難。関係・仕事に問題。`
          : `Malefics ${malInKen.join(
              ","
            )} concentrated in kendras. Challenges in life pillars.`,
      });
    }
  }

  // --- VESHI: Planet in 2nd from Sun ---
  {
    const v2 = ps.filter(
      (pid) => pid !== "Su" && ((pl[pid].sign - pl.Su.sign + 12) % 12) + 1 === 2
    );
    if (v2.length > 0) {
      const hasBen = v2.some((p) => BEN.includes(p));
      Y.push({
        type: hasBen ? "+" : "-",
        cat: jp ? "ヴェーシ" : "Veshi",
        planets: ["Su", ...v2],
        desc: jp
          ? `${v2.join(",")}が太陽の2H→${
              hasBen ? "吉星で名声・威厳。" : "凶星で困難。"
            }`
          : `${v2.join(",")} in 2nd from Sun. ${
              hasBen ? "Benefic: fame, dignity." : "Malefic: challenges."
            }`,
      });
    }
  }

  // --- VOSHI: Planet in 12th from Sun ---
  {
    const v12 = ps.filter(
      (pid) =>
        pid !== "Su" && ((pl[pid].sign - pl.Su.sign + 12) % 12) + 1 === 12
    );
    if (v12.length > 0) {
      const hasBen = v12.some((p) => BEN.includes(p));
      Y.push({
        type: hasBen ? "+" : "~",
        cat: jp ? "ヴォーシ" : "Voshi",
        planets: ["Su", ...v12],
        desc: jp
          ? `${v12.join(",")}が太陽の12H→${
              hasBen ? "慈善・精神性。" : "支出の増大。"
            }`
          : `${v12.join(",")} in 12th from Sun. ${
              hasBen ? "Charity, spirituality." : "Increased expenditure."
            }`,
      });
    }
  }

  // --- SUNAPHA/ANAPHA: Planet in 2nd/12th from Moon ---
  {
    const m2 = ps.filter(
      (pid) => pid !== "Mo" && ((pl[pid].sign - pl.Mo.sign + 12) % 12) + 1 === 2
    );
    const m12 = ps.filter(
      (pid) =>
        pid !== "Mo" && ((pl[pid].sign - pl.Mo.sign + 12) % 12) + 1 === 12
    );
    if (m2.length > 0) {
      Y.push({
        type: "+",
        cat: jp ? "スナファ" : "Sunapha",
        planets: ["Mo", ...m2],
        desc: jp
          ? `${m2.join(",")}が月の2H→自力で富を築く。知性。`
          : `${m2.join(",")} in 2nd from Moon. Self-made wealth, intelligence.`,
      });
    }
    if (m12.length > 0) {
      Y.push({
        type: "+",
        cat: jp ? "アナファ" : "Anapha",
        planets: ["Mo", ...m12],
        desc: jp
          ? `${m12.join(",")}が月の12H→良い体格・名声・快適。`
          : `${m12.join(",")} in 12th from Moon. Good physique, fame, comfort.`,
      });
    }
    if (m2.length > 0 && m12.length > 0) {
      Y.push({
        type: "+",
        cat: jp ? "ドゥルダラ" : "Durudhara",
        planets: ["Mo", ...m2, ...m12],
        desc: jp
          ? "月の前後に惑星→富・乗り物・寛大さ。"
          : "Planets on both sides of Moon. Wealth, vehicles, generosity.",
      });
    }
  }

  // --- Combustion check ---
  {
    const combDeg = { Mo: 12, Ma: 17, Me: 14, Ju: 11, Ve: 10, Sa: 15 };
    for (const pid of ["Mo", "Ma", "Me", "Ju", "Ve", "Sa"]) {
      const sL = (pl.Su.sign - 1) * 30 + pl.Su.deg;
      const pL = (pl[pid].sign - 1) * 30 + pl[pid].deg;
      const diff = Math.min(Math.abs(sL - pL), 360 - Math.abs(sL - pL));
      if (diff <= combDeg[pid]) {
        Y.push({
          type: "-",
          cat: jp ? "燃焼（アスタ）" : "Combustion (Asta)",
          planets: ["Su", pid],
          desc: jp
            ? `${pid}が太陽から${diff.toFixed(
                1
              )}°→燃焼。${pid}の象意が弱化・隠れる。`
            : `${pid} within ${diff.toFixed(
                1
              )}° of Sun. Combustion weakens ${pid}'s significations.`,
        });
      }
    }
  }

  // --- Graha Yuddha (planetary war) - planets within 1° ---
  {
    for (let i = 0; i < 5; i++) {
      for (let j = i + 1; j < 5; j++) {
        const a = ["Ma", "Me", "Ju", "Ve", "Sa"][i],
          b = ["Ma", "Me", "Ju", "Ve", "Sa"][j];
        if (pl[a].sign === pl[b].sign && Math.abs(pl[a].deg - pl[b].deg) <= 1) {
          Y.push({
            type: "-",
            cat: jp ? "グラハユッダ（惑星戦争）" : "Graha Yuddha",
            planets: [a, b],
            desc: jp
              ? `${a}と${b}が1°以内→惑星戦争。両惑星の象意に緊張・葛藤。`
              : `${a} and ${b} within 1°. Planetary war, tension in both significations.`,
          });
        }
      }
    }
  }

  return Y;
}

function YogaPanel({ yogas, t }) {
  const [filter, setFilter] = useState("all");
  const counts = {
    "+": yogas.filter((y) => y.type === "+").length,
    "-": yogas.filter((y) => y.type === "-").length,
    "~": yogas.filter((y) => y.type === "~").length,
  };
  const filtered =
    filter === "all" ? yogas : yogas.filter((y) => y.type === filter);
  const typeColor = (ty) =>
    ty === "+" ? "#5cb85c" : ty === "-" ? "#e05555" : "#e8b04a";
  const typeLabel = (ty) =>
    ty === "+" ? t.positive : ty === "-" ? t.negative : t.neutral;

  return (
    <div>
      <div
        style={{ display: "flex", gap: 4, marginBottom: 12, flexWrap: "wrap" }}
      >
        <button
          onClick={() => setFilter("all")}
          style={{
            padding: "5px 10px",
            border: "none",
            borderRadius: 4,
            cursor: "pointer",
            background: filter === "all" ? "#1a1520" : "transparent",
            color: filter === "all" ? "#c8c0d0" : "#4a4058",
            fontSize: "10px",
            fontWeight: 600,
          }}
        >
          {t.yogaFound} ({yogas.length})
        </button>
        <button
          onClick={() => setFilter("+")}
          style={{
            padding: "5px 10px",
            border: "none",
            borderRadius: 4,
            cursor: "pointer",
            background: filter === "+" ? "#1a2a15" : "transparent",
            color: "#5cb85c",
            fontSize: "10px",
            fontWeight: 600,
          }}
        >
          + {t.positive} ({counts["+"]})
        </button>
        <button
          onClick={() => setFilter("-")}
          style={{
            padding: "5px 10px",
            border: "none",
            borderRadius: 4,
            cursor: "pointer",
            background: filter === "-" ? "#2a1515" : "transparent",
            color: "#e05555",
            fontSize: "10px",
            fontWeight: 600,
          }}
        >
          − {t.negative} ({counts["-"]})
        </button>
        <button
          onClick={() => setFilter("~")}
          style={{
            padding: "5px 10px",
            border: "none",
            borderRadius: 4,
            cursor: "pointer",
            background: filter === "~" ? "#2a2515" : "transparent",
            color: "#e8b04a",
            fontSize: "10px",
            fontWeight: 600,
          }}
        >
          ~ {t.neutral} ({counts["~"]})
        </button>
      </div>
      {filtered.map((y, i) => (
        <div
          key={i}
          style={{
            padding: "10px 12px",
            marginBottom: 3,
            borderRadius: 6,
            background: "#0a0810",
            borderLeft: `3px solid ${typeColor(y.type)}`,
          }}
        >
          <div
            style={{
              display: "flex",
              justifyContent: "space-between",
              alignItems: "flex-start",
              marginBottom: 4,
            }}
          >
            <div
              style={{
                display: "flex",
                alignItems: "center",
                gap: 8,
                flexWrap: "wrap",
              }}
            >
              {y.planets.map((pid) => (
                <span
                  key={pid}
                  style={{
                    color: pCol(pid),
                    fontWeight: 700,
                    fontFamily: "'JetBrains Mono',monospace",
                    fontSize: "12px",
                  }}
                >
                  {pid}
                </span>
              ))}
              <span
                style={{
                  color: typeColor(y.type),
                  fontWeight: 700,
                  fontSize: "11px",
                }}
              >
                {y.cat}
              </span>
            </div>
            <span
              style={{
                color: typeColor(y.type),
                fontSize: "9px",
                fontWeight: 700,
                padding: "2px 6px",
                borderRadius: 3,
                background: typeColor(y.type) + "15",
                flexShrink: 0,
              }}
            >
              {typeLabel(y.type)}
            </span>
          </div>
          <div
            style={{ fontSize: "10px", color: "#8a80a0", lineHeight: "1.5" }}
          >
            {y.desc}
          </div>
        </div>
      ))}
      {filtered.length === 0 && (
        <div
          style={{
            padding: "30px",
            textAlign: "center",
            color: "#3a3048",
            fontSize: "11px",
          }}
        >
          {filter === "all" ? "No yogas detected" : "No yogas in this category"}
        </div>
      )}
    </div>
  );
}

// ===== SHADBALA ENGINE =====
// Required minimum Shadbala (in Rupas) for each planet
const SB_REQ = {
  Su: 6.5,
  Mo: 6.0,
  Ma: 5.0,
  Me: 7.0,
  Ju: 6.5,
  Ve: 5.5,
  Sa: 5.0,
};
const SB_COMP = [
  {
    id: "sthana",
    jp: "スターナ",
    en: "Sthana",
    c: "#5cb85c",
    desc: {
      jp: "位置の強さ（高揚・定座・友好等）",
      en: "Positional (exaltation, own sign, friends)",
    },
  },
  {
    id: "dig",
    jp: "ディグ",
    en: "Dig",
    c: "#40a0e0",
    desc: {
      jp: "方角の強さ（惑星の好む方角）",
      en: "Directional (preferred direction)",
    },
  },
  {
    id: "kala",
    jp: "カーラ",
    en: "Kala",
    c: "#e8b04a",
    desc: {
      jp: "時間の強さ（昼夜・曜日・季節等）",
      en: "Temporal (day/night, weekday, season)",
    },
  },
  {
    id: "cheshta",
    jp: "チェーシュタ",
    en: "Cheshta",
    c: "#e890c0",
    desc: { jp: "運動の強さ（逆行・速度等）", en: "Motional (retro, speed)" },
  },
  {
    id: "naisargika",
    jp: "ナイサルギカ",
    en: "Naisargika",
    c: "#9070b0",
    desc: {
      jp: "自然の強さ（惑星固有の力）",
      en: "Natural (inherent planetary strength)",
    },
  },
  {
    id: "drig",
    jp: "ドリグ",
    en: "Drig",
    c: "#b09070",
    desc: {
      jp: "アスペクトの強さ（他惑星からの視線）",
      en: "Aspectual (aspects from others)",
    },
  },
];

// Naisargika Bala (natural strength) - fixed values in Rupas
const NB = {
  Su: 1.0,
  Mo: 0.857,
  Ma: 0.286,
  Me: 0.429,
  Ju: 0.571,
  Ve: 0.714,
  Sa: 0.143,
};

// Dig Bala: best direction per planet (house = direction)
// Su/Ma best in 10H(south), Ju/Me best in 1H(east), Mo/Ve best in 4H(north), Sa best in 7H(west)
const DIG_BEST = { Su: 10, Mo: 4, Ma: 10, Me: 1, Ju: 1, Ve: 4, Sa: 7 };

function computeShadbala(pl, ascSign) {
  const ps = ["Su", "Mo", "Ma", "Me", "Ju", "Ve", "Sa"];
  const results = {};

  ps.forEach((pid) => {
    const s = pl[pid].sign;
    const d = pl[pid].deg;
    const retro = pl[pid].retro;
    const hh = ((s - ascSign + 12) % 12) + 1;

    // 1. STHANA BALA (Positional)
    let sthana = 0;
    // Uchcha Bala: distance from exaltation point
    if (EXA[pid]) {
      const exDeg =
        (EXA[pid] - 1) * 30 +
        ({ Su: 10, Mo: 3, Ma: 28, Me: 15, Ju: 5, Ve: 27, Sa: 20 }[pid] || 15);
      const pDeg = (s - 1) * 30 + d;
      const diff = Math.min(
        Math.abs(pDeg - exDeg),
        360 - Math.abs(pDeg - exDeg)
      );
      sthana += ((180 - diff) / 180) * 1.0; // 0-1 Rupa
    }
    // Saptavargaja: own/exalt/friend in D1
    if (isExalted(pid, s)) sthana += 1.0;
    else if (isOwn(pid, s)) sthana += 0.75;
    else if (DEB[pid] === s) sthana += 0.0;
    else sthana += 0.375;
    // Kendra Bala
    if (inKendra(hh)) sthana += 0.5;
    else if (inTrine(hh)) sthana += 0.375;
    else sthana += 0.125;

    // 2. DIG BALA (Directional)
    const bestH = DIG_BEST[pid];
    const distFromBest = Math.min(
      Math.abs(hh - bestH),
      12 - Math.abs(hh - bestH)
    );
    const dig = ((6 - distFromBest) / 6) * 1.0;

    // 3. KALA BALA (Temporal) - simplified
    let kala = 0.5; // base
    // Day planets (Su,Ju,Ve) stronger by day; Night planets (Mo,Ma,Sa) stronger by night
    // Using birth time as proxy
    if (["Su", "Ju", "Ve"].includes(pid)) kala += 0.2; // assume daytime birth for sample
    if (retro) kala += 0.15; // retro planets gain some temporal strength
    // Paksha Bala for Moon
    if (pid === "Mo") {
      const sunLong = (pl.Su.sign - 1) * 30 + pl.Su.deg;
      const moonLong = (s - 1) * 30 + d;
      const phase = (moonLong - sunLong + 360) % 360;
      kala += phase <= 180 ? (phase / 180) * 0.5 : ((360 - phase) / 180) * 0.5;
    }

    // 4. CHESHTA BALA (Motional)
    let cheshta = 0.5;
    if (retro) cheshta += 0.5; // retrograde = strong cheshta
    if (pid === "Su" || pid === "Mo") cheshta = 0.5; // luminaries don't have cheshta in same way
    // Speed factor (simplified)
    if (!retro && pid !== "Su" && pid !== "Mo") cheshta += 0.15;

    // 5. NAISARGIKA BALA (Natural) - fixed
    const naisargika = NB[pid];

    // 6. DRIG BALA (Aspectual)
    let drig = 0;
    const pLong = (s - 1) * 30 + d;
    ["Su", "Mo", "Ma", "Me", "Ju", "Ve", "Sa"].forEach((other) => {
      if (other === pid) return;
      const oLong = (pl[other].sign - 1) * 30 + pl[other].deg;
      const asp = (oLong - pLong + 360) % 360;
      // Full aspects
      if (Math.abs(asp - 180) <= 12) drig += BEN.includes(other) ? 0.15 : -0.1;
      if (Math.abs(asp - 120) <= 12 || Math.abs(asp - 240) <= 12)
        drig += BEN.includes(other) ? 0.1 : -0.05;
      if (Math.abs(asp - 90) <= 12 || Math.abs(asp - 270) <= 12)
        drig += BEN.includes(other) ? 0.05 : -0.08;
      if (Math.abs(asp - 60) <= 12 || Math.abs(asp - 300) <= 12)
        drig += BEN.includes(other) ? 0.08 : -0.03;
    });
    drig = Math.max(drig, -0.5);

    const total = sthana + dig + kala + cheshta + naisargika + drig;
    const req = SB_REQ[pid];

    results[pid] = {
      sthana: Math.max(0, sthana),
      dig: Math.max(0, dig),
      kala: Math.max(0, kala),
      cheshta: Math.max(0, cheshta),
      naisargika,
      drig: drig + 0.5, // shift to positive range for display
      total,
      req,
      pct: (total / req) * 100,
    };
  });
  return results;
}

function BalaPanel({ placements: pl, ascSign, lang }) {
  const [expanded, setExpanded] = useState(null);
  const sb = computeShadbala(pl, ascSign);
  const ps = ["Su", "Mo", "Ma", "Me", "Ju", "Ve", "Sa"];
  const maxTotal = Math.max(...ps.map((p) => sb[p].total), 8);
  const jp = lang === "jp";

  return (
    <div>
      <div
        style={{
          fontSize: "9px",
          color: "#5a5068",
          padding: "0 0 10px",
          fontWeight: 600,
        }}
      >
        {jp
          ? "シャドバラ — 6種の惑星力（ルーパ値）"
          : "Shadbala — 6-fold Planetary Strength (Rupas)"}
      </div>

      {/* Legend */}
      <div
        style={{
          display: "flex",
          flexWrap: "wrap",
          gap: "6px 10px",
          marginBottom: 14,
          padding: "6px 8px",
          background: "#0a0810",
          borderRadius: 4,
        }}
      >
        {SB_COMP.map((c) => (
          <span
            key={c.id}
            style={{
              display: "flex",
              alignItems: "center",
              gap: 3,
              fontSize: "9px",
            }}
          >
            <span
              style={{
                width: 8,
                height: 8,
                borderRadius: 2,
                background: c.c,
                display: "inline-block",
              }}
            />
            <span style={{ color: "#6a6080" }}>{jp ? c.jp : c.en}</span>
          </span>
        ))}
      </div>

      {/* Planet bars */}
      {ps.map((pid) => {
        const d = sb[pid];
        const isExp = expanded === pid;
        const strong = d.total >= d.req;
        const comps = [
          d.sthana,
          d.dig,
          d.kala,
          d.cheshta,
          d.naisargika,
          d.drig,
        ];
        return (
          <div key={pid} style={{ marginBottom: 3 }}>
            <button
              onClick={() => setExpanded(isExp ? null : pid)}
              style={{
                width: "100%",
                padding: "8px 10px",
                border: "none",
                cursor: "pointer",
                textAlign: "left",
                background: isExp ? "#14121c" : "#0a0810",
                borderRadius: isExp ? "6px 6px 0 0" : "6px",
                borderLeft: `3px solid ${strong ? "#5cb85c" : "#e05555"}`,
              }}
            >
              <div
                style={{
                  display: "flex",
                  alignItems: "center",
                  gap: 8,
                  marginBottom: 6,
                }}
              >
                <span
                  style={{
                    color: pCol(pid),
                    fontWeight: 700,
                    fontFamily: "'JetBrains Mono',monospace",
                    fontSize: "13px",
                    minWidth: 22,
                  }}
                >
                  {pid}
                </span>
                <span
                  style={{
                    color: strong ? "#5cb85c" : "#e05555",
                    fontWeight: 700,
                    fontSize: "12px",
                    fontFamily: "'JetBrains Mono',monospace",
                  }}
                >
                  {d.total.toFixed(2)}
                </span>
                <span style={{ color: "#4a4058", fontSize: "9px" }}>
                  / {d.req} {jp ? "必要" : "req"}
                </span>
                <span
                  style={{
                    color: strong ? "#5cb85c" : "#e05555",
                    fontSize: "8px",
                    fontWeight: 700,
                    padding: "1px 5px",
                    background: (strong ? "#5cb85c" : "#e05555") + "18",
                    borderRadius: 3,
                  }}
                >
                  {d.pct.toFixed(0)}%
                </span>
              </div>
              {/* Stacked bar */}
              <div
                style={{
                  display: "flex",
                  height: 14,
                  borderRadius: 3,
                  overflow: "hidden",
                  background: "#1a1520",
                }}
              >
                {SB_COMP.map((c, ci) => {
                  const w = (comps[ci] / maxTotal) * 100;
                  return (
                    <div
                      key={c.id}
                      style={{
                        width: `${w}%`,
                        background: c.c,
                        opacity: 0.85,
                        minWidth: w > 0 ? "1px" : "0",
                      }}
                    />
                  );
                })}
              </div>
              {/* Required line indicator */}
              <div style={{ position: "relative", height: 0 }}>
                <div
                  style={{
                    position: "absolute",
                    left: `${(d.req / maxTotal) * 100}%`,
                    top: -16,
                    width: 1,
                    height: 18,
                    background: "#ffffff40",
                  }}
                />
              </div>
            </button>

            {/* Expanded detail */}
            {isExp && (
              <div
                style={{
                  background: "#0a0810",
                  border: "1px solid #1a1520",
                  borderTop: "none",
                  borderRadius: "0 0 6px 6px",
                  padding: "8px 10px",
                }}
              >
                {SB_COMP.map((c, ci) => {
                  const val = comps[ci];
                  return (
                    <div
                      key={c.id}
                      style={{
                        display: "flex",
                        alignItems: "center",
                        gap: 8,
                        padding: "5px 0",
                        borderBottom: ci < 5 ? "1px solid #14121c" : "none",
                      }}
                    >
                      <span
                        style={{
                          width: 8,
                          height: 8,
                          borderRadius: 2,
                          background: c.c,
                          flexShrink: 0,
                        }}
                      />
                      <span
                        style={{
                          color: "#8a80a0",
                          fontSize: "10px",
                          minWidth: 80,
                        }}
                      >
                        {jp ? c.jp : c.en}
                      </span>
                      <div
                        style={{
                          flex: 1,
                          height: 10,
                          borderRadius: 2,
                          background: "#1a1520",
                          overflow: "hidden",
                        }}
                      >
                        <div
                          style={{
                            width: `${Math.min((val / 2) * 100, 100)}%`,
                            height: "100%",
                            background: c.c,
                            borderRadius: 2,
                            opacity: 0.75,
                          }}
                        />
                      </div>
                      <span
                        style={{
                          color: c.c,
                          fontSize: "11px",
                          fontWeight: 700,
                          fontFamily: "'JetBrains Mono',monospace",
                          minWidth: 36,
                          textAlign: "right",
                        }}
                      >
                        {val.toFixed(2)}
                      </span>
                    </div>
                  );
                })}
                <div
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    marginTop: 6,
                    paddingTop: 6,
                    borderTop: "1px solid #1a1520",
                  }}
                >
                  <span style={{ color: "#6a6080", fontSize: "10px" }}>
                    {jp ? "合計" : "Total"}
                  </span>
                  <span
                    style={{
                      color: strong ? "#5cb85c" : "#e05555",
                      fontSize: "13px",
                      fontWeight: 700,
                      fontFamily: "'JetBrains Mono',monospace",
                    }}
                  >
                    {d.total.toFixed(2)}{" "}
                    <span style={{ fontSize: "9px", color: "#4a4058" }}>
                      / {d.req}
                    </span>
                  </span>
                </div>
                <div
                  style={{
                    marginTop: 4,
                    fontSize: "9px",
                    color: "#5a5068",
                    lineHeight: "1.4",
                  }}
                >
                  {jp
                    ? `${pid}のシャドバラ: ${
                        strong
                          ? "必要値を超えており強い惑星です。"
                          : "必要値に達しておらず弱い惑星です。"
                      }`
                    : `${pid} Shadbala: ${
                        strong
                          ? "Exceeds required minimum, strong planet."
                          : "Below required minimum, weak planet."
                      }`}
                </div>
              </div>
            )}
          </div>
        );
      })}

      {/* Summary chart */}
      <div
        style={{
          marginTop: 14,
          padding: "10px",
          background: "#0a0810",
          borderRadius: 6,
        }}
      >
        <div
          style={{
            fontSize: "9px",
            color: "#5a5068",
            marginBottom: 8,
            fontWeight: 600,
          }}
        >
          {jp ? "惑星力ランキング" : "Planetary Strength Ranking"}
        </div>
        {[...ps]
          .sort((a, b) => sb[b].pct - sb[a].pct)
          .map((pid, i) => {
            const d = sb[pid];
            const strong = d.total >= d.req;
            return (
              <div
                key={pid}
                style={{
                  display: "flex",
                  alignItems: "center",
                  gap: 6,
                  padding: "3px 0",
                }}
              >
                <span
                  style={{
                    color: "#4a4058",
                    fontSize: "9px",
                    fontFamily: "'JetBrains Mono',monospace",
                    minWidth: 14,
                  }}
                >
                  {i + 1}.
                </span>
                <span
                  style={{
                    color: pCol(pid),
                    fontWeight: 700,
                    fontSize: "11px",
                    fontFamily: "'JetBrains Mono',monospace",
                    minWidth: 22,
                  }}
                >
                  {pid}
                </span>
                <div
                  style={{
                    flex: 1,
                    height: 8,
                    borderRadius: 2,
                    background: "#1a1520",
                    overflow: "hidden",
                  }}
                >
                  <div
                    style={{
                      width: `${Math.min(d.pct, 150) / 1.5}%`,
                      height: "100%",
                      borderRadius: 2,
                      background: strong
                        ? "linear-gradient(90deg,#5cb85c,#40a060)"
                        : "linear-gradient(90deg,#e05555,#c04040)",
                    }}
                  />
                </div>
                <span
                  style={{
                    color: strong ? "#5cb85c" : "#e05555",
                    fontSize: "10px",
                    fontWeight: 700,
                    fontFamily: "'JetBrains Mono',monospace",
                    minWidth: 38,
                    textAlign: "right",
                  }}
                >
                  {d.pct.toFixed(0)}%
                </span>
              </div>
            );
          })}
      </div>
    </div>
  );
}

// Muntha: natal Asc sign + age signs forward
function computeMuntha(natalAscSign, birthDate, year) {
  const age = year - parseInt(birthDate.split("-")[0]);
  return ((natalAscSign - 1 + age) % 12) + 1;
}

// Year Lord (Varsheshwara): lord of the weekday of solar return
// Simplified: based on age modulo
const WEEKDAY_LORDS = ["Su", "Mo", "Ma", "Me", "Ju", "Ve", "Sa"];
function computeYearLord(birthDate, year) {
  const bd = new Date(birthDate);
  const returnDate = new Date(year, bd.getMonth(), bd.getDate());
  const dayOfWeek = returnDate.getDay(); // 0=Sun
  return WEEKDAY_LORDS[dayOfWeek];
}

// Sahams (Arabic Parts / Sensitive Points)
function computeSahams(vPl, natalPl, lang) {
  const jp = lang === "jp";
  const aL = (vPl.As.sign - 1) * 30 + vPl.As.deg;
  const toLong = (pid, pl) => (pl[pid].sign - 1) * 30 + pl[pid].deg;
  const toSD = (l) => {
    const v = ((l % 360) + 360) % 360;
    return { sign: Math.floor(v / 30) + 1, deg: v % 30 };
  };

  return [
    {
      id: "PNY",
      name: jp ? "プンヤサハム（徳）" : "Punya Saham",
      ...toSD(aL + toLong("Mo", vPl) - toLong("Su", vPl)),
      type: "+",
      desc: jp
        ? "精神的成長・前世の功徳・宗教的利益"
        : "Spiritual growth, past merit, religious benefit",
    },
    {
      id: "VID",
      name: jp ? "ヴィッディヤー（学問）" : "Vidya Saham",
      ...toSD(aL + toLong("Su", vPl) - toLong("Ju", vPl)),
      type: "+",
      desc: jp
        ? "学問・知識の獲得・教育"
        : "Learning, knowledge acquisition, education",
    },
    {
      id: "YAS",
      name: jp ? "ヤシャス（名声）" : "Yashas Saham",
      ...toSD(aL + toLong("Ju", vPl) - toLong("Su", vPl)),
      type: "+",
      desc: jp
        ? "名声・評判・社会的認知"
        : "Fame, reputation, social recognition",
    },
    {
      id: "MRT",
      name: jp ? "ムリティユ（危険）" : "Mrityu Saham",
      ...toSD(aL + toLong("Ma", vPl) - toLong("Sa", vPl)),
      type: "-",
      desc: jp
        ? "危険・事故・健康上の脅威"
        : "Danger, accidents, health threats",
    },
    {
      id: "ROG",
      name: jp ? "ローガ（病気）" : "Roga Saham",
      ...toSD(aL + toLong("Sa", vPl) - toLong("Mo", vPl)),
      type: "-",
      desc: jp
        ? "病気・不調・慢性的な問題"
        : "Illness, ailments, chronic issues",
    },
    {
      id: "VIV",
      name: jp ? "ヴィヴァーハ（結婚）" : "Vivaha Saham",
      ...toSD(aL + toLong("Ve", vPl) - toLong("Sa", vPl)),
      type: "+",
      desc: jp ? "結婚・パートナーシップ" : "Marriage, partnership",
    },
    {
      id: "DHN",
      name: jp ? "ダナ（富）" : "Dhana Saham",
      ...toSD(aL + toLong("Ju", vPl) - toLong("Mo", vPl)),
      type: "+",
      desc: jp
        ? "財産・収入・経済的繁栄"
        : "Wealth, income, financial prosperity",
    },
    {
      id: "KRM",
      name: jp ? "カルマ（仕事）" : "Karma Saham",
      ...toSD(aL + toLong("Ma", vPl) - toLong("Me", vPl)),
      type: "~",
      desc: jp ? "仕事・職業・社会的活動" : "Work, career, social activity",
    },
  ];
}

// Harsha Bala (5-fold strength specific to Varshaphala)
function computeHarsha(vPl, natalPl, varshaAsc) {
  const ps = ["Su", "Mo", "Ma", "Me", "Ju", "Ve", "Sa"];
  const results = {};
  ps.forEach((pid) => {
    const vs = vPl[pid].sign;
    const ns = natalPl[pid].sign;
    const vh = ((vs - varshaAsc + 12) % 12) + 1;

    // 1. Pancha-vargiya: dignity in 5 vargas
    let pv = 0;
    if (isExalted(pid, vs)) pv += 1.0;
    else if (isOwn(pid, vs)) pv += 0.75;
    else if (DEB[pid] === vs) pv += 0;
    else pv += 0.375;

    // 2. Residence strength: kendra/trine
    let res = 0;
    if (inKendra(vh)) res = 1.0;
    else if (inTrine(vh)) res = 0.75;
    else if (inDusthana(vh)) res = 0.15;
    else res = 0.4;

    // 3. Same sign as natal (Sthira/natal match)
    let nat = vs === ns ? 1.0 : 0.3;

    // 4. Retro / direct
    let motion = vPl[pid].retro ? 0.8 : 0.5;
    if (pid === "Su" || pid === "Mo") motion = 0.6;

    // 5. Aspect from benefics
    let asp = 0.5;
    ["Ju", "Ve", "Me"].forEach((b) => {
      if (b !== pid && vPl[b]?.sign === vs) asp += 0.2;
    });
    asp = Math.min(asp, 1.0);

    const total = pv + res + nat + motion + asp;
    results[pid] = { pv, res, nat, motion, asp, total };
  });
  return results;
}

// Muntha analysis
function munDesc(munSign, varshaAsc, vPl, lang) {
  const jp = lang === "jp";
  const mH = ((munSign - varshaAsc + 12) % 12) + 1;
  const lord = SR[munSign];
  const lordH = ((vPl[lord].sign - varshaAsc + 12) % 12) + 1;

  let effect;
  if (inKendra(mH) || inTrine(mH))
    effect = jp
      ? "吉兆。好調な年になりやすい。"
      : "Auspicious. Favorable year likely.";
  else if (inDusthana(mH))
    effect = jp
      ? "注意が必要な年。健康・障害に配慮。"
      : "Challenging year. Watch health and obstacles.";
  else
    effect = jp
      ? "中程度の影響。努力で成果が出る年。"
      : "Moderate influence. Results through effort.";

  return {
    sign: munSign,
    house: mH,
    lord,
    lordH,
    effect,
    label: `${SGN[munSign - 1].ab} (${mH}H)`,
    lordLabel: `${lord} in ${lordH}H`,
  };
}

// ===== TRANSIT ANALYSIS =====
// Gochara: Transit analysis from Moon sign
const GOCHARA_EFFECTS = {
  // house from Moon → effect per planet type
  // +: good, -: bad, ~: mixed
  Su: {
    1: "-",
    2: "-",
    3: "+",
    4: "-",
    5: "-",
    6: "+",
    7: "-",
    8: "-",
    9: "+",
    10: "+",
    11: "+",
    12: "-",
  },
  Mo: {
    1: "-",
    2: "-",
    3: "+",
    4: "-",
    5: "-",
    6: "+",
    7: "+",
    8: "-",
    9: "+",
    10: "+",
    11: "+",
    12: "-",
  },
  Ma: {
    1: "-",
    2: "-",
    3: "+",
    4: "-",
    5: "-",
    6: "+",
    7: "-",
    8: "-",
    9: "-",
    10: "-",
    11: "+",
    12: "-",
  },
  Me: {
    1: "-",
    2: "+",
    3: "-",
    4: "+",
    5: "+",
    6: "+",
    7: "-",
    8: "+",
    9: "-",
    10: "+",
    11: "+",
    12: "-",
  },
  Ju: {
    1: "-",
    2: "+",
    3: "-",
    4: "-",
    5: "+",
    6: "-",
    7: "+",
    8: "-",
    9: "+",
    10: "-",
    11: "+",
    12: "-",
  },
  Ve: {
    1: "+",
    2: "+",
    3: "+",
    4: "+",
    5: "-",
    6: "-",
    7: "-",
    8: "+",
    9: "+",
    10: "-",
    11: "+",
    12: "+",
  },
  Sa: {
    1: "-",
    2: "-",
    3: "+",
    4: "-",
    5: "-",
    6: "+",
    7: "-",
    8: "-",
    9: "-",
    10: "-",
    11: "+",
    12: "-",
  },
  Ra: {
    1: "-",
    2: "-",
    3: "+",
    4: "-",
    5: "-",
    6: "+",
    7: "-",
    8: "-",
    9: "+",
    10: "+",
    11: "+",
    12: "-",
  },
  Ke: {
    1: "-",
    2: "-",
    3: "+",
    4: "-",
    5: "-",
    6: "+",
    7: "-",
    8: "-",
    9: "+",
    10: "-",
    11: "+",
    12: "-",
  },
};

// Vedha points (obstruction pairs)
const VEDHA = {
  Su: { 3: 9, 6: 12, 10: 4, 11: 5 },
  Mo: { 3: 9, 6: 12, 7: 2, 10: 4, 11: 5 },
  Ma: { 3: 12, 6: 9, 11: 5 },
  Me: { 2: 5, 4: 3, 6: 9, 8: 1, 10: 8, 11: 12 },
  Ju: { 2: 12, 5: 4, 7: 3, 9: 10, 11: 8 },
  Ve: { 1: 8, 2: 7, 3: 1, 4: 10, 8: 5, 9: 11, 11: 6, 12: 3 },
  Sa: { 3: 12, 6: 9, 11: 5 },
  Ra: { 3: 12, 6: 9, 11: 5 },
  Ke: { 3: 12, 6: 9, 11: 5 },
};

function analyzeGochara(tPl, natalPl, lang) {
  const jp = lang === "jp";
  const moSign = natalPl.Mo.sign;
  const ps = ["Su", "Mo", "Ma", "Me", "Ju", "Ve", "Sa", "Ra", "Ke"];
  const results = [];

  ps.forEach((pid) => {
    if (!tPl[pid]) return;
    const hFromMo = ((tPl[pid].sign - moSign + 12) % 12) + 1;
    const eff = GOCHARA_EFFECTS[pid]?.[hFromMo] || "~";

    // Check Vedha
    let vedha = false;
    let vedhaBy = null;
    const vPairs = VEDHA[pid] || {};
    if (vPairs[hFromMo]) {
      const vedhaH = vPairs[hFromMo];
      vedha = ps.some((other) => {
        if (other === pid || !tPl[other]) return false;
        const otherH = ((tPl[other].sign - moSign + 12) % 12) + 1;
        if (otherH === vedhaH) {
          vedhaBy = other;
          return true;
        }
        return false;
      });
    }

    const effLabel =
      eff === "+"
        ? jp
          ? "吉"
          : "Good"
        : eff === "-"
        ? jp
          ? "凶"
          : "Bad"
        : jp
        ? "混合"
        : "Mixed";
    let desc;
    if (eff === "+") {
      desc = jp
        ? `${pid}が月から${hFromMo}Hを通過中→好影響。${
            vedha ? `但し${vedhaBy}がヴェーダ（障害）。効果減少。` : ""
          }`
        : `${pid} transiting ${hFromMo}H from Moon. Favorable.${
            vedha ? ` But ${vedhaBy} causes Vedha (obstruction).` : ""
          }`;
    } else if (eff === "-") {
      desc = jp
        ? `${pid}が月から${hFromMo}Hを通過中→注意。${
            vedha ? `${vedhaBy}のヴェーダにより凶意軽減。` : ""
          }`
        : `${pid} transiting ${hFromMo}H from Moon. Challenging.${
            vedha ? ` ${vedhaBy} Vedha mitigates negativity.` : ""
          }`;
    } else {
      desc = jp
        ? `${pid}が月から${hFromMo}Hを通過中→混合的影響。`
        : `${pid} transiting ${hFromMo}H from Moon. Mixed influence.`;
    }

    // Final effect considering vedha
    const finalEff = vedha
      ? eff === "+"
        ? "-"
        : eff === "-"
        ? "+"
        : eff
      : eff;

    results.push({
      pid,
      hFromMo,
      sign: tPl[pid].sign,
      deg: tPl[pid].deg,
      retro: tPl[pid].retro,
      eff,
      vedha,
      vedhaBy,
      finalEff,
      effLabel,
      desc,
    });
  });
  return results;
}

// Sade Sati detection
function detectSadeSati(tPl, natalPl, lang) {
  const jp = lang === "jp";
  const moSign = natalPl.Mo.sign;
  const saSign = tPl.Sa?.sign;
  if (!saSign) return null;
  const diff = (saSign - moSign + 12) % 12;
  // Sade Sati: Saturn in 12th, 1st, or 2nd from Moon
  if (diff === 11)
    return {
      phase: jp ? "上昇期（12H）" : "Rising (12H)",
      active: true,
      desc: jp
        ? "サデサティ開始期。精神的な変容の始まり。"
        : "Sade Sati beginning. Start of mental transformation.",
    };
  if (diff === 0)
    return {
      phase: jp ? "頂点期（1H）" : "Peak (1H)",
      active: true,
      desc: jp
        ? "サデサティ頂点。最も強い影響。忍耐と内省の時期。"
        : "Sade Sati peak. Strongest influence. Period of patience and introspection.",
    };
  if (diff === 1)
    return {
      phase: jp ? "下降期（2H）" : "Waning (2H)",
      active: true,
      desc: jp
        ? "サデサティ終盤。困難からの学びが実る。"
        : "Sade Sati ending. Lessons from hardship bear fruit.",
    };
  return {
    phase: jp ? "非活性" : "Inactive",
    active: false,
    desc: jp ? "サデサティ期間外。" : "Not in Sade Sati period.",
  };
}

// ===== MUHURTA ENGINE =====
// Panchanga: Tithi, Nakshatra, Yoga, Karana, Vara
const VARA_JP = ["日曜", "月曜", "火曜", "水曜", "木曜", "金曜", "土曜"];
const VARA_EN = [
  "Sunday",
  "Monday",
  "Tuesday",
  "Wednesday",
  "Thursday",
  "Friday",
  "Saturday",
];
const VARA_LORD = ["Su", "Mo", "Ma", "Me", "Ju", "Ve", "Sa"];

const TITHI_NAMES = [
  "Pratipada",
  "Dvitiya",
  "Tritiya",
  "Chaturthi",
  "Panchami",
  "Shashthi",
  "Saptami",
  "Ashtami",
  "Navami",
  "Dashami",
  "Ekadashi",
  "Dvadashi",
  "Trayodashi",
  "Chaturdashi",
  "Purnima/Amavasya",
];
const TITHI_JP = [
  "プラティパダー",
  "ドヴィティーヤ",
  "トリティーヤ",
  "チャトゥルティ",
  "パンチャミー",
  "シャシュティ",
  "サプタミー",
  "アシュタミー",
  "ナヴァミー",
  "ダシャミー",
  "エーカーダシー",
  "ドヴァーダシー",
  "トラヨーダシー",
  "チャトゥルダシー",
  "プールニマー/アマーヴァスヤー",
];

const YOGA_NAMES = [
  "Vishkambha",
  "Priti",
  "Ayushman",
  "Saubhagya",
  "Shobhana",
  "Atiganda",
  "Sukarma",
  "Dhriti",
  "Shula",
  "Ganda",
  "Vriddhi",
  "Dhruva",
  "Vyaghata",
  "Harshana",
  "Vajra",
  "Siddhi",
  "Vyatipata",
  "Variyan",
  "Parigha",
  "Shiva",
  "Siddha",
  "Sadhya",
  "Shubha",
  "Shukla",
  "Brahma",
  "Indra",
  "Vaidhriti",
];
const YOGA_GOOD = [
  0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1,
  0,
]; // 1=good,0=bad

const KARANA_NAMES = [
  "Bava",
  "Balava",
  "Kaulava",
  "Taitila",
  "Gara",
  "Vanija",
  "Vishti",
  "Shakuni",
  "Chatushpada",
  "Naga",
  "Kimstughna",
];

// Muhurta quality assessment
function computePanchanga(dateStr, timeStr, tPl, lang) {
  const jp = lang === "jp";
  const dt = new Date(`${dateStr}T${timeStr || "12:00:00"}`);
  const dow = dt.getDay();

  // Tithi: based on Moon-Sun angular distance (each tithi = 12°)
  const suLong = tPl.Su ? (tPl.Su.sign - 1) * 30 + tPl.Su.deg : 0;
  const moLong = tPl.Mo ? (tPl.Mo.sign - 1) * 30 + tPl.Mo.deg : 0;
  const moonSunDiff = (moLong - suLong + 360) % 360;
  const tithiIdx = Math.floor(moonSunDiff / 12) % 30;
  const tithiNum = (tithiIdx % 15) + 1;
  const paksha =
    tithiIdx < 15
      ? jp
        ? "シュクラ（白分）"
        : "Shukla"
      : jp
      ? "クリシュナ（黒分）"
      : "Krishna";

  // Nakshatra of Moon
  const moNakIdx = Math.floor(moLong / (360 / 27)) % 27;

  // Yoga: (Sun longitude + Moon longitude) / 13°20'
  const yogaIdx = Math.floor((suLong + moLong) / (360 / 27)) % 27;

  // Karana: half-tithi
  const karanaIdx = Math.floor(moonSunDiff / 6) % 60;
  const karanaName = KARANA_NAMES[karanaIdx % 11];

  // Rahu Kalam (inauspicious time based on weekday)
  const rahuSlots = [8, 2, 7, 5, 6, 4, 3]; // slot number (1-8) for each day starting Sun
  const rahuSlot = rahuSlots[dow];
  const rahuStart = 7.5 + (rahuSlot - 1) * 1.5; // hours from 7:30
  const rahuEnd = rahuStart + 1.5;
  const fmtTime = (h) => {
    const hh = Math.floor(h);
    const mm = Math.round((h - hh) * 60);
    return `${String(hh).padStart(2, "0")}:${String(mm).padStart(2, "0")}`;
  };

  // Gulika Kalam
  const gulikaSlots = [7, 6, 5, 4, 3, 2, 1];
  const gulikaSlot = gulikaSlots[dow];
  const gulikaStart = 7.5 + (gulikaSlot - 1) * 1.5;
  const gulikaEnd = gulikaStart + 1.5;

  // Yamaghanda
  const yamaSlots = [5, 4, 3, 2, 1, 7, 6];
  const yamaSlot = yamaSlots[dow];
  const yamaStart = 7.5 + (yamaSlot - 1) * 1.5;
  const yamaEnd = yamaStart + 1.5;

  // Abhijit Muhurta (midday auspicious time, approx 11:36-12:24)
  const abhijitStart = 11.6;
  const abhijitEnd = 12.4;

  // Overall quality score
  let score = 50;
  // Good tithi: 2,3,5,7,10,11,13 of each paksha
  if ([2, 3, 5, 7, 10, 11, 13].includes(tithiNum)) score += 10;
  if ([4, 8, 9, 14].includes(tithiNum)) score -= 10;
  // Good yoga
  if (YOGA_GOOD[yogaIdx]) score += 8;
  else score -= 8;
  // Vishti karana is bad
  if (karanaIdx % 11 === 6) score -= 12;
  // Good day: Mon,Wed,Thu,Fri
  if ([1, 3, 4, 5].includes(dow)) score += 5;
  if (dow === 6) score -= 5; // Saturday
  // Moon nakshatra: some are better
  if ([1, 4, 6, 7, 8, 13, 14, 17, 20, 24, 26].includes(moNakIdx)) score += 5;

  score = Math.max(0, Math.min(100, score));
  const quality =
    score >= 70
      ? jp
        ? "吉"
        : "Auspicious"
      : score >= 45
      ? jp
        ? "中吉"
        : "Moderate"
      : jp
      ? "凶"
      : "Inauspicious";

  return {
    vara: {
      day: dow,
      name: jp ? VARA_JP[dow] : VARA_EN[dow],
      lord: VARA_LORD[dow],
    },
    tithi: {
      num: tithiNum,
      name: jp
        ? TITHI_JP[(tithiNum - 1) % 15]
        : TITHI_NAMES[(tithiNum - 1) % 15],
      paksha,
      idx: tithiIdx,
    },
    nakshatra: { idx: moNakIdx, name: NAK[moNakIdx], lord: NL[moNakIdx] },
    yoga: { idx: yogaIdx, name: YOGA_NAMES[yogaIdx], good: YOGA_GOOD[yogaIdx] },
    karana: { name: karanaName, bad: karanaIdx % 11 === 6 },
    rahu: {
      start: fmtTime(rahuStart),
      end: fmtTime(rahuEnd),
      label: `${fmtTime(rahuStart)}-${fmtTime(rahuEnd)}`,
    },
    gulika: {
      start: fmtTime(gulikaStart),
      end: fmtTime(gulikaEnd),
      label: `${fmtTime(gulikaStart)}-${fmtTime(gulikaEnd)}`,
    },
    yama: {
      start: fmtTime(yamaStart),
      end: fmtTime(yamaEnd),
      label: `${fmtTime(yamaStart)}-${fmtTime(yamaEnd)}`,
    },
    abhijit: {
      start: fmtTime(abhijitStart),
      end: fmtTime(abhijitEnd),
      label: `${fmtTime(abhijitStart)}-${fmtTime(abhijitEnd)}`,
    },
    score,
    quality,
  };
}

// ===== RECTIFICATION TOOL =====
function computeRectBoundaries(pl, bd, lang) {
  const jp = lang === "jp";
  const divs = ["D1", "D2", "D3", "D7", "D9", "D10", "D12", "D30", "D60"];
  const [hh, mm, ss] = (bd.time || "14:30:00").split(":").map(Number);
  const baseMin = hh * 60 + mm + ss / 60;
  const results = [];

  // For each division, scan ±30min in 1-min steps and find boundaries
  divs.forEach((div) => {
    const boundaries = [];
    let prevAsc = null;
    for (let offset = -30; offset <= 30; offset++) {
      const totalMin = baseMin + offset;
      const h2 = Math.floor(totalMin / 60) % 24;
      const m2 = Math.floor(totalMin % 60);
      const s2 = Math.round((totalMin % 1) * 60);
      // Simulate Asc change: In real ephemeris, Asc moves ~1° per 4 min
      // For divisional charts, boundaries are much tighter
      const dNum = parseInt(div.slice(1));
      const ascDeg = (pl.As.sign - 1) * 30 + pl.As.deg + offset * 0.25; // ~0.25°/min for Asc movement
      const divDeg = (ascDeg * dNum) % 360;
      const divSign = Math.floor((((divDeg % 360) + 360) % 360) / 30) + 1;

      if (prevAsc !== null && divSign !== prevAsc) {
        const timeStr = `${String(h2).padStart(2, "0")}:${String(m2).padStart(
          2,
          "0"
        )}`;
        boundaries.push({
          offset,
          time: timeStr,
          fromSign: prevAsc,
          toSign: divSign,
          label: `${SGN[prevAsc - 1].ab} → ${SGN[divSign - 1].ab}`,
        });
      }
      prevAsc = divSign;
    }
    if (boundaries.length > 0) {
      // Get current div Asc
      const curDivDeg =
        (((pl.As.sign - 1) * 30 + pl.As.deg) * parseInt(div.slice(1))) % 360;
      const curDivSign = Math.floor((((curDivDeg % 360) + 360) % 360) / 30) + 1;
      results.push({ div, boundaries, currentAsc: curDivSign });
    }
  });
  return results;
}

function RectPanel({ pl, bd, lang }) {
  const jp = lang === "jp";
  const rect = computeRectBoundaries(pl, bd, lang);

  return (
    <div
      style={{
        background: "#0e0c14",
        border: "1px solid #1a1520",
        borderRadius: 8,
        padding: "12px",
        marginBottom: 14,
      }}
    >
      <div
        style={{
          fontSize: "10px",
          color: "#7a7090",
          fontWeight: 600,
          marginBottom: 4,
        }}
      >
        {jp
          ? "レクティフィケーション（時刻修正ツール）"
          : "Rectification (Time Correction Tool)"}
      </div>
      <div style={{ fontSize: "9px", color: "#5a5068", marginBottom: 10 }}>
        {jp
          ? `出生時刻 ${bd.time} の前後±30分で分割図ラグナが切り替わるポイント`
          : `Divisional chart lagna boundaries ±30min around birth time ${bd.time}`}
      </div>

      {/* Timeline visualization */}
      <div
        style={{
          position: "relative",
          height: 20,
          background: "#1a1520",
          borderRadius: 4,
          marginBottom: 12,
          overflow: "hidden",
        }}
      >
        {/* Center line (current birth time) */}
        <div
          style={{
            position: "absolute",
            left: "50%",
            top: 0,
            width: 2,
            height: 20,
            background: "#e8b04a",
            zIndex: 2,
          }}
        />
        {/* Boundary markers */}
        {rect.flatMap((r) =>
          r.boundaries.map((b, bi) => {
            const pct = ((b.offset + 30) / 60) * 100;
            const colors = {
              D1: "#e8b04a",
              D9: "#5cb85c",
              D7: "#40a0e0",
              D10: "#e890c0",
              D60: "#e05555",
            };
            return (
              <div
                key={`${r.div}-${bi}`}
                style={{
                  position: "absolute",
                  left: `${pct}%`,
                  top: 0,
                  width: 1,
                  height: 20,
                  background: colors[r.div] || "#9070b0",
                  opacity: 0.7,
                }}
              />
            );
          })
        )}
        {/* Labels */}
        <div
          style={{
            position: "absolute",
            left: "0%",
            bottom: 0,
            fontSize: "7px",
            color: "#4a4058",
          }}
        >
          -30m
        </div>
        <div
          style={{
            position: "absolute",
            left: "50%",
            bottom: 0,
            transform: "translateX(-50%)",
            fontSize: "7px",
            color: "#e8b04a",
          }}
        >
          {(bd.time || "").slice(0, 5)}
        </div>
        <div
          style={{
            position: "absolute",
            right: "0%",
            bottom: 0,
            fontSize: "7px",
            color: "#4a4058",
          }}
        >
          +30m
        </div>
      </div>

      {/* Detail table */}
      {rect.map((r, ri) => (
        <div key={ri} style={{ marginBottom: 6 }}>
          <div
            style={{
              display: "flex",
              alignItems: "center",
              gap: 8,
              padding: "4px 0",
            }}
          >
            <span
              style={{
                color: "#e8b04a",
                fontWeight: 700,
                fontSize: "12px",
                fontFamily: "'JetBrains Mono',monospace",
                minWidth: 30,
              }}
            >
              {r.div}
            </span>
            <span style={{ color: "#5a5068", fontSize: "9px" }}>
              {jp ? "現在" : "Now"}:{" "}
              <span style={{ color: "#c8c0d0", fontWeight: 600 }}>
                {SGN[r.currentAsc - 1].ab}
              </span>
            </span>
            <span style={{ color: "#3a3048", fontSize: "9px" }}>|</span>
            <span style={{ color: "#5a5068", fontSize: "9px" }}>
              {r.boundaries.length} {jp ? "境界" : "boundaries"}
            </span>
          </div>
          {r.boundaries.map((b, bi) => {
            const isNear = Math.abs(b.offset) <= 5;
            return (
              <div
                key={bi}
                style={{
                  display: "flex",
                  alignItems: "center",
                  gap: 8,
                  padding: "3px 0 3px 38px",
                  fontSize: "10px",
                }}
              >
                <span
                  style={{
                    color: b.offset < 0 ? "#7888a0" : "#e8b04a",
                    fontWeight: 700,
                    fontFamily: "'JetBrains Mono',monospace",
                    minWidth: 38,
                  }}
                >
                  {b.offset > 0 ? "+" : ""}
                  {b.offset}m
                </span>
                <span
                  style={{
                    color: "#8a80a0",
                    fontFamily: "'JetBrains Mono',monospace",
                    minWidth: 40,
                  }}
                >
                  {b.time}
                </span>
                <span style={{ color: "#c8c0d0", fontSize: "10px" }}>
                  {b.label}
                </span>
                {isNear && (
                  <span
                    style={{
                      fontSize: "7px",
                      color: "#e05555",
                      padding: "1px 4px",
                      background: "#e0555515",
                      borderRadius: 2,
                    }}
                  >
                    {jp ? "近い" : "CLOSE"}
                  </span>
                )}
              </div>
            );
          })}
        </div>
      ))}
      {rect.length === 0 && (
        <div
          style={{
            padding: 10,
            textAlign: "center",
            color: "#3a3048",
            fontSize: "10px",
          }}
        >
          {jp ? "この範囲に境界はありません" : "No boundaries in this range"}
        </div>
      )}
    </div>
  );
}

// ===== FORM =====
const IS = {
  width: "100%",
  boxSizing: "border-box",
  background: "#14121c",
  border: "1px solid #222030",
  borderRadius: 4,
  padding: "7px 10px",
  fontSize: "12px",
  color: "#d0c8e0",
  fontFamily: "'JetBrains Mono',monospace",
  outline: "none",
};

// Helpers: extract LOCAL date/time strings (avoids toISOString UTC bug)
const p2 = (n) => String(n).padStart(2, "0");
const localDS = (d) =>
  `${d.getFullYear()}-${p2(d.getMonth() + 1)}-${p2(d.getDate())}`;
const localTS = (d) =>
  `${p2(d.getHours())}:${p2(d.getMinutes())}:${p2(d.getSeconds())}`;

// Time stepper component (reusable for Transit/Muhurta)
function TimeStepper({ date, time, setDate, setTime, lang }) {
  const shiftTime = (minutes) => {
    const d = new Date(`${date}T${time || "12:00:00"}`);
    d.setMinutes(d.getMinutes() + minutes);
    setDate(localDS(d));
    setTime(localTS(d));
  };
  return (
    <>
      <div
        style={{
          display: "flex",
          gap: 4,
          justifyContent: "center",
          flexWrap: "wrap",
          marginBottom: 10,
        }}
      >
        {[
          { l: "-1h", m: -60 },
          { l: "-10m", m: -10 },
          { l: "-1m", m: -1 },
          { l: "+1m", m: 1 },
          { l: "+10m", m: 10 },
          { l: "+1h", m: 60 },
        ].map((b) => (
          <button
            key={b.l}
            onClick={() => shiftTime(b.m)}
            style={{
              padding: "5px 8px",
              border: "1px solid #2a2535",
              borderRadius: 4,
              cursor: "pointer",
              background: "transparent",
              color: b.m < 0 ? "#7888a0" : "#e8b04a",
              fontSize: "10px",
              fontWeight: 600,
              fontFamily: "'JetBrains Mono',monospace",
            }}
          >
            {b.l}
          </button>
        ))}
      </div>
      <div style={{ display: "flex", gap: 4, justifyContent: "center" }}>
        {[
          { l: "-7d", m: -10080 },
          { l: "-1d", m: -1440 },
          { l: "+1d", m: 1440 },
          { l: "+7d", m: 10080 },
        ].map((b) => (
          <button
            key={b.l}
            onClick={() => shiftTime(b.m)}
            style={{
              padding: "5px 10px",
              border: "1px solid #2a2535",
              borderRadius: 4,
              cursor: "pointer",
              background: "transparent",
              color: b.m < 0 ? "#7888a0" : "#e8b04a",
              fontSize: "10px",
              fontWeight: 600,
              fontFamily: "'JetBrains Mono',monospace",
            }}
          >
            {b.l}
          </button>
        ))}
      </div>
    </>
  );
}

// Birth time input - 3 fields (HH:MM:SS) with number spinners
function TimeInput({ value, onChange }) {
  const parts = (value || "12:00:00").split(":");
  const h = parseInt(parts[0]) || 0,
    m = parseInt(parts[1]) || 0,
    s = parseInt(parts[2]) || 0;
  const up = (idx, raw) => {
    const p = [h, m, s];
    const v = parseInt(raw);
    if (isNaN(v)) {
      p[idx] = 0;
    } else {
      p[idx] = Math.max(0, Math.min(idx === 0 ? 23 : 59, v));
    }
    onChange(`${p2(p[0])}:${p2(p[1])}:${p2(p[2])}`);
  };
  const fs = {
    ...IS,
    textAlign: "center",
    fontSize: "16px",
    fontWeight: 600,
    padding: "8px 2px",
    width: "100%",
    boxSizing: "border-box",
  };
  return (
    <div
      style={{
        display: "grid",
        gridTemplateColumns: "1fr auto 1fr auto 1fr",
        alignItems: "center",
        gap: 0,
      }}
    >
      <input
        type="number"
        inputMode="numeric"
        pattern="[0-9]*"
        min="0"
        max="23"
        value={p2(h)}
        onChange={(e) => up(0, e.target.value)}
        onFocus={(e) => e.target.select()}
        style={fs}
      />
      <span
        style={{
          color: "#e8b04a",
          fontSize: "18px",
          fontWeight: 700,
          padding: "0 3px",
        }}
      >
        :
      </span>
      <input
        type="number"
        inputMode="numeric"
        pattern="[0-9]*"
        min="0"
        max="59"
        value={p2(m)}
        onChange={(e) => up(1, e.target.value)}
        onFocus={(e) => e.target.select()}
        style={fs}
      />
      <span
        style={{
          color: "#e8b04a",
          fontSize: "18px",
          fontWeight: 700,
          padding: "0 3px",
        }}
      >
        :
      </span>
      <input
        type="number"
        inputMode="numeric"
        pattern="[0-9]*"
        min="0"
        max="59"
        value={p2(s)}
        onChange={(e) => up(2, e.target.value)}
        onFocus={(e) => e.target.select()}
        style={fs}
      />
    </div>
  );
}

// Location picker for Transit/Muhurta
function LocPicker({ loc, setLoc, lang }) {
  const [sug, setSug] = useState([]);
  const [q, setQ] = useState(loc.place || "");
  const lbl = (s) => (lang === "jp" ? s.split("/")[0] : s.split("/")[1] || s);
  return (
    <div
      style={{
        background: "#0a0810",
        border: "1px solid #1a1520",
        borderRadius: 6,
        padding: "8px 10px",
        marginBottom: 10,
      }}
    >
      <div
        style={{
          display: "flex",
          alignItems: "center",
          gap: 6,
          marginBottom: 6,
        }}
      >
        <span style={{ fontSize: "9px", color: "#5a5068" }}>
          📍 {lang === "jp" ? "観測地" : "Location"}
        </span>
        {loc.place && (
          <span
            style={{
              fontSize: "9px",
              color: "#6a6080",
              fontFamily: "'JetBrains Mono',monospace",
            }}
          >
            {loc.place} ({loc.lat.toFixed(2)}, {loc.lon.toFixed(2)})
          </span>
        )}
      </div>
      <div style={{ position: "relative" }}>
        <input
          value={q}
          onChange={(e) => {
            setQ(e.target.value);
            setSug(searchC(e.target.value));
          }}
          placeholder={lang === "jp" ? "都市名を入力…" : "Type city name…"}
          style={{ ...IS, fontSize: "11px", marginBottom: 0 }}
        />
        {sug.length > 0 && (
          <div
            style={{
              position: "absolute",
              top: "100%",
              left: 0,
              right: 0,
              zIndex: 20,
              background: "#14121c",
              border: "1px solid #2a2535",
              borderRadius: "0 0 4px 4px",
              maxHeight: 160,
              overflowY: "auto",
              boxShadow: "0 8px 24px #00000060",
            }}
          >
            {sug.map((c, i) => (
              <button
                key={i}
                onClick={() => {
                  setLoc({
                    lat: c.la,
                    lon: c.lo,
                    tz: getCityTZ(c),
                    place: `${c.n}, ${c.c}`,
                  });
                  setQ(`${c.n}, ${c.c}`);
                  setSug([]);
                }}
                style={{
                  width: "100%",
                  padding: "8px 10px",
                  border: "none",
                  borderBottom: "1px solid #1a1520",
                  background: "transparent",
                  color: "#c8c0d0",
                  fontSize: "11px",
                  cursor: "pointer",
                  textAlign: "left",
                  display: "flex",
                  justifyContent: "space-between",
                }}
              >
                <span>
                  {c.n} <span style={{ color: "#5a5068" }}>{c.e}</span>
                </span>
                <span style={{ color: "#4a4058", fontSize: "9px" }}>{c.c}</span>
              </button>
            ))}
          </div>
        )}
      </div>
      <div
        style={{
          display: "grid",
          gridTemplateColumns: "1fr 1fr 1fr",
          gap: "6px",
          marginTop: 6,
        }}
      >
        <div>
          <label
            style={{
              display: "block",
              fontSize: "7px",
              color: "#4a4058",
              marginBottom: 2,
            }}
          >
            {lang === "jp" ? "緯度" : "Lat"}
          </label>
          <input
            type="number"
            step="0.01"
            value={loc.lat}
            onChange={(e) =>
              setLoc({ ...loc, lat: parseFloat(e.target.value) || 0 })
            }
            style={{ ...IS, fontSize: "10px", padding: "4px 6px" }}
          />
        </div>
        <div>
          <label
            style={{
              display: "block",
              fontSize: "7px",
              color: "#4a4058",
              marginBottom: 2,
            }}
          >
            {lang === "jp" ? "経度" : "Lon"}
          </label>
          <input
            type="number"
            step="0.01"
            value={loc.lon}
            onChange={(e) =>
              setLoc({ ...loc, lon: parseFloat(e.target.value) || 0 })
            }
            style={{ ...IS, fontSize: "10px", padding: "4px 6px" }}
          />
        </div>
        <div>
          <label
            style={{
              display: "block",
              fontSize: "7px",
              color: "#4a4058",
              marginBottom: 2,
            }}
          >
            TZ
          </label>
          <select
            value={tz2off(loc.tz) || "9"}
            onChange={(e) => setLoc({ ...loc, tz: off2tz(e.target.value) })}
            style={{
              ...IS,
              fontSize: "9px",
              padding: "4px 2px",
              WebkitAppearance: "none",
              appearance: "auto",
              cursor: "pointer",
            }}
          >
            {TZ_OPTS.map((o) => (
              <option key={o.v} value={o.v}>
                {o.l}
              </option>
            ))}
          </select>
        </div>
      </div>
    </div>
  );
}

function BF({ birthData: bd, onApply, onLoad, t, lang }) {
  const [form, setForm] = useState({ ...bd });
  const [sug, setSug] = useState([]);
  const fR = useRef(null);
  const set = (k, v) => setForm((prev) => ({ ...prev, [k]: v }));
  const [saveMsg, setSaveMsg] = useState("");
  const [showSaveMenu, setShowSaveMenu] = useState(false);
  // DST detection: compare actual offset for this date vs standard offset (January)
  const dstInfo = useMemo(() => {
    if (!form.tz || !form.date) return null;
    try {
      const fmt = (d) =>
        new Intl.DateTimeFormat("en", {
          timeZone: form.tz,
          timeZoneName: "shortOffset",
        })
          .formatToParts(d)
          .find((x) => x.type === "timeZoneName")?.value || "";
      const actual = fmt(new Date(form.date + "T12:00:00Z"));
      const winter = fmt(new Date(form.date.slice(0, 4) + "-01-15T12:00:00Z"));
      const summer = fmt(new Date(form.date.slice(0, 4) + "-07-15T12:00:00Z"));
      const isDST = actual !== winter && actual === summer;
      const isStd = actual === winter;
      return { actual, isDST, label: isDST ? "DST" : "STD" };
    } catch {
      return null;
    }
  }, [form.tz, form.date]);
  const jsonStr = () => JSON.stringify({ ...form }, null, 2);
  const fname = () => `${form.name || "chart"}_${form.date || "data"}.json`;
  const msg = (s, ok = true) => {
    setSaveMsg({ text: s, ok });
    setShowSaveMenu(false);
    setTimeout(() => setSaveMsg(null), 3000);
  };
  // Share: opens native share sheet (iOS: "Save to Files" etc.)
  const doShare = async () => {
    const j = jsonStr();
    try {
      const f = new File([j], fname(), { type: "application/json" });
      if (navigator.canShare && navigator.canShare({ files: [f] })) {
        await navigator.share({ title: fname(), files: [f] });
        msg("✓");
        return;
      }
      // Fallback: share as text
      await navigator.share({ title: fname(), text: j });
      msg("✓");
    } catch (e) {
      if (e.name === "AbortError") return setShowSaveMenu(false);
      msg("この環境では共有APIが制限されています", false);
    }
  };
  // Download: triggers browser download (goes to Downloads folder)
  const doDownload = () => {
    const j = jsonStr();
    try {
      const b = new Blob([j], { type: "application/json" });
      const u = URL.createObjectURL(b);
      const a = document.createElement("a");
      a.href = u;
      a.download = fname();
      a.style.display = "none";
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        try {
          document.body.removeChild(a);
        } catch {}
        URL.revokeObjectURL(u);
      }, 300);
      msg("✓ " + fname());
    } catch {
      msg("ダウンロード失敗", false);
    }
  };
  // Copy: copies JSON text to clipboard
  const doCopy = async () => {
    const j = jsonStr();
    try {
      await navigator.clipboard.writeText(j);
      msg("📋 コピー完了");
    } catch {
      try {
        const ta = document.createElement("textarea");
        ta.value = j;
        ta.style.cssText = "position:fixed;opacity:0";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        msg("📋 コピー完了");
      } catch {
        msg("コピー失敗", false);
      }
    }
  };
  const hasShare = typeof navigator !== "undefined" && !!navigator.share;
  const menuBtnS = {
    width: "100%",
    padding: "10px 12px",
    border: "1px solid #2a2535",
    borderRadius: 6,
    cursor: "pointer",
    background: "#14121c",
    color: "#c8c0d0",
    fontSize: "11px",
    textAlign: "left",
    display: "flex",
    alignItems: "center",
    gap: 10,
  };
  return (
    <section
      style={{
        background: "#0e0c14",
        border: "1px solid #1a1520",
        borderRadius: "0 0 8px 8px",
        padding: "14px",
        marginBottom: 16,
        borderTop: "none",
      }}
    >
      <div
        style={{
          display: "flex",
          justifyContent: "flex-end",
          gap: 6,
          marginBottom: 10,
          alignItems: "center",
        }}
      >
        {saveMsg && (
          <span
            style={{
              fontSize: "10px",
              color: saveMsg.ok ? "#5cb85c" : "#e05555",
              marginRight: 4,
            }}
          >
            {saveMsg.text}
          </span>
        )}
        <button
          onClick={() => {
            setForm({ ...NEW_BD });
            setSug([]);
          }}
          style={{
            padding: "4px 10px",
            border: "1px solid #5cb85c40",
            borderRadius: 4,
            cursor: "pointer",
            background: "transparent",
            color: "#5cb85c",
            fontSize: "10px",
            fontWeight: 600,
          }}
        >
          {t.newChart}
        </button>
        <button
          onClick={() => fR.current?.click()}
          style={{
            padding: "4px 10px",
            border: "1px solid #2a2535",
            borderRadius: 4,
            cursor: "pointer",
            background: "transparent",
            color: "#5a5068",
            fontSize: "10px",
          }}
        >
          {t.open}
        </button>
        <div style={{ position: "relative" }}>
          <button
            onClick={() => setShowSaveMenu(!showSaveMenu)}
            style={{
              padding: "4px 10px",
              border: `1px solid ${showSaveMenu ? "#e8b04a40" : "#2a2535"}`,
              borderRadius: 4,
              cursor: "pointer",
              background: showSaveMenu ? "#1a1510" : "transparent",
              color: showSaveMenu ? "#e8b04a" : "#5a5068",
              fontSize: "10px",
            }}
          >
            {t.save} ▾
          </button>
          {showSaveMenu && (
            <>
              <div
                onClick={() => setShowSaveMenu(false)}
                style={{
                  position: "fixed",
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  zIndex: 29,
                }}
              />
              <div
                style={{
                  position: "absolute",
                  right: 0,
                  top: "100%",
                  zIndex: 30,
                  background: "#1a1828",
                  border: "1px solid #2a2535",
                  borderRadius: 8,
                  padding: 8,
                  minWidth: 220,
                  boxShadow: "0 12px 32px #00000090",
                  marginTop: 4,
                }}
              >
                {hasShare && (
                  <button onClick={doShare} style={menuBtnS}>
                    <span style={{ fontSize: "16px" }}>📤</span>
                    <div>
                      <div style={{ fontWeight: 700, color: "#e8b04a" }}>
                        共有 / ファイルに保存
                      </div>
                      <div
                        style={{
                          fontSize: "9px",
                          color: "#6a6080",
                          marginTop: 2,
                        }}
                      >
                        保存先を自由に選択できます
                      </div>
                    </div>
                  </button>
                )}
                <button
                  onClick={doDownload}
                  style={{ ...menuBtnS, marginTop: hasShare ? 6 : 0 }}
                >
                  <span style={{ fontSize: "16px" }}>💾</span>
                  <div>
                    <div style={{ fontWeight: 600 }}>ダウンロード</div>
                    <div
                      style={{
                        fontSize: "9px",
                        color: "#6a6080",
                        marginTop: 2,
                      }}
                    >
                      JSONファイルを保存
                    </div>
                  </div>
                </button>
                <button onClick={doCopy} style={{ ...menuBtnS, marginTop: 6 }}>
                  <span style={{ fontSize: "16px" }}>📋</span>
                  <div>
                    <div style={{ fontWeight: 600 }}>
                      クリップボードにコピー
                    </div>
                    <div
                      style={{
                        fontSize: "9px",
                        color: "#6a6080",
                        marginTop: 2,
                      }}
                    >
                      テキストとしてコピー
                    </div>
                  </div>
                </button>
              </div>
            </>
          )}
        </div>
        <input
          ref={fR}
          type="file"
          accept=".json,.txt"
          onChange={(e) => {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
              try {
                const d = JSON.parse(ev.target.result);
                if (d.name && d.date) {
                  setForm(d);
                  onLoad(d);
                }
              } catch {}
            };
            r.readAsText(f);
            e.target.value = "";
          }}
          style={{ display: "none" }}
        />
      </div>
      <div
        style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "8px" }}
      >
        <div style={{ minWidth: 0 }}>
          <label
            style={{
              display: "block",
              fontSize: "8px",
              color: "#4a4058",
              marginBottom: 3,
            }}
          >
            {t.name}
          </label>
          <input
            value={form.name}
            onChange={(e) => set("name", e.target.value)}
            style={IS}
          />
        </div>
        <div style={{ minWidth: 0 }}>
          <label
            style={{
              display: "block",
              fontSize: "8px",
              color: "#4a4058",
              marginBottom: 3,
            }}
          >
            {t.dob}
          </label>
          <input
            type="date"
            value={form.date}
            onChange={(e) => set("date", e.target.value)}
            style={{
              ...IS,
              textAlign: "left",
              WebkitAppearance: "none",
              appearance: "none",
              paddingRight: "4px",
            }}
          />
        </div>
        <div style={{ minWidth: 0 }}>
          <label
            style={{
              display: "block",
              fontSize: "8px",
              color: "#4a4058",
              marginBottom: 3,
            }}
          >
            {t.tob}
          </label>
          <TimeInput value={form.time} onChange={(v) => set("time", v)} />
        </div>
      </div>
      <div style={{ position: "relative", marginTop: 8 }}>
        <label
          style={{
            display: "block",
            fontSize: "8px",
            color: "#4a4058",
            marginBottom: 3,
          }}
        >
          {t.place}
        </label>
        <input
          value={form.place}
          onChange={(e) => {
            set("place", e.target.value);
            setSug(searchC(e.target.value));
          }}
          placeholder={t.placePh}
          style={IS}
        />
        {sug.length > 0 && (
          <div
            style={{
              position: "absolute",
              top: "100%",
              left: 0,
              right: 0,
              zIndex: 20,
              background: "#14121c",
              border: "1px solid #2a2535",
              borderRadius: "0 0 4px 4px",
              maxHeight: 200,
              overflowY: "auto",
              boxShadow: "0 8px 24px #00000060",
            }}
          >
            {sug.map((c, i) => (
              <button
                key={i}
                onClick={() => {
                  setForm((prev) => ({
                    ...prev,
                    place: `${c.n}, ${c.c}`,
                    lat: c.la,
                    lon: c.lo,
                    tz: getCityTZ(c),
                  }));
                  setSug([]);
                }}
                style={{
                  width: "100%",
                  padding: "10px 12px",
                  border: "none",
                  borderBottom: "1px solid #1a1520",
                  background: "transparent",
                  color: "#c8c0d0",
                  fontSize: "12px",
                  cursor: "pointer",
                  textAlign: "left",
                  display: "flex",
                  justifyContent: "space-between",
                }}
              >
                <span>
                  {c.n} <span style={{ color: "#5a5068" }}>{c.e}</span>
                </span>
                <span style={{ color: "#4a4058", fontSize: "9px" }}>{c.c}</span>
              </button>
            ))}
          </div>
        )}
      </div>
      <div
        style={{
          display: "grid",
          gridTemplateColumns: "1fr 1fr 1fr",
          gap: "8px",
          marginTop: 8,
        }}
      >
        <div>
          <label
            style={{
              display: "block",
              fontSize: "8px",
              color: "#4a4058",
              marginBottom: 3,
            }}
          >
            {t.lat}
          </label>
          <input
            type="number"
            step="0.0001"
            value={form.lat || ""}
            onChange={(e) => set("lat", parseFloat(e.target.value))}
            placeholder="35.6640"
            style={{ ...IS, fontSize: "11px" }}
          />
        </div>
        <div>
          <label
            style={{
              display: "block",
              fontSize: "8px",
              color: "#4a4058",
              marginBottom: 3,
            }}
          >
            {t.lon}
          </label>
          <input
            type="number"
            step="0.0001"
            value={form.lon || ""}
            onChange={(e) => set("lon", parseFloat(e.target.value))}
            placeholder="139.6982"
            style={{ ...IS, fontSize: "11px" }}
          />
        </div>
        <div>
          <label
            style={{
              display: "block",
              fontSize: "8px",
              color: "#4a4058",
              marginBottom: 3,
            }}
          >
            {t.tz}
          </label>
          <select
            value={tz2off(form.tz) || "9"}
            onChange={(e) => {
              const tz = off2tz(e.target.value);
              set("tz", tz);
            }}
            style={{
              ...IS,
              fontSize: "10px",
              WebkitAppearance: "none",
              appearance: "auto",
              cursor: "pointer",
              paddingRight: "2px",
            }}
          >
            {TZ_OPTS.map((o) => (
              <option key={o.v} value={o.v}>
                {o.l}
              </option>
            ))}
          </select>
        </div>
      </div>
      {dstInfo && dstInfo.isDST && (
        <div
          style={{
            marginTop: 4,
            padding: "6px 10px",
            background: "#2a2a1020",
            border: "1px solid #e8b04a30",
            borderRadius: 4,
            display: "flex",
            alignItems: "center",
            gap: 6,
          }}
        >
          <span style={{ fontSize: "10px", color: "#e8b04a", fontWeight: 700 }}>
            ☀ DST
          </span>
          <span style={{ fontSize: "9px", color: "#8a80a0" }}>
            {lang === "jp"
              ? `サマータイム適用中 (${dstInfo.actual})`
              : `Daylight Saving Time active (${dstInfo.actual})`}
          </span>
        </div>
      )}
      <button
        onClick={() => onApply(form)}
        style={{
          width: "100%",
          marginTop: 10,
          padding: "10px",
          background: "linear-gradient(135deg,#2a1f10,#1a1510)",
          border: "1px solid #e8b04a50",
          borderRadius: 6,
          cursor: "pointer",
          color: "#e8b04a",
          fontSize: "12px",
          fontWeight: 600,
        }}
      >
        {t.apply}
      </button>
      <div style={{ marginTop: 10 }}>
        <label
          style={{
            display: "block",
            fontSize: "8px",
            color: "#4a4058",
            marginBottom: 3,
          }}
        >
          {t.notes}
        </label>
        <textarea
          value={form.notes || ""}
          onChange={(e) => set("notes", e.target.value)}
          placeholder={t.notesPh}
          rows={3}
          style={{
            ...IS,
            resize: "vertical",
            minHeight: 60,
            lineHeight: "1.5",
          }}
        />
      </div>
    </section>
  );
}

function CB({ birthData: bd }) {
  const tz = bd.tz ? tzOS(bd.tz) : "";
  return (
    <div
      style={{
        padding: "8px 14px",
        marginBottom: 14,
        background: "#0a0810",
        border: "1px solid #1a1520",
        borderRadius: 6,
      }}
    >
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          marginBottom: bd.lat ? 4 : 0,
        }}
      >
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <div
            style={{
              width: 6,
              height: 6,
              borderRadius: "50%",
              background: "#e8b04a",
              boxShadow: "0 0 8px #e8b04a60",
            }}
          />
          <span style={{ color: "#c8c0d0", fontSize: "12px", fontWeight: 600 }}>
            {bd.name}
          </span>
        </div>
        <div
          style={{
            display: "flex",
            gap: 10,
            fontSize: "10px",
            color: "#6a6080",
            fontFamily: "'JetBrains Mono',monospace",
          }}
        >
          <span>{bd.date}</span>
          <span>{bd.time}</span>
        </div>
      </div>
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          fontSize: "9px",
          color: "#4a4058",
          fontFamily: "'JetBrains Mono',monospace",
        }}
      >
        <span>{bd.place}</span>
        {bd.lat && (
          <span>
            {bd.lat.toFixed(4)}, {bd.lon.toFixed(4)} {tz}
          </span>
        )}
      </div>
      {bd.notes && (
        <div
          style={{
            marginTop: 6,
            padding: "6px 8px",
            background: "#14121c",
            borderRadius: 4,
            fontSize: "10px",
            color: "#8a80a0",
            lineHeight: "1.5",
            whiteSpace: "pre-wrap",
            maxHeight: 60,
            overflowY: "auto",
          }}
        >
          {bd.notes}
        </div>
      )}
    </div>
  );
}

// saveF removed - save logic now in BF component directly

// ===== SETTINGS PANEL =====
function StgPanel({ stg, setStg, lang, onClose }) {
  const jp = lang === "jp";
  const s = (k, v) => setStg((prev) => ({ ...prev, [k]: v }));
  const opts = [
    {
      key: "ayanamsha",
      label: jp ? "アヤナムシャ" : "Ayanamsha",
      options: [
        {
          v: "lahiri",
          l: "Lahiri (Chitrapaksha)",
          d: jp
            ? "KNラオ、BPHS系。インドで最も一般的。"
            : "KN Rao, BPHS tradition. Most common in India.",
        },
        {
          v: "kp",
          l: "Krishnamurti (KP)",
          d: jp ? "KPシステム用。" : "For KP system.",
        },
        {
          v: "raman",
          l: "B.V. Raman",
          d: jp ? "ラーマン方式。" : "Raman method.",
        },
        {
          v: "fagan",
          l: "Fagan-Bradley",
          d: jp ? "西洋サイデリアル系。" : "Western sidereal.",
        },
      ],
    },
    {
      key: "nodeType",
      label: jp ? "ラーフ/ケートゥ" : "Rahu/Ketu Nodes",
      options: [
        {
          v: "mean",
          l: jp ? "ミーンノード" : "Mean Node",
          d: jp
            ? "KNラオ推奨。一般的なインド占星術。"
            : "KN Rao recommended. Standard Jyotish.",
        },
        {
          v: "true",
          l: jp ? "トゥルーノード" : "True Node",
          d: jp
            ? "天文学的な実際の位置。KP系。"
            : "Astronomical actual position. KP system.",
        },
      ],
    },
    {
      key: "karakaSystem",
      label: jp ? "カーラカ方式" : "Karaka System",
      options: [
        {
          v: "7",
          l: jp ? "7カーラカ（KNラオ）" : "7 Karakas (KN Rao)",
          d: jp
            ? "ラーフ除外。チャラダシャーKNラオ式。"
            : "Excludes Rahu. Chara Dasha KN Rao method.",
        },
        {
          v: "8",
          l: jp ? "8カーラカ（ジャイミニ伝統）" : "8 Karakas (Jaimini)",
          d: jp
            ? "ラーフ含む。イランガンティ方式。"
            : "Includes Rahu. Iranganti method.",
        },
      ],
    },
    {
      key: "houseSystem",
      label: jp ? "ハウスシステム" : "House System",
      options: [
        {
          v: "sripati",
          l: "Sripati",
          d: jp
            ? "KNラオ推奨。中間点方式。"
            : "KN Rao recommended. Midpoint method.",
        },
        {
          v: "equal",
          l: jp ? "等分ハウス（ホールサイン）" : "Equal / Whole Sign",
          d: jp
            ? "古典的パラーシャラ。ラーシ＝ハウス。"
            : "Classical Parashari. Sign = House.",
        },
        {
          v: "placidus",
          l: "Placidus",
          d: jp ? "西洋占星術で一般的。" : "Common in Western astrology.",
        },
      ],
    },
  ];
  return (
    <div
      style={{
        background: "#0e0c14",
        border: "1px solid #1a1520",
        borderRadius: 8,
        padding: "14px",
        marginBottom: 14,
      }}
    >
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          marginBottom: 12,
        }}
      >
        <span style={{ fontSize: "12px", color: "#e8b04a", fontWeight: 700 }}>
          ⚙ {jp ? "計算設定" : "Calculation Settings"}
        </span>
        <button
          onClick={onClose}
          style={{
            padding: "3px 10px",
            border: "1px solid #2a2535",
            borderRadius: 4,
            cursor: "pointer",
            background: "transparent",
            color: "#6a6080",
            fontSize: "10px",
          }}
        >
          ✕
        </button>
      </div>
      <div
        style={{
          padding: "6px 10px",
          background: "#14121c",
          borderRadius: 4,
          marginBottom: 12,
          fontSize: "9px",
          color: "#5a5068",
          lineHeight: "1.5",
        }}
      >
        {jp
          ? "デフォルト: KNラオ方式（Lahiri + ミーンノード + 7カーラカ + Sripati）"
          : "Default: KN Rao method (Lahiri + Mean Node + 7 Karakas + Sripati)"}
      </div>
      {opts.map((opt, oi) => (
        <div
          key={opt.key}
          style={{ marginBottom: oi < opts.length - 1 ? 12 : 0 }}
        >
          <div
            style={{
              fontSize: "10px",
              color: "#7a7090",
              fontWeight: 600,
              marginBottom: 6,
            }}
          >
            {opt.label}
          </div>
          {opt.options.map((o) => (
            <button
              key={o.v}
              onClick={() => s(opt.key, o.v)}
              style={{
                display: "flex",
                alignItems: "flex-start",
                gap: 8,
                width: "100%",
                padding: "8px 10px",
                border: `1px solid ${
                  stg[opt.key] === o.v ? "#e8b04a40" : "#1a1520"
                }`,
                borderRadius: 6,
                cursor: "pointer",
                background: stg[opt.key] === o.v ? "#1a1510" : "transparent",
                marginBottom: 4,
                textAlign: "left",
              }}
            >
              <div
                style={{
                  width: 14,
                  height: 14,
                  borderRadius: "50%",
                  border: `2px solid ${
                    stg[opt.key] === o.v ? "#e8b04a" : "#3a3048"
                  }`,
                  flexShrink: 0,
                  marginTop: 1,
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                }}
              >
                {stg[opt.key] === o.v && (
                  <div
                    style={{
                      width: 6,
                      height: 6,
                      borderRadius: "50%",
                      background: "#e8b04a",
                    }}
                  />
                )}
              </div>
              <div>
                <div
                  style={{
                    fontSize: "11px",
                    color: stg[opt.key] === o.v ? "#e8b04a" : "#c8c0d0",
                    fontWeight: stg[opt.key] === o.v ? 700 : 400,
                  }}
                >
                  {o.l}
                </div>
                <div
                  style={{
                    fontSize: "8px",
                    color: "#5a5068",
                    marginTop: 2,
                    lineHeight: "1.3",
                  }}
                >
                  {o.d}
                </div>
              </div>
            </button>
          ))}
        </div>
      ))}
      <button
        onClick={() => setStg({ ...DEF_STG })}
        style={{
          width: "100%",
          marginTop: 8,
          padding: "8px",
          border: "1px solid #2a2535",
          borderRadius: 4,
          cursor: "pointer",
          background: "transparent",
          color: "#6a6080",
          fontSize: "10px",
        }}
      >
        {jp ? "デフォルトに戻す" : "Reset to Default (KN Rao)"}
      </button>
    </div>
  );
}

// ===== MAIN =====
const MT = [
  { id: "birth", l: "出生図", s: "Birth" },
  { id: "varsha", l: "ヴァルシャ", s: "Varsha" },
  { id: "transit", l: "トランジット", s: "Transit" },
  { id: "muhurta", l: "ムフールタ", s: "Muhurta" },
];
const ST = [
  { id: "chart", l: "チャート" },
  { id: "dasha", l: "ダシャー" },
  { id: "yoga", l: "ヨーガ" },
  { id: "bala", l: "バラ" },
];

// ===== RESPONSIVE HOOK =====
function useWidth() {
  const [w, setW] = useState(
    typeof window !== "undefined" ? window.innerWidth : 400
  );
  useEffect(() => {
    const h = () => setW(window.innerWidth);
    window.addEventListener("resize", h);
    return () => window.removeEventListener("resize", h);
  }, []);
  return w;
}

export default function JyotishApp() {
  const winW = useWidth();
  const wide = winW >= 768; // tablet+
  const maxW = wide ? 960 : 540;
  const [mainTab, setMainTab] = useState("birth");
  const [subTab, setSubTab] = useState("chart");
  const [cs, setCs] = useState("south");
  const [showTbl, setShowTbl] = useState(true);
  const [subV, setSubV] = useState("D9");
  const [subCat, setSubCat] = useState("varga");
  const [showForm, setShowForm] = useState(false);
  const [viewAsc, setViewAsc] = useState(null);
  const [lang, setLang] = useState("jp");
  const [vYear, setVYear] = useState(new Date().getFullYear());
  const [vDetail, setVDetail] = useState(null);
  const [trDate, setTrDate] = useState(localDS(new Date()));
  const [trTime, setTrTime] = useState(localTS(new Date()));
  const [trDetail, setTrDetail] = useState(null);
  const [trLoc, setTrLoc] = useState({
    lat: 35.664,
    lon: 139.6982,
    tz: "Asia/Tokyo",
    place: "",
  });
  const [muDate, setMuDate] = useState(localDS(new Date()));
  const [muTime, setMuTime] = useState("12:00:00");
  const [showRect, setShowRect] = useState(false);
  const [muLoc, setMuLoc] = useState({
    lat: 35.664,
    lon: 139.6982,
    tz: "Asia/Tokyo",
    place: "",
  });
  const [stg, setStg] = useState({ ...DEF_STG });
  const [showStg, setShowStg] = useState(false);
  const t = L[lang];
  const [bd, setBd] = useState({
    name: "サンプル 太郎",
    date: "1990-07-15",
    time: "14:30:00",
    place: "渋谷区, JP",
    lat: 35.664,
    lon: 139.6982,
    tz: "Asia/Tokyo",
    notes: "",
  });
  // ★ Live ephemeris calculation
  const pl = useMemo(
    () => calcChart(bd.date, bd.time, bd.lat, bd.lon, bd.tz, stg),
    [bd.date, bd.time, bd.lat, bd.lon, bd.tz, stg]
  );
  const ascSign = pl.As.sign;
  const eAsc = viewAsc || ascSign;
  const kMap = cK(pl);
  const fn = cFN(eAsc);
  const isVg = subCat === "varga" && subV.startsWith("D");
  const subPl = isVg ? cV(pl, subV) : pl;
  const subKM = cK(subPl);
  const subLb = isVg
    ? `${subV} — ${VI.find((v) => v.id === subV)?.n || ""}`
    : SI.find((v) => v.id === subV)?.jp || subV;
  const tPl = isVg && subV !== "D1" ? subPl : pl;
  const tKM = isVg && subV !== "D1" ? subKM : kMap;
  const tLb = isVg && subV !== "D1" ? subLb : "D1 Rashi";
  const sav = cSAV(pl);
  const ugs = cUG(pl);
  const sls = cSL(pl);
  const padas = cJP(pl, ascSign);
  const yogas = detectYogas(pl, ascSign, lang);
  const CC = cs === "south" ? SCh : NCh;
  // Varsha computations — real ephemeris (solar return date approximation)
  const birthYear = parseInt(bd.date.split("-")[0]);
  const vAge = vYear - birthYear;
  const vPl = useMemo(() => {
    if (vAge < 0) return null;
    // Solar return: approximate date = birth date in selected year
    const vDate = `${vYear}-${bd.date.slice(5)}`;
    return calcChart(vDate, bd.time, bd.lat, bd.lon, bd.tz, stg);
  }, [vYear, vAge, bd.date, bd.time, bd.lat, bd.lon, bd.tz, stg]);
  const vAsc = vPl ? vPl.As.sign : 1;
  const vKMap = vPl ? cK(vPl) : {};
  const vMunSign = computeMuntha(ascSign, bd.date, vYear);
  const vYearLord = computeYearLord(bd.date, vYear);
  const vSahams = vPl ? computeSahams(vPl, pl, lang) : [];
  const vHarsha = vPl ? computeHarsha(vPl, pl, vAsc) : {};
  const vLb = viewAsc
    ? Object.entries(pl).find(([, v]) => v.sign === viewAsc)?.[0] ||
      SGN[viewAsc - 1].ab
    : null;
  // Transit computations — real ephemeris
  const trPl = useMemo(
    () =>
      calcChart(
        trDate,
        trTime || "12:00:00",
        trLoc.lat,
        trLoc.lon,
        trLoc.tz,
        stg
      ),
    [trDate, trTime, trLoc.lat, trLoc.lon, trLoc.tz, stg]
  );
  const trKMap = cK(trPl);
  const trAsc = trPl.As?.sign || 1;
  const gochara = analyzeGochara(trPl, pl, lang);
  const sadeSati = detectSadeSati(trPl, pl, lang);
  // Muhurta computations — real ephemeris
  const muPl = useMemo(
    () =>
      calcChart(
        muDate,
        muTime || "12:00:00",
        muLoc.lat,
        muLoc.lon,
        muLoc.tz,
        stg
      ),
    [muDate, muTime, muLoc.lat, muLoc.lon, muLoc.tz, stg]
  );
  const muKMap = cK(muPl);
  const muAsc = muPl.As?.sign || 1;
  const panchanga = computePanchanga(muDate, muTime, muPl, lang);

  return (
    <div
      style={{
        minHeight: "100vh",
        background:
          "linear-gradient(160deg,#0c0a12 0%,#08060e 50%,#0a0814 100%)",
        color: "#d0c8e0",
        fontFamily: "'Noto Sans JP','Noto Sans',system-ui,sans-serif",
      }}
    >
      <header
        style={{
          padding: "16px 16px 10px",
          borderBottom: "1px solid #1a1520",
          background: "linear-gradient(180deg,#100e18 0%,transparent 100%)",
        }}
      >
        <div style={{ maxWidth: maxW, margin: "0 auto" }}>
          <div
            style={{
              display: "flex",
              alignItems: "center",
              justifyContent: "space-between",
              marginBottom: 12,
            }}
          >
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <div
                style={{
                  width: 28,
                  height: 28,
                  borderRadius: "50%",
                  background:
                    "radial-gradient(circle at 40% 40%,#e8b04a,#8a5010)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  fontSize: "12px",
                  boxShadow: "0 0 16px #e8b04a30",
                }}
              >
                ☉
              </div>
              <h1
                style={{
                  margin: 0,
                  fontSize: wide ? "20px" : "16px",
                  fontWeight: 700,
                  color: "#e8daf0",
                }}
              >
                {t.title}
              </h1>
            </div>
            <button
              onClick={() => setLang(lang === "jp" ? "en" : "jp")}
              style={{
                padding: "4px 10px",
                border: "1px solid #2a2535",
                borderRadius: 4,
                cursor: "pointer",
                background: "transparent",
                color: "#e8b04a",
                fontSize: "10px",
                fontWeight: 700,
              }}
            >
              {t.lang}
            </button>
            <button
              onClick={() => setShowStg(!showStg)}
              style={{
                padding: "4px 10px",
                border: `1px solid ${showStg ? "#e8b04a40" : "#2a2535"}`,
                borderRadius: 4,
                cursor: "pointer",
                background: showStg ? "#1a1510" : "transparent",
                color: showStg ? "#e8b04a" : "#6a6080",
                fontSize: "10px",
                fontWeight: 700,
                marginLeft: 4,
              }}
            >
              ⚙
            </button>
          </div>
          <div
            style={{
              display: "flex",
              gap: 2,
              background: "#0a0810",
              borderRadius: 6,
              padding: 2,
            }}
          >
            {MT.map((t2) => (
              <button
                key={t2.id}
                onClick={() => setMainTab(t2.id)}
                style={{
                  flex: 1,
                  padding: "7px 4px 5px",
                  border: "none",
                  borderRadius: 4,
                  cursor: "pointer",
                  background: mainTab === t2.id ? "#1a1520" : "transparent",
                }}
              >
                <div
                  style={{
                    fontSize: "11px",
                    fontWeight: 600,
                    color: mainTab === t2.id ? "#e8b04a" : "#4a4058",
                  }}
                >
                  {t[t2.id] || t2.l}
                </div>
                <div
                  style={{
                    fontSize: "7px",
                    color: mainTab === t2.id ? "#8a7040" : "#2a2535",
                    marginTop: 1,
                  }}
                >
                  {t2.s}
                </div>
              </button>
            ))}
          </div>
        </div>
      </header>

      <main
        style={{
          maxWidth: maxW,
          margin: "0 auto",
          padding: wide ? "16px 24px 40px" : "12px 16px 40px",
        }}
      >
        {showStg && (
          <StgPanel
            stg={stg}
            setStg={setStg}
            lang={lang}
            onClose={() => setShowStg(false)}
          />
        )}
        {/* Current settings indicator */}
        <div
          style={{
            display: "flex",
            gap: 4,
            marginBottom: 10,
            flexWrap: "wrap",
          }}
        >
          {[
            { k: "ayanamsha", v: stg.ayanamsha, c: "#e8b04a" },
            {
              k: "node",
              v: stg.nodeType === "mean" ? "Mean" : "True",
              c: "#9070b0",
            },
            { k: "karaka", v: stg.karakaSystem + "K", c: "#5cb85c" },
            {
              k: "house",
              v:
                stg.houseSystem.charAt(0).toUpperCase() +
                stg.houseSystem.slice(1),
              c: "#40a0e0",
            },
          ].map((s) => (
            <span
              key={s.k}
              style={{
                fontSize: "8px",
                color: s.c,
                padding: "2px 6px",
                background: s.c + "12",
                borderRadius: 3,
                fontFamily: "'JetBrains Mono',monospace",
              }}
            >
              {s.v}
            </span>
          ))}
        </div>
        {mainTab === "birth" ? (
          <>
            <div
              style={{
                display: "flex",
                gap: 0,
                marginBottom: 14,
                borderBottom: "1px solid #1a1520",
              }}
            >
              {ST.map((t2) => (
                <button
                  key={t2.id}
                  onClick={() => setSubTab(t2.id)}
                  style={{
                    flex: 1,
                    padding: "9px 4px 7px",
                    border: "none",
                    cursor: "pointer",
                    background: "transparent",
                    borderBottom:
                      subTab === t2.id
                        ? "2px solid #e8b04a"
                        : "2px solid transparent",
                    color: subTab === t2.id ? "#e8b04a" : "#5a5068",
                    fontSize: "12px",
                    fontWeight: subTab === t2.id ? 600 : 400,
                  }}
                >
                  {t[t2.id] || t2.l}
                </button>
              ))}
            </div>

            {subTab === "chart" ? (
              <>
                <button
                  onClick={() => setShowForm(!showForm)}
                  style={{
                    width: "100%",
                    padding: "8px",
                    background: "#0e0c14",
                    border: "1px solid #1a1520",
                    borderRadius: showForm ? "8px 8px 0 0" : "8px",
                    color: "#6a6080",
                    fontSize: "10px",
                    cursor: "pointer",
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                  }}
                >
                  <span>{t.data}</span>
                  <span
                    style={{
                      transform: showForm ? "rotate(180deg)" : "none",
                      transition: "0.2s",
                    }}
                  >
                    ▾
                  </span>
                </button>
                {showForm && (
                  <BF
                    birthData={bd}
                    onApply={(d) => {
                      setBd(d);
                      setShowForm(false);
                      setViewAsc(null);
                      const loc = {
                        lat: d.lat,
                        lon: d.lon,
                        tz: d.tz,
                        place: d.place,
                      };
                      setTrLoc(loc);
                      setMuLoc(loc);
                    }}
                    onLoad={(d) => {
                      setBd(d);
                      setShowForm(false);
                      const loc = {
                        lat: d.lat,
                        lon: d.lon,
                        tz: d.tz,
                        place: d.place,
                      };
                      setTrLoc(loc);
                      setMuLoc(loc);
                    }}
                    t={t}
                    lang={lang}
                  />
                )}
                {!showForm && <div style={{ height: 6 }} />}

                {/* Birth time stepper for quick rectification */}
                <div
                  style={{
                    background: "#0e0c14",
                    border: "1px solid #1a1520",
                    borderRadius: 8,
                    padding: "8px 10px",
                    marginBottom: 8,
                  }}
                >
                  <div
                    style={{
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "space-between",
                      marginBottom: 6,
                    }}
                  >
                    <span style={{ fontSize: "9px", color: "#5a5068" }}>
                      {lang === "jp"
                        ? "出生時刻の微調整"
                        : "Birth Time Adjustment"}
                    </span>
                    <span
                      style={{
                        fontSize: "12px",
                        color: "#e8b04a",
                        fontWeight: 700,
                        fontFamily: "'JetBrains Mono',monospace",
                      }}
                    >
                      {bd.time || "--:--:--"}
                    </span>
                  </div>
                  <div
                    style={{
                      display: "flex",
                      gap: 3,
                      justifyContent: "center",
                      flexWrap: "wrap",
                    }}
                  >
                    {[
                      { l: "-5m", s: -300 },
                      { l: "-1m", s: -60 },
                      { l: "-10s", s: -10 },
                      { l: "-1s", s: -1 },
                      { l: "+1s", s: 1 },
                      { l: "+10s", s: 10 },
                      { l: "+1m", s: 60 },
                      { l: "+5m", s: 300 },
                    ].map((b) => {
                      const shift = () => {
                        const [hh, mm, ss] = (bd.time || "14:30:00")
                          .split(":")
                          .map(Number);
                        let total = hh * 3600 + mm * 60 + (ss || 0) + b.s;
                        total = ((total % 86400) + 86400) % 86400;
                        const nh = Math.floor(total / 3600);
                        const nm = Math.floor((total % 3600) / 60);
                        const ns = total % 60;
                        const newTime = `${String(nh).padStart(
                          2,
                          "0"
                        )}:${String(nm).padStart(2, "0")}:${String(ns).padStart(
                          2,
                          "0"
                        )}`;
                        setBd((prev) => ({ ...prev, time: newTime }));
                      };
                      return (
                        <button
                          key={b.l}
                          onClick={shift}
                          style={{
                            padding: "5px 7px",
                            border: "1px solid #2a2535",
                            borderRadius: 4,
                            cursor: "pointer",
                            background: "transparent",
                            color: b.s < 0 ? "#7888a0" : "#e8b04a",
                            fontSize: "10px",
                            fontWeight: 600,
                            fontFamily: "'JetBrains Mono',monospace",
                          }}
                        >
                          {b.l}
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* Rectification Tool Toggle */}
                <button
                  onClick={() => setShowRect(!showRect)}
                  style={{
                    width: "100%",
                    padding: "8px",
                    background: "#0e0c14",
                    border: "1px solid #1a1520",
                    borderRadius: showRect ? "8px 8px 0 0" : "8px",
                    color: showRect ? "#e8b04a" : "#4a4058",
                    fontSize: "10px",
                    cursor: "pointer",
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    marginBottom: showRect ? 0 : 14,
                  }}
                >
                  <span>
                    {lang === "jp"
                      ? "🔧 時刻修正ツール（レクティフィケーション）"
                      : "🔧 Rectification Tool"}
                  </span>
                  <span
                    style={{
                      transform: showRect ? "rotate(180deg)" : "none",
                      transition: "0.2s",
                    }}
                  >
                    ▾
                  </span>
                </button>
                {showRect && <RectPanel pl={pl} bd={bd} lang={lang} />}
                <CB birthData={bd} />
                <div
                  style={{
                    display: "flex",
                    gap: 0,
                    marginBottom: 14,
                    background: "#0e0c14",
                    borderRadius: 8,
                    padding: 3,
                    border: "1px solid #1a1520",
                  }}
                >
                  {[
                    { id: "south", l: t.south },
                    { id: "north", l: t.north },
                  ].map((s) => (
                    <button
                      key={s.id}
                      onClick={() => setCs(s.id)}
                      style={{
                        flex: 1,
                        padding: "8px 4px",
                        border: "none",
                        borderRadius: 6,
                        cursor: "pointer",
                        background: cs === s.id ? "#1a1520" : "transparent",
                        color: cs === s.id ? "#e8b04a" : "#5a5068",
                        fontSize: "12px",
                        fontWeight: 600,
                      }}
                    >
                      {s.l}
                    </button>
                  ))}
                </div>

                {/* Charts - 2 column on wide screens */}
                <div
                  style={{
                    display: wide ? "flex" : "block",
                    gap: wide ? 14 : 0,
                    alignItems: wide ? "stretch" : undefined,
                  }}
                >
                  <div
                    style={{
                      flex: wide ? "1 1 0" : undefined,
                      minWidth: wide ? 0 : undefined,
                    }}
                  >
                    <section
                      style={{
                        background: "#0a0810",
                        border: "1px solid #1a1520",
                        borderRadius: 8,
                        padding: "16px 8px",
                        marginBottom: wide ? 0 : 14,
                        height: wide ? "100%" : undefined,
                        boxSizing: "border-box",
                      }}
                    >
                      {viewAsc && viewAsc !== ascSign && (
                        <div
                          style={{
                            display: "flex",
                            justifyContent: "space-between",
                            alignItems: "center",
                            padding: "4px 8px 10px",
                          }}
                        >
                          <span style={{ fontSize: "10px", color: "#e8b04a" }}>
                            👁 {vLb} {t.viewing}（{SGN[viewAsc - 1].ab}=1H）
                          </span>
                          <button
                            onClick={() => setViewAsc(null)}
                            style={{
                              padding: "3px 10px",
                              border: "1px solid #2a2535",
                              borderRadius: 4,
                              cursor: "pointer",
                              background: "transparent",
                              color: "#6a6080",
                              fontSize: "9px",
                            }}
                          >
                            {t.reset}
                          </button>
                        </div>
                      )}
                      <div
                        style={{ display: "flex", justifyContent: "center" }}
                      >
                        <CC
                          pl={pl}
                          ascSign={eAsc}
                          kMap={kMap}
                          label="D1 — Rashi"
                          onSignTap={(s) => setViewAsc(s === eAsc ? null : s)}
                        />
                      </div>
                      <div
                        style={{
                          textAlign: "center",
                          marginTop: 6,
                          fontSize: "9px",
                          color: "#3a3048",
                        }}
                      >
                        {t.tapHint}
                      </div>
                    </section>
                  </div>

                  <div
                    style={{
                      flex: wide ? "1 1 0" : undefined,
                      minWidth: wide ? 0 : undefined,
                    }}
                  >
                    <section
                      style={{
                        background: "#0e0c14",
                        border: "1px solid #1a1520",
                        borderRadius: 8,
                        padding: "12px 8px",
                        marginBottom: wide ? 0 : 14,
                        height: wide ? "100%" : undefined,
                        boxSizing: "border-box",
                        display: "flex",
                        flexDirection: "column",
                      }}
                    >
                      <div
                        style={{
                          display: "flex",
                          justifyContent: "center",
                          flex: 1,
                        }}
                      >
                        {isVg ? (
                          <CC
                            pl={subPl}
                            ascSign={subPl.As.sign}
                            kMap={subKM}
                            label={subLb}
                          />
                        ) : subV === "AV" ? (
                          <SAVCh sav={sav} ascSign={eAsc} />
                        ) : subV === "BC" ? (
                          <CC
                            pl={pl}
                            ascSign={eAsc}
                            kMap={kMap}
                            label="Bhava Chalit"
                          />
                        ) : subV === "ML" ? (
                          <CC
                            pl={pl}
                            ascSign={pl.Mo.sign}
                            kMap={kMap}
                            label="Moon Lagna — 月ラグナ"
                          />
                        ) : subV === "SuL" ? (
                          <CC
                            pl={pl}
                            ascSign={pl.Su.sign}
                            kMap={kMap}
                            label="Sun Lagna — 太陽ラグナ"
                          />
                        ) : subV === "UG" ? (
                          <OvCh
                            items={ugs.map((u) => ({
                              id: u.id,
                              sign: u.sign,
                              deg: u.deg,
                              color: "#9070b0",
                              warn: u.warn,
                            }))}
                            ascSign={eAsc}
                            label="Upagraha"
                            sub="ウパグラハ"
                          />
                        ) : subV === "SL" ? (
                          <OvCh
                            items={sls.map((s) => ({
                              id: s.id,
                              sign: s.sign,
                              deg: s.deg,
                              color: "#e8b04a",
                            }))}
                            ascSign={eAsc}
                            label="Special Lagna"
                            sub="スペシャルラグナ"
                          />
                        ) : subV === "JP" ? (
                          <OvCh
                            items={padas.map((p) => ({
                              id: p.label,
                              sign: p.sign,
                              color: p.house === 1 ? "#e8b04a" : "#7888a0",
                            }))}
                            ascSign={eAsc}
                            label="Jaimini Pada"
                            sub="アルーダパダ"
                          />
                        ) : (
                          <div style={{ padding: "40px", textAlign: "center" }}>
                            <p style={{ color: "#3a3048" }}>実装予定</p>
                          </div>
                        )}
                      </div>
                      <div style={{ marginTop: 8 }}>
                        <div
                          style={{ display: "flex", gap: 0, marginBottom: 4 }}
                        >
                          {[
                            { id: "varga", l: t.varga },
                            { id: "special", l: t.special },
                          ].map((c) => (
                            <button
                              key={c.id}
                              onClick={() => {
                                setSubCat(c.id);
                                setSubV(c.id === "varga" ? "D9" : "BC");
                              }}
                              style={{
                                padding: "5px 14px",
                                border: "none",
                                cursor: "pointer",
                                fontSize: "10px",
                                fontWeight: 600,
                                background: "transparent",
                                borderBottom:
                                  subCat === c.id
                                    ? "2px solid #e8b04a"
                                    : "2px solid transparent",
                                color: subCat === c.id ? "#e8b04a" : "#4a4058",
                              }}
                            >
                              {c.l}
                            </button>
                          ))}
                        </div>
                        <div
                          style={{
                            display: "flex",
                            gap: 4,
                            overflowX: wide ? "visible" : "auto",
                            flexWrap: wide ? "wrap" : "nowrap",
                            padding: "4px 0",
                            WebkitOverflowScrolling: "touch",
                          }}
                        >
                          {(subCat === "varga" ? VI : SI).map((v) => (
                            <button
                              key={v.id}
                              onClick={() => setSubV(v.id)}
                              style={{
                                padding: wide ? "4px 8px" : "5px 10px",
                                border: "none",
                                borderRadius: 4,
                                cursor: "pointer",
                                flexShrink: wide ? undefined : 0,
                                background:
                                  subV === v.id ? "#1a1520" : "transparent",
                                color: subV === v.id ? "#e8b04a" : "#4a4058",
                                fontSize: wide ? "10px" : "11px",
                                fontWeight: subV === v.id ? 700 : 400,
                                fontFamily: "'JetBrains Mono',monospace",
                                whiteSpace: "nowrap",
                              }}
                            >
                              {v.id}
                            </button>
                          ))}
                        </div>
                      </div>
                    </section>
                  </div>
                </div>
                {wide && <div style={{ height: 14 }} />}

                <div
                  style={{
                    display: "flex",
                    flexWrap: "wrap",
                    gap: "6px 14px",
                    marginBottom: 10,
                    padding: "6px 12px",
                    fontSize: "10px",
                    color: "#5a5068",
                  }}
                >
                  <span>
                    <span style={{ color: "#e05555", fontWeight: 700 }}>*</span>
                    ={t.retro}
                  </span>
                  <span>
                    <svg
                      width="8"
                      height="8"
                      style={{ verticalAlign: "middle" }}
                    >
                      <circle cx="4" cy="4" r="2.5" fill="#7888a0" />
                    </svg>
                    ={t.asp}
                  </span>
                  <span>
                    <span style={{ color: "#8a80a0", fontWeight: 700 }}>
                      AK
                    </span>
                    ={t.karaka}
                  </span>
                  <span>
                    <span style={{ color: "#5cb85c", fontWeight: 700 }}>B</span>
                    ={t.ben}{" "}
                    <span style={{ color: "#e05555", fontWeight: 700 }}>M</span>
                    ={t.mal}{" "}
                    <span style={{ color: "#f0c040", fontWeight: 700 }}>
                      YK
                    </span>
                    ={t.yogaK}
                  </span>
                  <span>
                    <span style={{ color: "#5cb85c", fontWeight: 700 }}>
                      Ex
                    </span>
                    =高揚{" "}
                    <span style={{ color: "#e05555", fontWeight: 700 }}>
                      Db
                    </span>
                    =減衰{" "}
                    <span style={{ color: "#e8b04a", fontWeight: 700 }}>
                      MT
                    </span>
                    =MT{" "}
                    <span style={{ color: "#40a0e0", fontWeight: 700 }}>
                      Sw
                    </span>
                    =定座
                  </span>
                  <span>
                    <span style={{ color: "#e05555", fontWeight: 700 }}>m</span>
                    ={t.mrityu}{" "}
                    <span style={{ color: "#e05555", fontWeight: 700 }}>G</span>
                    ={t.gandanta}
                  </span>
                </div>

                <button
                  onClick={() => setShowTbl(!showTbl)}
                  style={{
                    width: "100%",
                    padding: "10px",
                    background: "#0e0c14",
                    border: "1px solid #1a1520",
                    borderRadius: showTbl ? "8px 8px 0 0" : "8px",
                    color: "#7a7090",
                    fontSize: "11px",
                    cursor: "pointer",
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                  }}
                >
                  <span>
                    {t.planets} — {tLb}
                  </span>
                  <span
                    style={{
                      transform: showTbl ? "rotate(180deg)" : "none",
                      transition: "0.2s",
                    }}
                  >
                    ▾
                  </span>
                </button>
                {showTbl && (
                  <section
                    style={{
                      background: "#0a0810",
                      border: "1px solid #1a1520",
                      borderTop: "none",
                      borderRadius: "0 0 8px 8px",
                      padding: "10px",
                    }}
                  >
                    <PTb pl={tPl} kMap={tKM} fn={fn} />
                  </section>
                )}

                <section
                  style={{
                    marginTop: 14,
                    padding: "10px 14px",
                    background: "#0e0c14",
                    border: "1px solid #1a1520",
                    borderRadius: 8,
                  }}
                >
                  <div
                    style={{
                      display: "flex",
                      flexWrap: "wrap",
                      gap: "4px 12px",
                    }}
                  >
                    {PL.map((p) => (
                      <span
                        key={p.id}
                        style={{
                          fontSize: "10px",
                          display: "flex",
                          alignItems: "center",
                          gap: 3,
                        }}
                      >
                        <span
                          style={{
                            width: 7,
                            height: 7,
                            borderRadius: "50%",
                            background: p.color,
                            display: "inline-block",
                          }}
                        />
                        <span style={{ color: p.color, fontWeight: 600 }}>
                          {p.id}
                        </span>
                        <span style={{ color: "#4a4058" }}>{p.jp}</span>
                      </span>
                    ))}
                  </div>
                </section>
              </>
            ) : subTab === "dasha" ? (
              <section
                style={{
                  background: "#0e0c14",
                  border: "1px solid #1a1520",
                  borderRadius: 8,
                  padding: "12px",
                }}
              >
                <DashaPanel
                  placements={pl}
                  birthDate={bd.date}
                  ascSign={eAsc}
                />
              </section>
            ) : subTab === "yoga" ? (
              <section
                style={{
                  background: "#0e0c14",
                  border: "1px solid #1a1520",
                  borderRadius: 8,
                  padding: "12px",
                }}
              >
                <YogaPanel yogas={yogas} t={t} />
              </section>
            ) : (
              <section
                style={{
                  background: "#0e0c14",
                  border: "1px solid #1a1520",
                  borderRadius: 8,
                  padding: "12px",
                }}
              >
                <BalaPanel placements={pl} ascSign={eAsc} lang={lang} />
              </section>
            )}
          </>
        ) : mainTab === "varsha" ? (
          <>
            {/* Year Selector */}
            <div
              style={{
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                gap: 12,
                marginBottom: 14,
                padding: "12px",
                background: "#0e0c14",
                border: "1px solid #1a1520",
                borderRadius: 8,
              }}
            >
              <button
                onClick={() => setVYear((y) => Math.max(birthYear, y - 1))}
                style={{
                  width: 36,
                  height: 36,
                  border: "1px solid #2a2535",
                  borderRadius: "50%",
                  background: "transparent",
                  color: "#e8b04a",
                  fontSize: "16px",
                  cursor: "pointer",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                }}
              >
                ◀
              </button>
              <div style={{ textAlign: "center", minWidth: 100 }}>
                <div
                  style={{
                    color: "#e8b04a",
                    fontSize: "22px",
                    fontWeight: 700,
                    fontFamily: "'JetBrains Mono',monospace",
                  }}
                >
                  {vYear}
                </div>
                <div style={{ color: "#5a5068", fontSize: "9px" }}>
                  {lang === "jp"
                    ? `${vAge}歳（${birthYear}年生）`
                    : `Age ${vAge} (born ${birthYear})`}
                </div>
              </div>
              <button
                onClick={() => setVYear((y) => y + 1)}
                style={{
                  width: 36,
                  height: 36,
                  border: "1px solid #2a2535",
                  borderRadius: "50%",
                  background: "transparent",
                  color: "#e8b04a",
                  fontSize: "16px",
                  cursor: "pointer",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                }}
              >
                ▶
              </button>
            </div>

            <CB birthData={bd} />

            {vPl ? (
              <>
                {/* Key info cards */}
                <div
                  style={{
                    display: "grid",
                    gridTemplateColumns: "1fr 1fr 1fr",
                    gap: 6,
                    marginBottom: 14,
                  }}
                >
                  <div
                    style={{
                      background: "#0a0810",
                      border: "1px solid #1a1520",
                      borderRadius: 6,
                      padding: "10px 8px",
                      textAlign: "center",
                    }}
                  >
                    <div
                      style={{
                        fontSize: "8px",
                        color: "#4a4058",
                        marginBottom: 4,
                      }}
                    >
                      {lang === "jp" ? "ヴァルシャラグナ" : "Varsha Lagna"}
                    </div>
                    <div
                      style={{
                        color: "#e8b04a",
                        fontWeight: 700,
                        fontSize: "14px",
                        fontFamily: "'JetBrains Mono',monospace",
                      }}
                    >
                      {SGN[vAsc - 1].ab}
                    </div>
                  </div>
                  <div
                    style={{
                      background: "#0a0810",
                      border: "1px solid #1a1520",
                      borderRadius: 6,
                      padding: "10px 8px",
                      textAlign: "center",
                    }}
                  >
                    <div
                      style={{
                        fontSize: "8px",
                        color: "#4a4058",
                        marginBottom: 4,
                      }}
                    >
                      {lang === "jp" ? "ムンタ" : "Muntha"}
                    </div>
                    {(() => {
                      const mun = munDesc(vMunSign, vAsc, vPl, lang);
                      return (
                        <div
                          style={{
                            color:
                              inKendra(mun.house) || inTrine(mun.house)
                                ? "#5cb85c"
                                : "#e05555",
                            fontWeight: 700,
                            fontSize: "14px",
                            fontFamily: "'JetBrains Mono',monospace",
                          }}
                        >
                          {mun.label}
                        </div>
                      );
                    })()}
                  </div>
                  <div
                    style={{
                      background: "#0a0810",
                      border: "1px solid #1a1520",
                      borderRadius: 6,
                      padding: "10px 8px",
                      textAlign: "center",
                    }}
                  >
                    <div
                      style={{
                        fontSize: "8px",
                        color: "#4a4058",
                        marginBottom: 4,
                      }}
                    >
                      {lang === "jp" ? "年主星" : "Year Lord"}
                    </div>
                    <div
                      style={{
                        color: pCol(vYearLord),
                        fontWeight: 700,
                        fontSize: "14px",
                        fontFamily: "'JetBrains Mono',monospace",
                      }}
                    >
                      {vYearLord}
                    </div>
                  </div>
                </div>

                {/* Muntha detail */}
                {(() => {
                  const mun = munDesc(vMunSign, vAsc, vPl, lang);
                  return (
                    <div
                      style={{
                        background: "#0a0810",
                        border: "1px solid #1a1520",
                        borderRadius: 6,
                        padding: "10px 12px",
                        marginBottom: 14,
                      }}
                    >
                      <div
                        style={{
                          display: "flex",
                          gap: 12,
                          alignItems: "center",
                          marginBottom: 4,
                        }}
                      >
                        <span
                          style={{
                            fontSize: "10px",
                            color: "#6a6080",
                            fontWeight: 600,
                          }}
                        >
                          {lang === "jp" ? "ムンタ詳細" : "Muntha Detail"}
                        </span>
                        <span
                          style={{
                            color: "#c8c0d0",
                            fontWeight: 700,
                            fontSize: "12px",
                          }}
                        >
                          {SGN[vMunSign - 1].ab}
                        </span>
                        <span style={{ color: "#5a5068", fontSize: "10px" }}>
                          → {mun.house}H
                        </span>
                        <span style={{ color: "#5a5068", fontSize: "10px" }}>
                          {lang === "jp" ? "支配星" : "Lord"}:{" "}
                          <span style={{ color: pCol(mun.lord) }}>
                            {mun.lord}
                          </span>{" "}
                          in {mun.lordH}H
                        </span>
                      </div>
                      <div
                        style={{
                          fontSize: "10px",
                          color: "#8a80a0",
                          lineHeight: "1.4",
                        }}
                      >
                        {mun.effect}
                      </div>
                    </div>
                  );
                })()}

                {/* Chart style toggle */}
                <div
                  style={{
                    display: "flex",
                    gap: 0,
                    marginBottom: 14,
                    background: "#0e0c14",
                    borderRadius: 8,
                    padding: 3,
                    border: "1px solid #1a1520",
                  }}
                >
                  {[
                    { id: "south", l: t.south },
                    { id: "north", l: t.north },
                  ].map((s) => (
                    <button
                      key={s.id}
                      onClick={() => setCs(s.id)}
                      style={{
                        flex: 1,
                        padding: "8px 4px",
                        border: "none",
                        borderRadius: 6,
                        cursor: "pointer",
                        background: cs === s.id ? "#1a1520" : "transparent",
                        color: cs === s.id ? "#e8b04a" : "#5a5068",
                        fontSize: "12px",
                        fontWeight: 600,
                      }}
                    >
                      {s.l}
                    </button>
                  ))}
                </div>

                {/* Charts - 2 column on wide screens */}
                <div
                  style={{
                    display: wide ? "flex" : "block",
                    gap: wide ? 14 : 0,
                    alignItems: wide ? "stretch" : undefined,
                  }}
                >
                  <div
                    style={{
                      flex: wide ? "1 1 0" : undefined,
                      minWidth: wide ? 0 : undefined,
                    }}
                  >
                    {/* Annual Chart */}
                    <section
                      style={{
                        background: "#0a0810",
                        border: "1px solid #1a1520",
                        borderRadius: 8,
                        padding: "16px 8px",
                        marginBottom: wide ? 0 : 14,
                        height: wide ? "100%" : undefined,
                        boxSizing: "border-box",
                      }}
                    >
                      <div
                        style={{ display: "flex", justifyContent: "center" }}
                      >
                        <CC
                          pl={vPl}
                          ascSign={vAsc}
                          kMap={vKMap}
                          label={`Varsha ${vYear} — ${
                            lang === "jp" ? "年運図" : "Annual Chart"
                          }`}
                        />
                      </div>
                      <div style={{ textAlign: "center", marginTop: 8 }}>
                        <span
                          style={{
                            fontSize: "10px",
                            color: "#e8b04a",
                            padding: "3px 10px",
                            background: "#e8b04a15",
                            borderRadius: 4,
                          }}
                        >
                          ☽ {lang === "jp" ? "ムンタ" : "Muntha"}:{" "}
                          {SGN[vMunSign - 1].ab} (
                          {(() => {
                            const mun = munDesc(vMunSign, vAsc, vPl, lang);
                            return mun.house;
                          })()}
                          H)
                        </span>
                      </div>
                    </section>
                  </div>

                  <div
                    style={{
                      flex: wide ? "1 1 0" : undefined,
                      minWidth: wide ? 0 : undefined,
                    }}
                  >
                    {/* Divisional charts (natal) */}
                    <section
                      style={{
                        background: "#0e0c14",
                        border: "1px solid #1a1520",
                        borderRadius: 8,
                        padding: "12px 8px",
                        marginBottom: wide ? 0 : 14,
                        height: wide ? "100%" : undefined,
                        boxSizing: "border-box",
                        display: "flex",
                        flexDirection: "column",
                      }}
                    >
                      <div
                        style={{
                          display: "flex",
                          justifyContent: "center",
                          flex: 1,
                        }}
                      >
                        {isVg ? (
                          <CC
                            pl={subPl}
                            ascSign={subPl.As.sign}
                            kMap={subKM}
                            label={subLb}
                          />
                        ) : subV === "AV" ? (
                          <SAVCh sav={sav} ascSign={eAsc} />
                        ) : subV === "BC" ? (
                          <CC
                            pl={pl}
                            ascSign={eAsc}
                            kMap={kMap}
                            label="Bhava Chalit"
                          />
                        ) : subV === "ML" ? (
                          <CC
                            pl={pl}
                            ascSign={pl.Mo.sign}
                            kMap={kMap}
                            label="Moon Lagna"
                          />
                        ) : subV === "SuL" ? (
                          <CC
                            pl={pl}
                            ascSign={pl.Su.sign}
                            kMap={kMap}
                            label="Sun Lagna"
                          />
                        ) : subV === "UG" ? (
                          <OvCh
                            items={ugs.map((u) => ({
                              id: u.id,
                              sign: u.sign,
                              deg: u.deg,
                              color: "#9070b0",
                              warn: u.warn,
                            }))}
                            ascSign={eAsc}
                            label="Upagraha"
                          />
                        ) : subV === "SL" ? (
                          <OvCh
                            items={sls.map((s) => ({
                              id: s.id,
                              sign: s.sign,
                              deg: s.deg,
                              color: "#e8b04a",
                            }))}
                            ascSign={eAsc}
                            label="Special Lagna"
                          />
                        ) : subV === "JP" ? (
                          <OvCh
                            items={padas.map((p) => ({
                              id: p.label,
                              sign: p.sign,
                              color: p.house === 1 ? "#e8b04a" : "#7888a0",
                            }))}
                            ascSign={eAsc}
                            label="Jaimini Pada"
                          />
                        ) : (
                          <div style={{ padding: "40px", textAlign: "center" }}>
                            <p style={{ color: "#3a3048" }}>{t.todo}</p>
                          </div>
                        )}
                      </div>
                      <div style={{ marginTop: 8 }}>
                        <div
                          style={{ display: "flex", gap: 0, marginBottom: 4 }}
                        >
                          {[
                            { id: "varga", l: t.varga },
                            { id: "special", l: t.special },
                          ].map((c) => (
                            <button
                              key={c.id}
                              onClick={() => {
                                setSubCat(c.id);
                                setSubV(c.id === "varga" ? "D9" : "BC");
                              }}
                              style={{
                                padding: "5px 14px",
                                border: "none",
                                cursor: "pointer",
                                fontSize: "10px",
                                fontWeight: 600,
                                background: "transparent",
                                borderBottom:
                                  subCat === c.id
                                    ? "2px solid #e8b04a"
                                    : "2px solid transparent",
                                color: subCat === c.id ? "#e8b04a" : "#4a4058",
                              }}
                            >
                              {c.l}
                            </button>
                          ))}
                        </div>
                        <div
                          style={{
                            display: "flex",
                            gap: 4,
                            overflowX: wide ? "visible" : "auto",
                            flexWrap: wide ? "wrap" : "nowrap",
                            padding: "4px 0",
                            WebkitOverflowScrolling: "touch",
                          }}
                        >
                          {(subCat === "varga" ? VI : SI).map((v) => (
                            <button
                              key={v.id}
                              onClick={() => setSubV(v.id)}
                              style={{
                                padding: wide ? "4px 8px" : "5px 10px",
                                border: "none",
                                borderRadius: 4,
                                cursor: "pointer",
                                flexShrink: wide ? undefined : 0,
                                background:
                                  subV === v.id ? "#1a1520" : "transparent",
                                color: subV === v.id ? "#e8b04a" : "#4a4058",
                                fontSize: wide ? "10px" : "11px",
                                fontWeight: subV === v.id ? 700 : 400,
                                fontFamily: "'JetBrains Mono',monospace",
                                whiteSpace: "nowrap",
                              }}
                            >
                              {v.id}
                            </button>
                          ))}
                        </div>
                      </div>
                    </section>
                  </div>
                </div>
                {wide && <div style={{ height: 14 }} />}

                {/* Sahams */}
                <section
                  style={{
                    background: "#0e0c14",
                    border: "1px solid #1a1520",
                    borderRadius: 8,
                    padding: "12px",
                    marginBottom: 14,
                  }}
                >
                  <button
                    onClick={() =>
                      setVDetail(vDetail === "saham" ? null : "saham")
                    }
                    style={{
                      width: "100%",
                      background: "transparent",
                      border: "none",
                      cursor: "pointer",
                      display: "flex",
                      justifyContent: "space-between",
                      alignItems: "center",
                      padding: "0 0 4px",
                    }}
                  >
                    <span
                      style={{
                        fontSize: "11px",
                        color: "#7a7090",
                        fontWeight: 600,
                      }}
                    >
                      {lang === "jp"
                        ? "サハム（感受点）"
                        : "Sahams (Sensitive Points)"}{" "}
                      ({vSahams.length})
                    </span>
                    <span style={{ color: "#3a3048", fontSize: "10px" }}>
                      {vDetail === "saham" ? "▾" : "▸"}
                    </span>
                  </button>
                  {vDetail === "saham" && (
                    <div>
                      {vSahams.map((s, i) => (
                        <div
                          key={i}
                          style={{
                            padding: "7px 4px",
                            borderTop: "1px solid #1a1520",
                          }}
                        >
                          <div
                            style={{
                              display: "flex",
                              justifyContent: "space-between",
                              alignItems: "center",
                            }}
                          >
                            <div
                              style={{
                                display: "flex",
                                alignItems: "center",
                                gap: 6,
                              }}
                            >
                              <span
                                style={{
                                  color:
                                    s.type === "+"
                                      ? "#5cb85c"
                                      : s.type === "-"
                                      ? "#e05555"
                                      : "#e8b04a",
                                  fontWeight: 700,
                                  fontSize: "11px",
                                  fontFamily: "'JetBrains Mono',monospace",
                                }}
                              >
                                {s.id}
                              </span>
                              <span
                                style={{ color: "#8a80a0", fontSize: "10px" }}
                              >
                                {s.name}
                              </span>
                            </div>
                            <span
                              style={{
                                color: "#c8c0d0",
                                fontSize: "11px",
                                fontFamily: "'JetBrains Mono',monospace",
                              }}
                            >
                              {SGN[s.sign - 1].ab} {fD(s.deg)}
                            </span>
                          </div>
                          <div
                            style={{
                              fontSize: "9px",
                              color: "#5a5068",
                              marginTop: 2,
                            }}
                          >
                            {s.desc}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </section>

                {/* Harsha Bala */}
                <section
                  style={{
                    background: "#0e0c14",
                    border: "1px solid #1a1520",
                    borderRadius: 8,
                    padding: "12px",
                    marginBottom: 14,
                  }}
                >
                  <button
                    onClick={() =>
                      setVDetail(vDetail === "harsha" ? null : "harsha")
                    }
                    style={{
                      width: "100%",
                      background: "transparent",
                      border: "none",
                      cursor: "pointer",
                      display: "flex",
                      justifyContent: "space-between",
                      alignItems: "center",
                      padding: "0 0 4px",
                    }}
                  >
                    <span
                      style={{
                        fontSize: "11px",
                        color: "#7a7090",
                        fontWeight: 600,
                      }}
                    >
                      {lang === "jp"
                        ? "ハルシャバラ（年運の惑星力）"
                        : "Harsha Bala (Annual Strength)"}
                    </span>
                    <span style={{ color: "#3a3048", fontSize: "10px" }}>
                      {vDetail === "harsha" ? "▾" : "▸"}
                    </span>
                  </button>
                  {vDetail === "harsha" &&
                    (() => {
                      const ps7 = ["Su", "Mo", "Ma", "Me", "Ju", "Ve", "Sa"];
                      const maxH = Math.max(
                        ...ps7.map((p) => vHarsha[p]?.total || 0)
                      );
                      return (
                        <div>
                          <div
                            style={{
                              display: "flex",
                              gap: 6,
                              flexWrap: "wrap",
                              marginBottom: 10,
                              padding: "6px 0",
                            }}
                          >
                            {[
                              {
                                id: "pv",
                                l: lang === "jp" ? "品位" : "Dignity",
                                c: "#5cb85c",
                              },
                              {
                                id: "res",
                                l: lang === "jp" ? "在住" : "Residence",
                                c: "#40a0e0",
                              },
                              {
                                id: "nat",
                                l: lang === "jp" ? "出生一致" : "Natal",
                                c: "#e8b04a",
                              },
                              {
                                id: "motion",
                                l: lang === "jp" ? "運動" : "Motion",
                                c: "#e890c0",
                              },
                              {
                                id: "asp",
                                l: lang === "jp" ? "視線" : "Aspect",
                                c: "#9070b0",
                              },
                            ].map((c) => (
                              <span
                                key={c.id}
                                style={{
                                  display: "flex",
                                  alignItems: "center",
                                  gap: 3,
                                  fontSize: "8px",
                                }}
                              >
                                <span
                                  style={{
                                    width: 6,
                                    height: 6,
                                    borderRadius: 2,
                                    background: c.c,
                                  }}
                                />
                                <span style={{ color: "#5a5068" }}>{c.l}</span>
                              </span>
                            ))}
                          </div>
                          {[...ps7]
                            .sort(
                              (a, b) =>
                                (vHarsha[b]?.total || 0) -
                                (vHarsha[a]?.total || 0)
                            )
                            .map((pid) => {
                              const hd = vHarsha[pid];
                              if (!hd) return null;
                              return (
                                <div
                                  key={pid}
                                  style={{
                                    display: "flex",
                                    alignItems: "center",
                                    gap: 8,
                                    padding: "5px 0",
                                  }}
                                >
                                  <span
                                    style={{
                                      color: pCol(pid),
                                      fontWeight: 700,
                                      fontSize: "12px",
                                      fontFamily: "'JetBrains Mono',monospace",
                                      minWidth: 22,
                                    }}
                                  >
                                    {pid}
                                  </span>
                                  <div
                                    style={{
                                      flex: 1,
                                      display: "flex",
                                      height: 12,
                                      borderRadius: 3,
                                      overflow: "hidden",
                                      background: "#1a1520",
                                    }}
                                  >
                                    {[
                                      { v: hd.pv, c: "#5cb85c" },
                                      { v: hd.res, c: "#40a0e0" },
                                      { v: hd.nat, c: "#e8b04a" },
                                      { v: hd.motion, c: "#e890c0" },
                                      { v: hd.asp, c: "#9070b0" },
                                    ].map((s, si) => (
                                      <div
                                        key={si}
                                        style={{
                                          width: `${((s.v / maxH) * 100) / 5}%`,
                                          background: s.c,
                                          opacity: 0.8,
                                        }}
                                      />
                                    ))}
                                  </div>
                                  <span
                                    style={{
                                      color: "#c8c0d0",
                                      fontSize: "11px",
                                      fontWeight: 700,
                                      fontFamily: "'JetBrains Mono',monospace",
                                      minWidth: 32,
                                      textAlign: "right",
                                    }}
                                  >
                                    {hd.total.toFixed(1)}
                                  </span>
                                </div>
                              );
                            })}
                        </div>
                      );
                    })()}
                </section>

                {/* Varsha Planet Table */}
                <button
                  onClick={() => setShowTbl(!showTbl)}
                  style={{
                    width: "100%",
                    padding: "10px",
                    background: "#0e0c14",
                    border: "1px solid #1a1520",
                    borderRadius: showTbl ? "8px 8px 0 0" : "8px",
                    color: "#7a7090",
                    fontSize: "11px",
                    cursor: "pointer",
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                  }}
                >
                  <span>
                    {t.planets} — Varsha {vYear}
                  </span>
                  <span
                    style={{
                      transform: showTbl ? "rotate(180deg)" : "none",
                      transition: "0.2s",
                    }}
                  >
                    ▾
                  </span>
                </button>
                {showTbl && (
                  <section
                    style={{
                      background: "#0a0810",
                      border: "1px solid #1a1520",
                      borderTop: "none",
                      borderRadius: "0 0 8px 8px",
                      padding: "10px",
                    }}
                  >
                    <PTb pl={vPl} kMap={vKMap} fn={cFN(vAsc)} />
                  </section>
                )}
              </>
            ) : (
              <div
                style={{ padding: 30, textAlign: "center", color: "#4a4058" }}
              >
                {lang === "jp"
                  ? "出生年以降を選択してください"
                  : "Select a year after birth"}
              </div>
            )}
          </>
        ) : mainTab === "transit" ? (
          <>
            {/* Date/Time selector */}
            <div
              style={{
                background: "#0e0c14",
                border: "1px solid #1a1520",
                borderRadius: 8,
                padding: "12px",
                marginBottom: 14,
              }}
            >
              <div style={{ display: "flex", gap: 8, marginBottom: 8 }}>
                <div style={{ flex: 1 }}>
                  <label
                    style={{
                      display: "block",
                      fontSize: "8px",
                      color: "#4a4058",
                      marginBottom: 3,
                    }}
                  >
                    {lang === "jp" ? "日付" : "Date"}
                  </label>
                  <input
                    type="date"
                    value={trDate}
                    onChange={(e) => setTrDate(e.target.value)}
                    style={{
                      ...IS,
                      textAlign: "left",
                      WebkitAppearance: "none",
                      appearance: "none",
                      paddingRight: "4px",
                    }}
                  />
                </div>
                <div style={{ flex: 1 }}>
                  <label
                    style={{
                      display: "block",
                      fontSize: "8px",
                      color: "#4a4058",
                      marginBottom: 3,
                    }}
                  >
                    {lang === "jp" ? "時刻" : "Time"}
                  </label>
                  <input
                    type="time"
                    step="1"
                    value={trTime}
                    onChange={(e) => setTrTime(e.target.value)}
                    style={{
                      ...IS,
                      WebkitAppearance: "none",
                      appearance: "none",
                      paddingRight: "4px",
                    }}
                  />
                </div>
              </div>
              <button
                onClick={() => {
                  const n = new Date();
                  setTrDate(localDS(n));
                  setTrTime(localTS(n));
                }}
                style={{
                  width: "100%",
                  padding: "8px",
                  border: "1px solid #e8b04a40",
                  borderRadius: 4,
                  cursor: "pointer",
                  background: "linear-gradient(135deg,#2a1f10,#1a1510)",
                  color: "#e8b04a",
                  fontSize: "11px",
                  fontWeight: 600,
                }}
              >
                {lang === "jp" ? "⟳ 現在の日時" : "⟳ Now"}
              </button>
            </div>

            <LocPicker loc={trLoc} setLoc={setTrLoc} lang={lang} />

            <CB birthData={bd} />

            {/* Sade Sati indicator */}
            {sadeSati && sadeSati.active && (
              <div
                style={{
                  background: sadeSati.active ? "#2a151520" : "#0a0810",
                  border: `1px solid ${
                    sadeSati.active ? "#e0555540" : "#1a1520"
                  }`,
                  borderRadius: 6,
                  padding: "10px 12px",
                  marginBottom: 14,
                }}
              >
                <div
                  style={{
                    display: "flex",
                    alignItems: "center",
                    gap: 8,
                    marginBottom: 4,
                  }}
                >
                  <span
                    style={{
                      fontSize: "11px",
                      color: "#e05555",
                      fontWeight: 700,
                    }}
                  >
                    ⚠ {lang === "jp" ? "サデサティ" : "Sade Sati"}
                  </span>
                  <span
                    style={{
                      fontSize: "10px",
                      color: "#e8b04a",
                      padding: "2px 8px",
                      background: "#e8b04a15",
                      borderRadius: 3,
                    }}
                  >
                    {sadeSati.phase}
                  </span>
                </div>
                <div
                  style={{
                    fontSize: "10px",
                    color: "#8a80a0",
                    lineHeight: "1.4",
                  }}
                >
                  {sadeSati.desc}
                </div>
              </div>
            )}

            {/* Chart style toggle */}
            <div
              style={{
                display: "flex",
                gap: 0,
                marginBottom: 14,
                background: "#0e0c14",
                borderRadius: 8,
                padding: 3,
                border: "1px solid #1a1520",
              }}
            >
              {[
                { id: "south", l: t.south },
                { id: "north", l: t.north },
              ].map((s) => (
                <button
                  key={s.id}
                  onClick={() => setCs(s.id)}
                  style={{
                    flex: 1,
                    padding: "8px 4px",
                    border: "none",
                    borderRadius: 6,
                    cursor: "pointer",
                    background: cs === s.id ? "#1a1520" : "transparent",
                    color: cs === s.id ? "#e8b04a" : "#5a5068",
                    fontSize: "12px",
                    fontWeight: 600,
                  }}
                >
                  {s.l}
                </button>
              ))}
            </div>

            {/* Charts - 2 column on wide screens */}
            <div
              style={{
                display: wide ? "flex" : "block",
                gap: wide ? 14 : 0,
                alignItems: wide ? "stretch" : undefined,
              }}
            >
              <div
                style={{
                  flex: wide ? "1 1 0" : undefined,
                  minWidth: wide ? 0 : undefined,
                }}
              >
                {/* Transit Chart */}
                <section
                  style={{
                    background: "#0a0810",
                    border: "1px solid #1a1520",
                    borderRadius: 8,
                    padding: "16px 8px",
                    marginBottom: 0,
                  }}
                >
                  <div style={{ display: "flex", justifyContent: "center" }}>
                    <CC
                      pl={trPl}
                      ascSign={trAsc}
                      kMap={trKMap}
                      label={`Transit — ${trDate} ${(trTime || "").slice(
                        0,
                        5
                      )}`}
                    />
                  </div>
                </section>

                {/* Time stepper - directly below chart */}
                <div
                  style={{
                    background: "#0e0c14",
                    border: "1px solid #1a1520",
                    borderTop: "none",
                    borderRadius: "0 0 8px 8px",
                    padding: "10px 12px",
                    marginBottom: 14,
                  }}
                >
                  <TimeStepper
                    date={trDate}
                    time={trTime}
                    setDate={setTrDate}
                    setTime={setTrTime}
                    lang={lang}
                  />
                </div>
              </div>

              <div
                style={{
                  flex: wide ? "1 1 0" : undefined,
                  minWidth: wide ? 0 : undefined,
                }}
              >
                {/* Natal Chart (reference) */}
                <section
                  style={{
                    background: "#0a0810",
                    border: "1px solid #1a1520",
                    borderRadius: 8,
                    padding: "16px 8px",
                    marginBottom: 14,
                  }}
                >
                  <div style={{ display: "flex", justifyContent: "center" }}>
                    <CC
                      pl={pl}
                      ascSign={ascSign}
                      kMap={kMap}
                      label={`Natal D1 — ${
                        lang === "jp" ? "出生図" : "Birth Chart"
                      }`}
                    />
                  </div>
                </section>
              </div>
            </div>

            {/* Gochara Analysis */}
            <section
              style={{
                background: "#0e0c14",
                border: "1px solid #1a1520",
                borderRadius: 8,
                padding: "12px",
                marginBottom: 14,
              }}
            >
              <button
                onClick={() =>
                  setTrDetail(trDetail === "gochara" ? null : "gochara")
                }
                style={{
                  width: "100%",
                  background: "transparent",
                  border: "none",
                  cursor: "pointer",
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                  padding: "0 0 4px",
                }}
              >
                <span
                  style={{
                    fontSize: "11px",
                    color: "#7a7090",
                    fontWeight: 600,
                  }}
                >
                  {lang === "jp"
                    ? "ゴーチャラ分析（月からのトランジット）"
                    : "Gochara Analysis (Transit from Moon)"}
                </span>
                <span style={{ color: "#3a3048", fontSize: "10px" }}>
                  {trDetail === "gochara" ? "▾" : "▸"}
                </span>
              </button>
              {trDetail === "gochara" && (
                <div>
                  <div
                    style={{
                      fontSize: "9px",
                      color: "#5a5068",
                      padding: "4px 0 8px",
                    }}
                  >
                    {lang === "jp"
                      ? `出生月: ${
                          SGN[pl.Mo.sign - 1].ab
                        } — トランジット惑星の月からのハウス位置`
                      : `Natal Moon: ${
                          SGN[pl.Mo.sign - 1].ab
                        } — Transit planets' house from Moon`}
                  </div>
                  {gochara.map((g, i) => (
                    <div
                      key={i}
                      style={{
                        padding: "8px 4px",
                        borderTop: "1px solid #1a1520",
                        borderLeft: `3px solid ${
                          g.finalEff === "+"
                            ? "#5cb85c"
                            : g.finalEff === "-"
                            ? "#e05555"
                            : "#e8b04a"
                        }`,
                      }}
                    >
                      <div
                        style={{
                          display: "flex",
                          justifyContent: "space-between",
                          alignItems: "center",
                          marginBottom: 3,
                        }}
                      >
                        <div
                          style={{
                            display: "flex",
                            alignItems: "center",
                            gap: 8,
                          }}
                        >
                          <span
                            style={{
                              color: pCol(g.pid),
                              fontWeight: 700,
                              fontFamily: "'JetBrains Mono',monospace",
                              fontSize: "12px",
                            }}
                          >
                            {g.pid}
                            {g.retro ? "*" : ""}
                          </span>
                          <span
                            style={{
                              color: "#c8c0d0",
                              fontSize: "10px",
                              fontFamily: "'JetBrains Mono',monospace",
                            }}
                          >
                            {SGN[g.sign - 1].ab} {fD(g.deg)}
                          </span>
                          <span style={{ color: "#5a5068", fontSize: "10px" }}>
                            → {g.hFromMo}H
                          </span>
                        </div>
                        <div
                          style={{
                            display: "flex",
                            gap: 4,
                            alignItems: "center",
                          }}
                        >
                          {g.vedha && (
                            <span
                              style={{
                                fontSize: "8px",
                                color: "#e8b04a",
                                padding: "1px 5px",
                                background: "#e8b04a15",
                                borderRadius: 3,
                              }}
                            >
                              {lang === "jp" ? "ヴェーダ" : "Vedha"}
                            </span>
                          )}
                          <span
                            style={{
                              color:
                                g.finalEff === "+"
                                  ? "#5cb85c"
                                  : g.finalEff === "-"
                                  ? "#e05555"
                                  : "#e8b04a",
                              fontSize: "9px",
                              fontWeight: 700,
                              padding: "1px 6px",
                              background:
                                (g.finalEff === "+"
                                  ? "#5cb85c"
                                  : g.finalEff === "-"
                                  ? "#e05555"
                                  : "#e8b04a") + "15",
                              borderRadius: 3,
                            }}
                          >
                            {g.finalEff === "+"
                              ? lang === "jp"
                                ? "吉"
                                : "Good"
                              : g.finalEff === "-"
                              ? lang === "jp"
                                ? "凶"
                                : "Bad"
                              : lang === "jp"
                              ? "混"
                              : "Mix"}
                          </span>
                        </div>
                      </div>
                      <div
                        style={{
                          fontSize: "9px",
                          color: "#6a6080",
                          lineHeight: "1.4",
                        }}
                      >
                        {g.desc}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </section>

            {/* Transit Planet Table */}
            <button
              onClick={() => setShowTbl(!showTbl)}
              style={{
                width: "100%",
                padding: "10px",
                background: "#0e0c14",
                border: "1px solid #1a1520",
                borderRadius: showTbl ? "8px 8px 0 0" : "8px",
                color: "#7a7090",
                fontSize: "11px",
                cursor: "pointer",
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
              }}
            >
              <span>
                {t.planets} — Transit {trDate}
              </span>
              <span
                style={{
                  transform: showTbl ? "rotate(180deg)" : "none",
                  transition: "0.2s",
                }}
              >
                ▾
              </span>
            </button>
            {showTbl && (
              <section
                style={{
                  background: "#0a0810",
                  border: "1px solid #1a1520",
                  borderTop: "none",
                  borderRadius: "0 0 8px 8px",
                  padding: "10px",
                }}
              >
                <PTb pl={trPl} kMap={trKMap} fn={cFN(trAsc)} />
              </section>
            )}
          </>
        ) : mainTab === "muhurta" ? (
          <>
            {/* Date/Time selector */}
            <div
              style={{
                background: "#0e0c14",
                border: "1px solid #1a1520",
                borderRadius: 8,
                padding: "12px",
                marginBottom: 14,
              }}
            >
              <div style={{ display: "flex", gap: 8, marginBottom: 8 }}>
                <div style={{ flex: 1 }}>
                  <label
                    style={{
                      display: "block",
                      fontSize: "8px",
                      color: "#4a4058",
                      marginBottom: 3,
                    }}
                  >
                    {lang === "jp" ? "日付" : "Date"}
                  </label>
                  <input
                    type="date"
                    value={muDate}
                    onChange={(e) => setMuDate(e.target.value)}
                    style={{
                      ...IS,
                      textAlign: "left",
                      WebkitAppearance: "none",
                      appearance: "none",
                      paddingRight: "4px",
                    }}
                  />
                </div>
                <div style={{ flex: 1 }}>
                  <label
                    style={{
                      display: "block",
                      fontSize: "8px",
                      color: "#4a4058",
                      marginBottom: 3,
                    }}
                  >
                    {lang === "jp" ? "時刻" : "Time"}
                  </label>
                  <input
                    type="time"
                    step="1"
                    value={muTime}
                    onChange={(e) => setMuTime(e.target.value)}
                    style={{
                      ...IS,
                      WebkitAppearance: "none",
                      appearance: "none",
                      paddingRight: "4px",
                    }}
                  />
                </div>
              </div>
              <button
                onClick={() => {
                  const n = new Date();
                  setMuDate(localDS(n));
                  setMuTime(localTS(n));
                }}
                style={{
                  width: "100%",
                  padding: "8px",
                  border: "1px solid #e8b04a40",
                  borderRadius: 4,
                  cursor: "pointer",
                  background: "linear-gradient(135deg,#2a1f10,#1a1510)",
                  color: "#e8b04a",
                  fontSize: "11px",
                  fontWeight: 600,
                }}
              >
                {lang === "jp" ? "⟳ 現在の日時" : "⟳ Now"}
              </button>
            </div>

            <LocPicker loc={muLoc} setLoc={setMuLoc} lang={lang} />

            {/* Quality Score + Chart - 2 column on wide screens */}
            <div
              style={{
                display: wide ? "flex" : "block",
                gap: wide ? 14 : 0,
                alignItems: wide ? "stretch" : undefined,
              }}
            >
              <div
                style={{
                  flex: wide ? "1 1 0" : undefined,
                  minWidth: wide ? 0 : undefined,
                }}
              >
                {/* Quality Score + Panchanga */}
                <div
                  style={{
                    background: "#0a0810",
                    border: "1px solid #1a1520",
                    borderRadius: 8,
                    padding: "16px",
                    marginBottom: wide ? 0 : 14,
                    height: wide ? "100%" : undefined,
                    boxSizing: "border-box",
                  }}
                >
                  <div style={{ textAlign: "center", marginBottom: 12 }}>
                    <div
                      style={{
                        fontSize: "9px",
                        color: "#4a4058",
                        marginBottom: 6,
                      }}
                    >
                      {lang === "jp"
                        ? "ムフールタ品質スコア"
                        : "Muhurta Quality Score"}
                    </div>
                    <div
                      style={{
                        position: "relative",
                        width: 100,
                        height: 100,
                        margin: "0 auto 8px",
                      }}
                    >
                      <svg width="100" height="100" viewBox="0 0 100 100">
                        <circle
                          cx="50"
                          cy="50"
                          r="42"
                          fill="none"
                          stroke="#1a1520"
                          strokeWidth="8"
                        />
                        <circle
                          cx="50"
                          cy="50"
                          r="42"
                          fill="none"
                          stroke={
                            panchanga.score >= 70
                              ? "#5cb85c"
                              : panchanga.score >= 45
                              ? "#e8b04a"
                              : "#e05555"
                          }
                          strokeWidth="8"
                          strokeDasharray={`${panchanga.score * 2.64} 264`}
                          strokeDashoffset="66"
                          strokeLinecap="round"
                          transform="rotate(-90 50 50)"
                        />
                      </svg>
                      <div
                        style={{
                          position: "absolute",
                          top: "50%",
                          left: "50%",
                          transform: "translate(-50%,-50%)",
                          textAlign: "center",
                        }}
                      >
                        <div
                          style={{
                            fontSize: "24px",
                            fontWeight: 700,
                            color:
                              panchanga.score >= 70
                                ? "#5cb85c"
                                : panchanga.score >= 45
                                ? "#e8b04a"
                                : "#e05555",
                            fontFamily: "'JetBrains Mono',monospace",
                          }}
                        >
                          {panchanga.score}
                        </div>
                      </div>
                    </div>
                    <div
                      style={{
                        fontSize: "14px",
                        fontWeight: 700,
                        color:
                          panchanga.score >= 70
                            ? "#5cb85c"
                            : panchanga.score >= 45
                            ? "#e8b04a"
                            : "#e05555",
                      }}
                    >
                      {panchanga.quality}
                    </div>
                  </div>

                  {/* Panchanga inline */}
                  <div
                    style={{ borderTop: "1px solid #1a1520", paddingTop: 10 }}
                  >
                    {[
                      {
                        label:
                          lang === "jp" ? "ヴァーラ（曜日）" : "Vara (Weekday)",
                        value: panchanga.vara.name,
                        sub: `${lang === "jp" ? "支配星" : "Lord"}: ${
                          panchanga.vara.lord
                        }`,
                        color: pCol(panchanga.vara.lord),
                      },
                      {
                        label: lang === "jp" ? "ティティ" : "Tithi",
                        value: `${panchanga.tithi.num}. ${panchanga.tithi.name}`,
                        sub: panchanga.tithi.paksha,
                        color: [2, 3, 5, 7, 10, 11, 13].includes(
                          panchanga.tithi.num
                        )
                          ? "#5cb85c"
                          : "#e8b04a",
                      },
                      {
                        label: lang === "jp" ? "ナクシャトラ" : "Nakshatra",
                        value: `${panchanga.nakshatra.name}`,
                        sub: `${lang === "jp" ? "支配星" : "Lord"}: ${
                          panchanga.nakshatra.lord
                        }`,
                        color: pCol(panchanga.nakshatra.lord),
                      },
                      {
                        label: lang === "jp" ? "ヨーガ" : "Yoga",
                        value: panchanga.yoga.name,
                        sub: panchanga.yoga.good
                          ? lang === "jp"
                            ? "吉"
                            : "Auspicious"
                          : lang === "jp"
                          ? "凶"
                          : "Inauspicious",
                        color: panchanga.yoga.good ? "#5cb85c" : "#e05555",
                      },
                      {
                        label: lang === "jp" ? "カラナ" : "Karana",
                        value: panchanga.karana.name,
                        sub: panchanga.karana.bad
                          ? lang === "jp"
                            ? "ヴィシュティ（凶）"
                            : "Vishti (Inauspicious)"
                          : "",
                        color: panchanga.karana.bad ? "#e05555" : "#c8c0d0",
                      },
                    ].map((item, i) => (
                      <div
                        key={i}
                        style={{
                          display: "flex",
                          justifyContent: "space-between",
                          alignItems: "center",
                          padding: "6px 4px",
                          borderTop: i > 0 ? "1px solid #1a1520" : "none",
                        }}
                      >
                        <span
                          style={{
                            fontSize: "9px",
                            color: "#5a5068",
                            minWidth: 70,
                          }}
                        >
                          {item.label}
                        </span>
                        <div style={{ textAlign: "right" }}>
                          <div
                            style={{
                              color: item.color,
                              fontWeight: 700,
                              fontSize: "10px",
                            }}
                          >
                            {item.value}
                          </div>
                          {item.sub && (
                            <div style={{ fontSize: "7px", color: "#4a4058" }}>
                              {item.sub}
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <div
                style={{
                  flex: wide ? "1 1 0" : undefined,
                  minWidth: wide ? 0 : undefined,
                }}
              >
                {/* Muhurta Chart + stepper */}
                <section
                  style={{
                    background: "#0a0810",
                    border: "1px solid #1a1520",
                    borderRadius: 8,
                    padding: "16px 8px",
                    marginBottom: 0,
                    height: wide ? "auto" : undefined,
                    boxSizing: "border-box",
                  }}
                >
                  <div style={{ display: "flex", justifyContent: "center" }}>
                    <CC
                      pl={muPl}
                      ascSign={muAsc}
                      kMap={muKMap}
                      label={`Muhurta — ${muDate} ${muTime.slice(0, 5)}`}
                    />
                  </div>
                </section>

                {/* Time stepper - directly below chart */}
                <div
                  style={{
                    background: "#0e0c14",
                    border: "1px solid #1a1520",
                    borderTop: "none",
                    borderRadius: "0 0 8px 8px",
                    padding: "10px 12px",
                    marginBottom: wide ? 0 : 14,
                  }}
                >
                  <TimeStepper
                    date={muDate}
                    time={muTime}
                    setDate={setMuDate}
                    setTime={setMuTime}
                    lang={lang}
                  />
                </div>
              </div>
            </div>
            {wide && <div style={{ height: 14 }} />}

            {/* Inauspicious Times */}
            <section
              style={{
                background: "#0e0c14",
                border: "1px solid #1a1520",
                borderRadius: 8,
                padding: "12px",
                marginBottom: 14,
              }}
            >
              <div
                style={{
                  fontSize: "11px",
                  color: "#7a7090",
                  fontWeight: 600,
                  marginBottom: 10,
                }}
              >
                {lang === "jp"
                  ? "時間帯（要注意 / 吉時）"
                  : "Time Zones (Caution / Auspicious)"}
              </div>
              {[
                {
                  label: lang === "jp" ? "ラーフカーラ" : "Rahu Kalam",
                  time: panchanga.rahu.label,
                  type: "-",
                  desc:
                    lang === "jp"
                      ? "凶時。新規事業・重要決定を避ける。"
                      : "Inauspicious. Avoid new ventures and important decisions.",
                },
                {
                  label: lang === "jp" ? "グリカカーラ" : "Gulika Kalam",
                  time: panchanga.gulika.label,
                  type: "-",
                  desc:
                    lang === "jp"
                      ? "凶時。毒の時間帯。"
                      : "Inauspicious. Poisonous period.",
                },
                {
                  label: lang === "jp" ? "ヤマガンダ" : "Yamaghanda",
                  time: panchanga.yama.label,
                  type: "-",
                  desc:
                    lang === "jp"
                      ? "凶時。死の支配する時間帯。"
                      : "Inauspicious. Period ruled by death.",
                },
                {
                  label:
                    lang === "jp" ? "アビジットムフールタ" : "Abhijit Muhurta",
                  time: panchanga.abhijit.label,
                  type: "+",
                  desc:
                    lang === "jp"
                      ? "大吉時。最も縁起の良い時間帯。全ての行動に適する。"
                      : "Most auspicious time. Suitable for all activities.",
                },
              ].map((item, i) => (
                <div
                  key={i}
                  style={{
                    padding: "8px 4px",
                    borderTop: i > 0 ? "1px solid #1a1520" : "none",
                    borderLeft: `3px solid ${
                      item.type === "+" ? "#5cb85c" : "#e05555"
                    }`,
                  }}
                >
                  <div
                    style={{
                      display: "flex",
                      justifyContent: "space-between",
                      alignItems: "center",
                      marginBottom: 3,
                    }}
                  >
                    <span
                      style={{
                        fontSize: "10px",
                        color: item.type === "+" ? "#5cb85c" : "#e05555",
                        fontWeight: 700,
                      }}
                    >
                      {item.label}
                    </span>
                    <span
                      style={{
                        fontSize: "12px",
                        color: "#e8b04a",
                        fontWeight: 700,
                        fontFamily: "'JetBrains Mono',monospace",
                      }}
                    >
                      {item.time}
                    </span>
                  </div>
                  <div
                    style={{
                      fontSize: "9px",
                      color: "#6a6080",
                      lineHeight: "1.4",
                    }}
                  >
                    {item.desc}
                  </div>
                </div>
              ))}
            </section>

            {/* Chart style toggle */}
            <div
              style={{
                display: "flex",
                gap: 0,
                marginBottom: 14,
                background: "#0e0c14",
                borderRadius: 8,
                padding: 3,
                border: "1px solid #1a1520",
              }}
            >
              {[
                { id: "south", l: t.south },
                { id: "north", l: t.north },
              ].map((s) => (
                <button
                  key={s.id}
                  onClick={() => setCs(s.id)}
                  style={{
                    flex: 1,
                    padding: "8px 4px",
                    border: "none",
                    borderRadius: 6,
                    cursor: "pointer",
                    background: cs === s.id ? "#1a1520" : "transparent",
                    color: cs === s.id ? "#e8b04a" : "#5a5068",
                    fontSize: "12px",
                    fontWeight: 600,
                  }}
                >
                  {s.l}
                </button>
              ))}
            </div>

            {/* Muhurta Planet Table */}
            <button
              onClick={() => setShowTbl(!showTbl)}
              style={{
                width: "100%",
                padding: "10px",
                background: "#0e0c14",
                border: "1px solid #1a1520",
                borderRadius: showTbl ? "8px 8px 0 0" : "8px",
                color: "#7a7090",
                fontSize: "11px",
                cursor: "pointer",
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
              }}
            >
              <span>
                {t.planets} — Muhurta {muDate}
              </span>
              <span
                style={{
                  transform: showTbl ? "rotate(180deg)" : "none",
                  transition: "0.2s",
                }}
              >
                ▾
              </span>
            </button>
            {showTbl && (
              <section
                style={{
                  background: "#0a0810",
                  border: "1px solid #1a1520",
                  borderTop: "none",
                  borderRadius: "0 0 8px 8px",
                  padding: "10px",
                }}
              >
                <PTb pl={muPl} kMap={muKMap} fn={cFN(muAsc)} />
              </section>
            )}
          </>
        ) : (
          <section
            style={{
              background: "#0e0c14",
              border: "1px solid #1a1520",
              borderRadius: 8,
              padding: "60px 20px",
              textAlign: "center",
              marginTop: 16,
            }}
          >
            <div style={{ fontSize: "32px", marginBottom: 12, opacity: 0.3 }}>
              📅
            </div>
            <p
              style={{
                color: "#5a5068",
                fontSize: "14px",
                fontWeight: 600,
                margin: "0 0 6px",
              }}
            >
              {t[mainTab] || mainTab}
            </p>
            <p style={{ color: "#2a2535", fontSize: "10px", marginTop: 8 }}>
              {t.todo}
            </p>
          </section>
        )}
      </main>
    </div>
  );
}
